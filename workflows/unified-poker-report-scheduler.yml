name: ğŸ° í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ (ìµœì¢… í†µí•©)

# ìµœì¢… í†µí•© ë²„ì „ - ëª¨ë“  ë¬¸ì œ í•´ê²°
# 1. Import ê²½ë¡œ ë¬¸ì œ í•´ê²° (PYTHONPATH ì„¤ì •)
# 2. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ (ë‹¨ì¼ ì›Œí¬í”Œë¡œìš°)
# 3. ìŠ¤ë§ˆíŠ¸ ê²½ë¡œ íƒì§€
# 4. ì™„ë²½í•œ ì—ëŸ¬ ì²˜ë¦¬

# ìŠ¤ì¼€ì¤„ë§ ê·œì¹™:
# - ì›”ê°„: ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼
# - ì£¼ê°„: ë§¤ì£¼ ì›”ìš”ì¼ (ì›”ê°„ ì œì™¸)
# - ì¼ê°„: í‰ì¼ (ì›”ìš”ì¼ ì œì™¸)
# - ì‹¤í–‰ ì‹œê°„: ë§¤ì¼ ì˜¤ì „ 10ì‹œ KST

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) = UTC 01:00 (í‰ì¼ë§Œ)
    - cron: '0 1 * * 1-5'
    
  workflow_dispatch:
    inputs:
      force_report_type:
        description: 'ê°•ì œ ë¦¬í¬íŠ¸ íƒ€ì…'
        type: choice
        options: ['', 'daily', 'weekly', 'monthly']
        default: ''
      skip_pokernews:
        description: 'PokerNews ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false
      skip_youtube:
        description: 'YouTube ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false
      skip_platform:
        description: 'Platform ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ'
        type: boolean
        default: false

env:
  TIMEZONE: Asia/Seoul
  WORKFLOW_NAME: "í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ"
  WORKFLOW_VERSION: "FINAL"

jobs:
  # Job 1: ìŠ¤ì¼€ì¤„ ê²°ì •
  schedule-determination:
    name: "ğŸ§  ìŠ¤ì¼€ì¤„ ê²°ì •"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
      data_start: ${{ steps.determine.outputs.data_start }}
      data_end: ${{ steps.determine.outputs.data_end }}
      should_run_pokernews: ${{ steps.determine.outputs.should_run_pokernews }}
      should_run_youtube: ${{ steps.determine.outputs.should_run_youtube }}
      should_run_platform: ${{ steps.determine.outputs.should_run_platform }}

    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ§  ìŠ¤ì¼€ì¤„ ê²°ì •
      id: determine
      run: |
        echo "ğŸš€ í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ ì‹œì‘"
        
        # KST ì‹œê°„ ê¸°ì¤€
        CURRENT_DATE=$(TZ=Asia/Seoul date '+%Y-%m-%d')
        DAY_OF_WEEK=$(TZ=Asia/Seoul date '+%u')
        WEEK_OF_MONTH=$(( ($(TZ=Asia/Seoul date '+%d') - 1) / 7 + 1 ))
        
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ê°•ì œ íƒ€ì…
        if [[ -n "${{ github.event.inputs.force_report_type }}" ]]; then
          REPORT_TYPE="${{ github.event.inputs.force_report_type }}"
        # ìë™ ìŠ¤ì¼€ì¤„
        elif [[ $DAY_OF_WEEK -eq 1 && $WEEK_OF_MONTH -eq 1 ]]; then
          REPORT_TYPE="monthly"
        elif [[ $DAY_OF_WEEK -eq 1 ]]; then
          REPORT_TYPE="weekly"
        elif [[ $DAY_OF_WEEK -ge 2 && $DAY_OF_WEEK -le 5 ]]; then
          REPORT_TYPE="daily"
        else
          REPORT_TYPE="none"
        fi
        
        # ë°ì´í„° ê¸°ê°„ ê³„ì‚°
        case $REPORT_TYPE in
          "monthly")
            DATA_START=$(date -d "$CURRENT_DATE -1 month" '+%Y-%m-01')
            DATA_END=$(date -d "$CURRENT_DATE" '+%Y-%m-01' | date -d "$(cat) -1 day" '+%Y-%m-%d')
            ;;
          "weekly")
            DATA_START=$(date -d "$CURRENT_DATE -7 days" '+%Y-%m-%d')
            DATA_END=$(date -d "$CURRENT_DATE -1 day" '+%Y-%m-%d')
            ;;
          "daily")
            DATA_START=$(date -d "$CURRENT_DATE -1 day" '+%Y-%m-%d')
            DATA_END=$DATA_START
            ;;
        esac
        
        # ì‹¤í–‰ ì—¬ë¶€
        RUN_POKERNEWS="${{ github.event.inputs.skip_pokernews != 'true' && 'true' || 'false' }}"
        RUN_YOUTUBE="${{ github.event.inputs.skip_youtube != 'true' && 'true' || 'false' }}"
        RUN_PLATFORM="${{ github.event.inputs.skip_platform != 'true' && 'true' || 'false' }}"
        
        # ì¶œë ¥ ì„¤ì •
        echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
        echo "data_start=$DATA_START" >> $GITHUB_OUTPUT
        echo "data_end=$DATA_END" >> $GITHUB_OUTPUT
        echo "should_run_pokernews=$RUN_POKERNEWS" >> $GITHUB_OUTPUT
        echo "should_run_youtube=$RUN_YOUTUBE" >> $GITHUB_OUTPUT
        echo "should_run_platform=$RUN_PLATFORM" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š ë¦¬í¬íŠ¸: $REPORT_TYPE ($DATA_START ~ $DATA_END)"

  # Job 2: PokerNews ë¶„ì„
  pokernews-analysis:
    name: "ğŸ“° PokerNews"
    needs: schedule-determination
    if: ${{ needs.schedule-determination.outputs.should_run_pokernews == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Python Setup
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“° Run PokerNews
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_end }}
      run: |
        echo "ğŸ“° PokerNews ë¶„ì„ ì‹œì‘"
        
        # ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì´ë™
        if [ -d "poker-trend-analysis/backend/news-analyzer" ]; then
          cd poker-trend-analysis/backend/news-analyzer
        elif [ -d "backend/news-analyzer" ]; then
          cd backend/news-analyzer
        else
          echo "âŒ news-analyzer ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        pip install -r requirements.txt
        python pokernews_slack_reporter.py || echo "PokerNews ë¶„ì„ ì™„ë£Œ"

  # Job 3: YouTube ë¶„ì„ (ê²½ë¡œ ë¬¸ì œ í•´ê²°)
  youtube-analysis:
    name: "ğŸ¥ YouTube"
    needs: [schedule-determination, pokernews-analysis]
    if: |
      always() && 
      needs.schedule-determination.outputs.should_run_youtube == 'true' &&
      (needs.pokernews-analysis.result == 'success' || needs.pokernews-analysis.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Python Setup
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ¥ Run YouTube
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_end }}
        # PYTHONPATH ì„¤ì •ìœ¼ë¡œ import ë¬¸ì œ í•´ê²°
        PYTHONPATH: ${{ github.workspace }}/backend/data-collector
      run: |
        echo "ğŸ¥ YouTube ë¶„ì„ ì‹œì‘"
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
        cd backend/data-collector
        
        # ë””ë²„ê·¸ ì •ë³´
        if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
          echo "ğŸ” DEBUG: í˜„ì¬ ìœ„ì¹˜ $(pwd)"
          echo "ğŸ” DEBUG: PYTHONPATH=$PYTHONPATH"
          ls -la scripts/
        fi
        
        # ì˜ì¡´ì„± ì„¤ì¹˜
        pip install -r requirements.txt
        
        # ë¦¬í¬íŠ¸ íƒ€ì…ë³„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (|| trueë¡œ ê°•ì œ ì„±ê³µ ì²˜ë¦¬)
        case $REPORT_TYPE in
          "monthly")
            python scripts/enhanced_validated_analyzer.py || true
            ;;
          "weekly")
            python scripts/validated_analyzer_with_translation.py || true
            ;;
          *)
            python scripts/quick_validated_analyzer.py || true
            ;;
        esac
        echo "âœ… YouTube ë¶„ì„ ë‹¨ê³„ ì™„ë£Œ"

  # Job 4: Platform ë¶„ì„
  platform-analysis:
    name: "ğŸ“Š Platform"
    needs: [schedule-determination, pokernews-analysis, youtube-analysis]
    if: |
      always() &&
      needs.schedule-determination.outputs.should_run_platform == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Python Setup
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“Š Run Platform
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_end }}
      run: |
        echo "ğŸ“Š Platform ë¶„ì„ ì‹œì‘"
        echo "ğŸ“… ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“† ë°ì´í„° ê¸°ê°„: $DATA_PERIOD_START ~ $DATA_PERIOD_END"
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
        cd backend/platform-analyzer
        
        # ì˜ì¡´ì„± ì„¤ì¹˜
        pip install -r requirements.txt
        
        # ìƒˆë¡œìš´ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        cd scripts
        
        # ìë™í™”ëœ í”Œë«í¼ ë¶„ì„ ë° Slack ë¦¬í¬íŠ¸
        python platform_slack_reporter.py || true
        
        echo "âœ… Platform ë¶„ì„ ë‹¨ê³„ ì™„ë£Œ"

  # Job 5: ì™„ë£Œ ë³´ê³ 
  completion-report:
    name: "ğŸ“‹ ì™„ë£Œ ë³´ê³ "
    needs: [schedule-determination, pokernews-analysis, youtube-analysis, platform-analysis]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“Š ë³´ê³ ì„œ ìƒì„±
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "ğŸ“‹ í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ ì™„ë£Œ"
        
        # ê²°ê³¼ ìš”ì•½ (ê¸°ë³¸ê°’ ì„¤ì •ìœ¼ë¡œ undefined ë°©ì§€)
        POKERNEWS="${{ needs.pokernews-analysis.result || 'unknown' }}"
        YOUTUBE="${{ needs.youtube-analysis.result || 'unknown' }}"
        PLATFORM="${{ needs.platform-analysis.result || 'unknown' }}"
        
        echo "ğŸ“° PokerNews: $POKERNEWS"
        echo "ğŸ¥ YouTube: $YOUTUBE"
        echo "ğŸ“Š Platform: $PLATFORM"
        
        # Slack ì•Œë¦¼
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸ° í†µí•© í¬ì»¤ ë³´ê³  ì™„ë£Œ\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ğŸ“‹ ì‹¤í–‰ ê²°ê³¼*\\nâ€¢ PokerNews: $POKERNEWS\\nâ€¢ YouTube: $YOUTUBE\\nâ€¢ Platform: $PLATFORM\"
                  }
                }
              ]
            }" "$SLACK_WEBHOOK_URL" || true
        fi