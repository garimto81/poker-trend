name: ğŸ” Workflow Health Check

on:
  workflow_dispatch:
    inputs:
      check_slack_webhook:
        description: 'Test Slack webhook connectivity'
        type: boolean
        default: true
      check_api_keys:
        description: 'Verify API keys (without exposing them)'
        type: boolean
        default: true
      test_dependencies:
        description: 'Test Python dependencies installation'
        type: boolean
        default: true

jobs:
  health-check:
    name: "ğŸ” System Health Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“‹ Environment Check
      run: |
        echo "ğŸ” Environment Information:"
        echo "  Python version: $(python --version)"
        echo "  Pip version: $(pip --version)"
        echo "  Working directory: $(pwd)"
        echo "  Current time (UTC): $(date -u)"
        echo "  Current time (KST): $(TZ=Asia/Seoul date)"
        echo ""
        
        echo "ğŸ“ Project structure check:"
        ls -la
        echo ""
        echo "ğŸ“ Backend structure:"
        if [ -d "backend" ]; then
          find backend -name "*.py" -type f | head -10
        else
          echo "  âš ï¸ Backend directory not found"
        fi
        echo ""
        echo "ğŸ“ Poker-trend-analysis structure:"
        if [ -d "poker-trend-analysis" ]; then
          find poker-trend-analysis -name "*.py" -type f | head -10
        else
          echo "  âš ï¸ poker-trend-analysis directory not found"
        fi
    
    - name: ğŸ§ª Dependencies Test (PokerNews)
      if: ${{ inputs.test_dependencies }}
      working-directory: poker-trend-analysis/backend/news-analyzer
      run: |
        echo "ğŸ“¦ Testing PokerNews dependencies..."
        if [ -f "requirements.txt" ]; then
          echo "Installing requirements..."
          pip install -r requirements.txt
          echo "âœ… PokerNews dependencies installed successfully"
        else
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
        echo "ğŸ Testing Python imports..."
        python -c "
        try:
            import requests
            import google.generativeai as genai
            from dotenv import load_dotenv
            print('âœ… All critical imports successful')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: ğŸ§ª Dependencies Test (YouTube)
      if: ${{ inputs.test_dependencies }}
      working-directory: backend/data-collector
      run: |
        echo "ğŸ“¦ Testing YouTube analysis dependencies..."
        if [ -f "requirements.txt" ]; then
          echo "Installing requirements..."
          pip install -r requirements.txt
          echo "âœ… YouTube dependencies installed successfully"
        else
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
        echo "ğŸ Testing Python imports..."
        python -c "
        try:
            import google.generativeai as genai
            from googleapiclient.discovery import build
            import requests
            print('âœ… All critical imports successful')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: ğŸ§ª Dependencies Test (Platform)
      if: ${{ inputs.test_dependencies }}
      working-directory: backend/platform-analyzer
      run: |
        echo "ğŸ“¦ Testing Platform analysis dependencies..."
        if [ -f "requirements.txt" ]; then
          echo "Installing requirements..."
          pip install -r requirements.txt
          echo "âœ… Platform dependencies installed successfully"
        else
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        
        echo "ğŸ Testing Python imports..."
        python -c "
        try:
            import requests
            import sqlite3
            import json
            import logging
            print('âœ… All critical imports successful')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: ğŸ”‘ API Keys Validation
      if: ${{ inputs.check_api_keys }}
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "ğŸ”‘ Checking API keys availability (without exposing values)..."
        
        # YouTube API Key
        if [ -n "$YOUTUBE_API_KEY" ]; then
          echo "âœ… YOUTUBE_API_KEY is configured (length: ${#YOUTUBE_API_KEY})"
        else
          echo "âŒ YOUTUBE_API_KEY is missing"
        fi
        
        # Gemini API Key  
        if [ -n "$GEMINI_API_KEY" ]; then
          echo "âœ… GEMINI_API_KEY is configured (length: ${#GEMINI_API_KEY})"
        else
          echo "âŒ GEMINI_API_KEY is missing"
        fi
        
        # Slack Webhook URL
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          echo "âœ… SLACK_WEBHOOK_URL is configured (length: ${#SLACK_WEBHOOK_URL})"
        else
          echo "âŒ SLACK_WEBHOOK_URL is missing"
        fi
    
    - name: ğŸ“¡ Slack Webhook Test
      if: ${{ inputs.check_slack_webhook }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "ğŸ“¡ Testing Slack webhook connectivity..."
        
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "âŒ SLACK_WEBHOOK_URL not configured"
          exit 1
        fi
        
        # í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒì„±
        cat << 'EOF' > test_message.json
        {
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "ğŸ§ª *Workflow Health Check Test*\n\nThis is a connectivity test from GitHub Actions.\n\nâ° Time: $(date -u +%Y-%m-%d %H:%M:%S UTC)\nğŸ¤– From: Daily Poker Report Workflow"
              }
            }
          ]
        }
        EOF
        
        # í˜„ì¬ ì‹œê°„ ì‚½ì…
        sed -i "s/\$(date -u +%Y-%m-%d %H:%M:%S UTC)/$(date -u +'%Y-%m-%d %H:%M:%S UTC')/" test_message.json
        
        # Slack ì „ì†¡ í…ŒìŠ¤íŠ¸
        HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" \
          -X POST \
          -H 'Content-type: application/json' \
          --data @test_message.json \
          "$SLACK_WEBHOOK_URL")
        
        echo "HTTP Response Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Slack webhook test successful"
        else
          echo "âŒ Slack webhook test failed"
          echo "Response:"
          cat response.txt
          exit 1
        fi
    
    - name: ğŸ“Š Health Check Summary
      if: always()
      run: |
        echo "=============================================="
        echo "ğŸ” Workflow Health Check Summary"
        echo "=============================================="
        echo "â° Check completed at: $(TZ=Asia/Seoul date)"
        echo ""
        echo "âœ… Environment setup: OK"
        echo "âœ… Dependencies: $(if [ '${{ inputs.test_dependencies }}' = 'true' ]; then echo 'TESTED'; else echo 'SKIPPED'; fi)"
        echo "âœ… API Keys: $(if [ '${{ inputs.check_api_keys }}' = 'true' ]; then echo 'VERIFIED'; else echo 'SKIPPED'; fi)"
        echo "âœ… Slack webhook: $(if [ '${{ inputs.check_slack_webhook }}' = 'true' ]; then echo 'TESTED'; else echo 'SKIPPED'; fi)"
        echo ""
        echo "ğŸ¯ System is ready for daily poker reports!"
        echo "=============================================="