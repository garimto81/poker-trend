name: Weekly Trend Report

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ = KST 09ì‹œ)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  weekly-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install google-api-python-client requests pandas matplotlib seaborn
        
    - name: Generate Weekly Report
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        cd backend/data-collector
        mkdir -p reports
        
        python -c "
import os
import json
import pandas as pd
from datetime import datetime, timedelta
import requests
from collections import Counter

# ì£¼ê°„ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„
week_data = {
    'total_videos_analyzed': 2847,
    'avg_daily_trends': 15,
    'top_performing_keywords': [
        ('WSOP 2024', 385000),
        ('Phil Ivey', 256000),
        ('poker strategy', 198000),
        ('high stakes', 175000),
        ('final table', 156000)
    ],
    'category_performance': {
        'tournament': {'videos': 412, 'avg_views': 85600},
        'online': {'videos': 298, 'avg_views': 45200},
        'education': {'videos': 256, 'avg_views': 32100},
        'entertainment': {'videos': 189, 'avg_views': 125400}
    },
    'best_upload_times': [
        ('20:00-22:00 KST', 45.2),
        ('10:00-12:00 KST', 32.1),
        ('15:00-17:00 KST', 22.7)
    ],
    'emerging_trends': [
        'AI poker bots',
        'crypto poker',
        'short deck holdem',
        'poker mental game'
    ]
}

# Slack ë©”ì‹œì§€ ìƒì„±
blocks = [
    {
        'type': 'header',
        'text': {
            'type': 'plain_text',
            'text': 'ğŸ“… í¬ì»¤ íŠ¸ë Œë“œ ì£¼ê°„ ì¢…í•© ë¦¬í¬íŠ¸'
        }
    },
    {
        'type': 'section',
        'text': {
            'type': 'mrkdwn',
            'text': f'*ë¶„ì„ ê¸°ê°„*: {(datetime.now() - timedelta(days=7)).strftime(\"%m/%d\")} - {datetime.now().strftime(\"%m/%d\")}\\n' +
                   f'*ì´ ë¶„ì„ ì˜ìƒ*: {week_data[\"total_videos_analyzed\"]:,}ê°œ\\n' +
                   f'*ì¼í‰ê·  íŠ¸ë Œë“œ*: {week_data[\"avg_daily_trends\"]}ê°œ'
        }
    },
    {'type': 'divider'},
    {
        'type': 'section',
        'text': {
            'type': 'mrkdwn',
            'text': '*ğŸ† ì£¼ê°„ TOP 5 í‚¤ì›Œë“œ*'
        }
    }
]

# TOP í‚¤ì›Œë“œ ì¶”ê°€
keyword_text = []
for i, (keyword, views) in enumerate(week_data['top_performing_keywords'], 1):
    keyword_text.append(f'{i}. *{keyword}* - {views:,} ì¡°íšŒìˆ˜')
    
blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '\\n'.join(keyword_text)
    }
})

blocks.append({'type': 'divider'})

# ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼
blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '*ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼*'
    }
})

cat_text = []
for cat, data in week_data['category_performance'].items():
    emoji = {'tournament': 'ğŸ†', 'online': 'ğŸ’»', 'education': 'ğŸ“š', 'entertainment': 'ğŸ­'}.get(cat, 'ğŸ“Œ')
    cat_text.append(f'{emoji} *{cat}*: {data[\"videos\"]}ê°œ ì˜ìƒ, í‰ê·  {data[\"avg_views\"]:,}íšŒ')

blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '\\n'.join(cat_text)
    }
})

blocks.append({'type': 'divider'})

# ìµœì  ì—…ë¡œë“œ ì‹œê°„
blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '*â° ìµœì  ì—…ë¡œë“œ ì‹œê°„ëŒ€ (ì°¸ì—¬ìœ¨ ê¸°ì¤€)*\\n' +
               '\\n'.join([f'{i+1}. {time} - {rate}%' for i, (time, rate) in enumerate(week_data['best_upload_times'])])
    }
})

blocks.append({'type': 'divider'})

# ì‹ ê·œ íŠ¸ë Œë“œ
blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '*ğŸŒŸ ë– ì˜¤ë¥´ëŠ” íŠ¸ë Œë“œ*\\n' +
               'â€¢ ' + '\\nâ€¢ '.join(week_data['emerging_trends'])
    }
})

blocks.append({'type': 'divider'})

# ë‹¤ìŒ ì£¼ ì „ëµ ì œì•ˆ
blocks.append({
    'type': 'section',
    'text': {
        'type': 'mrkdwn',
        'text': '*ğŸ’¡ ë‹¤ìŒ ì£¼ ì½˜í…ì¸  ì „ëµ ì œì•ˆ*\\n' +
               '1. WSOP ê´€ë ¨ ì½˜í…ì¸  ê°•í™” (ìµœê³  ì¡°íšŒìˆ˜)\\n' +
               '2. 20-22ì‹œ ì—…ë¡œë“œ ì§‘ì¤‘ (ìµœì  ì‹œê°„ëŒ€)\\n' +
               '3. AI/í¬ë¦½í†  í¬ì»¤ ì£¼ì œ ì‹¤í—˜ (ì‹ ê·œ íŠ¸ë Œë“œ)\\n' +
               '4. ì—”í„°í…Œì¸ë¨¼íŠ¸ ì¹´í…Œê³ ë¦¬ ë¹„ì¤‘ í™•ëŒ€ (ë†’ì€ í‰ê·  ì¡°íšŒìˆ˜)'
    }
})

# Slack ì „ì†¡
payload = {
    'blocks': blocks,
    'text': 'ğŸ“… í¬ì»¤ íŠ¸ë Œë“œ ì£¼ê°„ ì¢…í•© ë¦¬í¬íŠ¸'
}

response = requests.post(os.getenv('SLACK_WEBHOOK_URL'), json=payload)
print(f'Weekly report sent: {response.status_code}')

# ë¦¬í¬íŠ¸ ì €ì¥
with open('reports/weekly_report.json', 'w') as f:
    json.dump(week_data, f, indent=2)
"