name: Integrated Poker Trend Reporting

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 10ì‹œ ì‹¤í–‰ (UTC 1:00 = KST 10:00)
    - cron: '0 1 * * 1-5'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - daily
          - weekly
          - monthly

env:
  TZ: Asia/Seoul

jobs:
  determine-report-type:
    runs-on: ubuntu-latest
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
      date_range: ${{ steps.determine.outputs.date_range }}
    
    steps:
    - name: Determine Report Type and Date Range
      id: determine
      run: |
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì§€ì •ëœ íƒ€ì… ì‚¬ìš©
        if [ "${{ github.event.inputs.report_type }}" != "auto" ] && [ -n "${{ github.event.inputs.report_type }}" ]; then
          REPORT_TYPE="${{ github.event.inputs.report_type }}"
        else
          # ìë™ ì‹¤í–‰ ì‹œ ë‚ ì§œ ê¸°ë°˜ íŒë‹¨
          DAY_OF_MONTH=$(date +%d)
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
          
          # ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼ (1-7ì¼ ì¤‘ ì›”ìš”ì¼)
          if [ $DAY_OF_WEEK -eq 1 ] && [ $DAY_OF_MONTH -le 7 ]; then
            REPORT_TYPE="monthly"
          # ë‚˜ë¨¸ì§€ ì›”ìš”ì¼
          elif [ $DAY_OF_WEEK -eq 1 ]; then
            REPORT_TYPE="weekly"
          # í™”-ê¸ˆìš”ì¼
          else
            REPORT_TYPE="daily"
          fi
        fi
        
        echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
        
        # ë‚ ì§œ ë²”ìœ„ ì„¤ì •
        case $REPORT_TYPE in
          "monthly")
            echo "date_range=30" >> $GITHUB_OUTPUT
            ;;
          "weekly")
            echo "date_range=7" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "date_range=1" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "Report Type: $REPORT_TYPE"
        echo "Current Date: $(date)"

  generate-report:
    needs: determine-report-type
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/data-collector/requirements.txt
        
    - name: Generate Report
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.determine-report-type.outputs.report_type }}
        DATE_RANGE: ${{ needs.determine-report-type.outputs.date_range }}
      run: |
        cd backend/data-collector
        
        echo "=================================================="
        echo "ğŸ“Š í¬ì»¤ íŠ¸ë Œë“œ ë¦¬í¬íŠ¸ ìƒì„±"
        echo "=================================================="
        echo "ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ë¶„ì„ ê¸°ê°„: $DATE_RANGEì¼"
        echo "ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "=================================================="
        
        # ë¦¬í¬íŠ¸ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        python scripts/integrated_trend_analyzer.py \
          --report-type $REPORT_TYPE \
          --date-range $DATE_RANGE
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: report-${{ needs.determine-report-type.outputs.report_type }}-${{ github.run_number }}
        path: |
          backend/data-collector/reports/
          backend/data-collector/data/
        retention-days: 90
        
    - name: Notify on failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type }}"
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"âš ï¸ í¬ì»¤ íŠ¸ë Œë“œ ${REPORT_TYPE} ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*âš ï¸ í¬ì»¤ íŠ¸ë Œë“œ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨*\\n\\nâ€¢ ë¦¬í¬íŠ¸ íƒ€ì…: ${REPORT_TYPE}\\nâ€¢ ì‹¤í–‰ ì‹œê°„: $(date)\\nâ€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}\\nâ€¢ ì‹¤í–‰ ë²ˆí˜¸: #${{ github.run_number }}\\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ìƒì„¸ ë¡œê·¸ í™•ì¸>\"
                }
              }
            ]
          }"