name: Integrated Poker Trend Reporting

on:
  schedule:
    # 평일 오전 10시 실행 (UTC 1:00 = KST 10:00)
    - cron: '0 1 * * 1-5'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - daily
          - weekly
          - monthly

env:
  TZ: Asia/Seoul

jobs:
  determine-report-type:
    runs-on: ubuntu-latest
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
      date_range: ${{ steps.determine.outputs.date_range }}
    
    steps:
    - name: Determine Report Type and Date Range
      id: determine
      run: |
        # 수동 실행 시 지정된 타입 사용
        if [ "${{ github.event.inputs.report_type }}" != "auto" ] && [ -n "${{ github.event.inputs.report_type }}" ]; then
          REPORT_TYPE="${{ github.event.inputs.report_type }}"
        else
          # 자동 실행 시 날짜 기반 판단
          DAY_OF_MONTH=$(date +%d)
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
          
          # 매월 첫째주 월요일 (1-7일 중 월요일)
          if [ $DAY_OF_WEEK -eq 1 ] && [ $DAY_OF_MONTH -le 7 ]; then
            REPORT_TYPE="monthly"
          # 나머지 월요일
          elif [ $DAY_OF_WEEK -eq 1 ]; then
            REPORT_TYPE="weekly"
          # 화-금요일
          else
            REPORT_TYPE="daily"
          fi
        fi
        
        echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
        
        # 날짜 범위 설정
        case $REPORT_TYPE in
          "monthly")
            echo "date_range=30" >> $GITHUB_OUTPUT
            ;;
          "weekly")
            echo "date_range=7" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "date_range=1" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "Report Type: $REPORT_TYPE"
        echo "Current Date: $(date)"

  generate-report:
    needs: determine-report-type
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/data-collector/requirements.txt
        
    - name: Generate Report
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.determine-report-type.outputs.report_type }}
        DATE_RANGE: ${{ needs.determine-report-type.outputs.date_range }}
      run: |
        cd backend/data-collector
        
        echo "=================================================="
        echo "📊 포커 트렌드 리포트 생성"
        echo "=================================================="
        echo "리포트 타입: $REPORT_TYPE"
        echo "분석 기간: $DATE_RANGE일"
        echo "실행 시간: $(date)"
        echo "=================================================="
        
        # 리포트 타입에 따라 적절한 스크립트 실행
        python scripts/integrated_trend_analyzer.py \
          --report-type $REPORT_TYPE \
          --date-range $DATE_RANGE
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: report-${{ needs.determine-report-type.outputs.report_type }}-${{ github.run_number }}
        path: |
          backend/data-collector/reports/
          backend/data-collector/data/
        retention-days: 90
        
    - name: Notify on failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type }}"
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"⚠️ 포커 트렌드 ${REPORT_TYPE} 리포트 생성 실패\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*⚠️ 포커 트렌드 리포트 생성 실패*\\n\\n• 리포트 타입: ${REPORT_TYPE}\\n• 실행 시간: $(date)\\n• 워크플로우: ${{ github.workflow }}\\n• 실행 번호: #${{ github.run_number }}\\n• <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|상세 로그 확인>\"
                }
              }
            ]
          }"