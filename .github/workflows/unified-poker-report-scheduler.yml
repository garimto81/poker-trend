name: ğŸ° í†µí•© í¬ì»¤ ë³´ê³  ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ

# í†µì¼ëœ ìŠ¤ì¼€ì¤„ë§ ê·œì¹™:
# 1. ì›”ê°„ ë³´ê³ ì„œ: ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼ - ì§€ë‚œë‹¬ ë°ì´í„° ë¶„ì„
# 2. ì£¼ê°„ ë³´ê³ ì„œ: ë§¤ì£¼ ì›”ìš”ì¼ - ì§€ë‚œì£¼ ë°ì´í„° ë¶„ì„ (ì›”ê°„ ë³´ê³ ì„œ ìˆìœ¼ë©´ ìƒëµ)  
# 3. ì¼ê°„ ë³´ê³ ì„œ: ë§¤ì¼ (í‰ì¼ë§Œ) - ì „ì¼ ë°ì´í„° ë¶„ì„ (ì£¼ê°„ ë³´ê³ ì„œ ìˆìœ¼ë©´ ìƒëµ)
# 4. ì£¼ë§ ì œì™¸: í† ìš”ì¼, ì¼ìš”ì¼ ë³´ê³  ì—†ìŒ
# 5. ì‹¤í–‰ ì‹œê°„: ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) ìˆœì°¨ ì‹¤í–‰

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) = UTC 01:00 (í‰ì¼ë§Œ ì‹¤í–‰)
    - cron: '0 1 * * 1-5'  # ì›”-ê¸ˆìš”ì¼ë§Œ ì‹¤í–‰
    
  workflow_dispatch:
    inputs:
      force_report_type:
        description: 'ê°•ì œ ë¦¬í¬íŠ¸ íƒ€ì… (ìë™ ê²°ì • ë¬´ì‹œ)'
        required: false
        type: choice
        options:
        - ''
        - daily
        - weekly  
        - monthly
        default: ''
      date_override:
        description: 'ë‚ ì§œ ì˜¤ë²„ë¼ì´ë“œ (YYYY-MM-DD í˜•ì‹, í…ŒìŠ¤íŠ¸ìš©)'
        required: false
        type: string
        default: ''
      skip_pokernews:
        description: 'PokerNews ë¶„ì„ ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false
      skip_youtube:
        description: 'YouTube ë¶„ì„ ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false
      skip_platform:
        description: 'Platform ë¶„ì„ ê±´ë„ˆë›°ê¸°'
        type: boolean
        default: false

# í™˜ê²½ ë³€ìˆ˜
env:
  TIMEZONE: Asia/Seoul
  WORKFLOW_NAME: "í†µí•© í¬ì»¤ ë³´ê³  ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ"

jobs:
  # Job 1: ìŠ¤ì¼€ì¤„ ê²°ì • ë° ê²€ì¦ ë¡œì§
  schedule-determination:
    name: "ğŸ§  ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ ê²°ì •"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      report_type: ${{ steps.determine-schedule.outputs.report_type }}
      data_period_start: ${{ steps.determine-schedule.outputs.data_period_start }}
      data_period_end: ${{ steps.determine-schedule.outputs.data_period_end }}
      should_run_pokernews: ${{ steps.determine-schedule.outputs.should_run_pokernews }}
      should_run_youtube: ${{ steps.determine-schedule.outputs.should_run_youtube }}
      should_run_platform: ${{ steps.determine-schedule.outputs.should_run_platform }}
      schedule_description: ${{ steps.determine-schedule.outputs.schedule_description }}
      execution_priority: ${{ steps.determine-schedule.outputs.execution_priority }}

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ§  ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ ê²°ì • ë¡œì§
      id: determine-schedule
      run: |
        echo "ğŸš€ í†µí•© í¬ì»¤ ë³´ê³  ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ ì‹œì‘"
        
        # í˜„ì¬ ì‹œê°„ ì •ë³´ (KST)
        if [[ -n "${{ github.event.inputs.date_override }}" ]]; then
          # í…ŒìŠ¤íŠ¸ìš© ë‚ ì§œ ì˜¤ë²„ë¼ì´ë“œ
          CURRENT_DATE="${{ github.event.inputs.date_override }}"
          echo "âš ï¸ ë‚ ì§œ ì˜¤ë²„ë¼ì´ë“œ ì‚¬ìš©: $CURRENT_DATE"
          # ì˜¤ë²„ë¼ì´ë“œëœ ë‚ ì§œë¡œ ê³„ì‚°
          DAY_OF_MONTH=$(date -d "$CURRENT_DATE" +%d)
          DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
          WEEK_OF_MONTH=$(( ($(date -d "$CURRENT_DATE" +%d) - 1) / 7 + 1 ))
          KST_TIME=$(date -d "$CURRENT_DATE" "+%Y-%m-%d %H:%M:%S KST")
        else
          # ì‹¤ì œ KST ì‹œê°„ ì‚¬ìš©
          CURRENT_DATE=$(TZ=Asia/Seoul date '+%Y-%m-%d')
          DAY_OF_MONTH=$(TZ=Asia/Seoul date '+%d')
          DAY_OF_WEEK=$(TZ=Asia/Seoul date '+%u')  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
          WEEK_OF_MONTH=$(( ($(TZ=Asia/Seoul date '+%d') - 1) / 7 + 1 ))
          KST_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')
        fi
        
        echo "ğŸ“… í˜„ì¬ ë‚ ì§œ: $CURRENT_DATE"
        echo "ğŸ“Š ìš”ì¼: $DAY_OF_WEEK (1=ì›”, 7=ì¼)"
        echo "ğŸ“ˆ ì›” ì¤‘ ëª‡ì§¸ ì£¼: $WEEK_OF_MONTH"
        echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $KST_TIME"
        
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ê°•ì œ íƒ€ì… í™•ì¸
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.force_report_type }}" ]]; then
          REPORT_TYPE="${{ github.event.inputs.force_report_type }}"
          echo "ğŸ”§ ìˆ˜ë™ ì‹¤í–‰: ê°•ì œ ë¦¬í¬íŠ¸ íƒ€ì… = $REPORT_TYPE"
        else
          # ìë™ ìŠ¤ì¼€ì¤„ ê²°ì • ë¡œì§
          if [[ $DAY_OF_WEEK -eq 1 && $WEEK_OF_MONTH -eq 1 ]]; then
            # ì²«ì§¸ì£¼ ì›”ìš”ì¼ â†’ ì›”ê°„ ë¦¬í¬íŠ¸
            REPORT_TYPE="monthly"
            echo "ğŸ—“ï¸ ì²«ì§¸ì£¼ ì›”ìš”ì¼ ê°ì§€ â†’ ì›”ê°„ ë¦¬í¬íŠ¸"
          elif [[ $DAY_OF_WEEK -eq 1 ]]; then
            # ì¼ë°˜ ì›”ìš”ì¼ â†’ ì£¼ê°„ ë¦¬í¬íŠ¸
            REPORT_TYPE="weekly"
            echo "ğŸ“… ì¼ë°˜ ì›”ìš”ì¼ ê°ì§€ â†’ ì£¼ê°„ ë¦¬í¬íŠ¸"
          elif [[ $DAY_OF_WEEK -ge 2 && $DAY_OF_WEEK -le 5 ]]; then
            # í‰ì¼ (í™”-ê¸ˆ) â†’ ì¼ê°„ ë¦¬í¬íŠ¸
            REPORT_TYPE="daily"
            echo "ğŸ“‹ í‰ì¼ ê°ì§€ â†’ ì¼ê°„ ë¦¬í¬íŠ¸"
          else
            # ì£¼ë§ â†’ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            echo "ğŸš« ì£¼ë§ ê°ì§€ â†’ ì‹¤í–‰ ì¤‘ë‹¨"
            echo "should_run_pokernews=false" >> $GITHUB_OUTPUT
            echo "should_run_youtube=false" >> $GITHUB_OUTPUT
            echo "should_run_platform=false" >> $GITHUB_OUTPUT
            echo "report_type=none" >> $GITHUB_OUTPUT
            echo "schedule_description=ì£¼ë§ - ì‹¤í–‰í•˜ì§€ ì•ŠìŒ" >> $GITHUB_OUTPUT
            echo "execution_priority=0" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # ë°ì´í„° ê¸°ê°„ ê³„ì‚°
        case $REPORT_TYPE in
          "monthly")
            # ì§€ë‚œë‹¬ 1ì¼~ë§ì¼
            DATA_START=$(date -d "$CURRENT_DATE -1 month" '+%Y-%m-01')
            DATA_END=$(date -d "$CURRENT_DATE -1 month" '+%Y-%m-01' | date -d "$(cat) +1 month -1 day" '+%Y-%m-%d')
            SCHEDULE_DESC="ì›”ê°„ ë³´ê³ ì„œ - ì§€ë‚œë‹¬ ($DATA_START ~ $DATA_END) ë°ì´í„° ë¶„ì„"
            PRIORITY=3
            ;;
          "weekly")
            # ì§€ë‚œì£¼ ì›”ìš”ì¼~ì¼ìš”ì¼
            DAYS_SINCE_MONDAY=$(( ($DAY_OF_WEEK - 1) % 7 ))
            LAST_MONDAY=$(date -d "$CURRENT_DATE -$(($DAYS_SINCE_MONDAY + 7)) days" '+%Y-%m-%d')
            LAST_SUNDAY=$(date -d "$LAST_MONDAY +6 days" '+%Y-%m-%d')
            DATA_START=$LAST_MONDAY
            DATA_END=$LAST_SUNDAY
            SCHEDULE_DESC="ì£¼ê°„ ë³´ê³ ì„œ - ì§€ë‚œì£¼ ($DATA_START ~ $DATA_END) ë°ì´í„° ë¶„ì„"
            PRIORITY=2
            ;;
          "daily"|*)
            # ì–´ì œ (ì „ì¼)
            DATA_START=$(date -d "$CURRENT_DATE -1 day" '+%Y-%m-%d')
            DATA_END=$DATA_START
            SCHEDULE_DESC="ì¼ê°„ ë³´ê³ ì„œ - ì–´ì œ ($DATA_START) ë°ì´í„° ë¶„ì„"
            PRIORITY=1
            ;;
        esac
        
        # ì‹¤í–‰ ì—¬ë¶€ ê²°ì • (ì‚¬ìš©ì ì…ë ¥ ê³ ë ¤)
        RUN_POKERNEWS="true"
        RUN_YOUTUBE="true"
        RUN_PLATFORM="true"
        
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì‚¬ìš©ì ì„¤ì • ì ìš©
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ github.event.inputs.skip_pokernews }}" == "true" ]]; then
            RUN_POKERNEWS="false"
          fi
          if [[ "${{ github.event.inputs.skip_youtube }}" == "true" ]]; then
            RUN_YOUTUBE="false"
          fi
          if [[ "${{ github.event.inputs.skip_platform }}" == "true" ]]; then
            RUN_PLATFORM="false"
          fi
        fi
        
        # ì¶œë ¥ ì„¤ì •
        echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
        echo "data_period_start=$DATA_START" >> $GITHUB_OUTPUT
        echo "data_period_end=$DATA_END" >> $GITHUB_OUTPUT
        echo "should_run_pokernews=$RUN_POKERNEWS" >> $GITHUB_OUTPUT
        echo "should_run_youtube=$RUN_YOUTUBE" >> $GITHUB_OUTPUT
        echo "should_run_platform=$RUN_PLATFORM" >> $GITHUB_OUTPUT
        echo "schedule_description=$SCHEDULE_DESC" >> $GITHUB_OUTPUT
        echo "execution_priority=$PRIORITY" >> $GITHUB_OUTPUT
        
        # ê²°ê³¼ ìš”ì•½ ì¶œë ¥
        echo "==============================================="
        echo "ğŸ¯ ìŠ¤ì¼€ì¤„ ê²°ì • ê²°ê³¼"
        echo "==============================================="
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“… ë°ì´í„° ê¸°ê°„: $DATA_START ~ $DATA_END"
        echo "ğŸ”„ PokerNews ì‹¤í–‰: $RUN_POKERNEWS"
        echo "ğŸ”„ YouTube ì‹¤í–‰: $RUN_YOUTUBE"
        echo "ğŸ”„ Platform ì‹¤í–‰: $RUN_PLATFORM"
        echo "âš¡ ìš°ì„ ìˆœìœ„: $PRIORITY"
        echo "ğŸ“‹ ì„¤ëª…: $SCHEDULE_DESC"
        echo "==============================================="

    - name: ğŸ“¤ Slack ì‹œì‘ ì•Œë¦¼
      if: steps.determine-schedule.outputs.report_type != 'none'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          REPORT_TYPE="${{ steps.determine-schedule.outputs.report_type }}"
          SCHEDULE_DESC="${{ steps.determine-schedule.outputs.schedule_description }}"
          DATA_START="${{ steps.determine-schedule.outputs.data_period_start }}"
          DATA_END="${{ steps.determine-schedule.outputs.data_period_end }}"
          EXECUTION_TIME="$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')"
          
          curl -X POST -H 'Content-type: application/json' \
               --data "{
                 \"blocks\": [
                   {
                     \"type\": \"header\",
                     \"text\": {
                       \"type\": \"plain_text\",
                       \"text\": \"ğŸ° í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ ì‹œì‘\",
                       \"emoji\": true
                     }
                   },
                   {
                     \"type\": \"section\",
                     \"text\": {
                       \"type\": \"mrkdwn\",
                       \"text\": \"*ğŸ“… ì‹¤í–‰ ì‹œê°„:* ${EXECUTION_TIME}\\n*ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…:* ${REPORT_TYPE}\\n*ğŸ“ˆ ë°ì´í„° ê¸°ê°„:* ${DATA_START} ~ ${DATA_END}\\n*ğŸ“‹ ì„¤ëª…:* ${SCHEDULE_DESC}\"
                     }
                   },
                   {
                     \"type\": \"section\",
                     \"text\": {
                       \"type\": \"mrkdwn\",
                       \"text\": \"*ğŸ”„ ì‹¤í–‰ ê³„íš:*\\nâ€¢ PokerNews: ${{ steps.determine-schedule.outputs.should_run_pokernews }}\\nâ€¢ YouTube: ${{ steps.determine-schedule.outputs.should_run_youtube }}\\nâ€¢ Platform: ${{ steps.determine-schedule.outputs.should_run_platform }}\"
                     }
                   }
                 ]
               }" \
               "$SLACK_WEBHOOK_URL"
        fi

  # Job 2: PokerNews ë‰´ìŠ¤ ë¶„ì„
  pokernews-analysis:
    name: "ğŸ“° PokerNews ë¶„ì„"
    runs-on: ubuntu-latest
    needs: schedule-determination
    if: ${{ needs.schedule-determination.outputs.should_run_pokernews == 'true' && needs.schedule-determination.outputs.report_type != 'none' }}
    timeout-minutes: 15
    outputs:
      status: ${{ steps.news-analysis.outputs.status }}
      slack_sent: ${{ steps.news-analysis.outputs.slack_sent }}
      error_message: ${{ steps.news-analysis.outputs.error_message }}

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      working-directory: poker-trend-analysis/backend/news-analyzer
      run: |
        pip install -r requirements.txt
        
    - name: ğŸ“° Run PokerNews Analysis
      id: news-analysis
      working-directory: poker-trend-analysis/backend/news-analyzer
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_period_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_period_end }}
      run: |
        echo "ğŸš€ PokerNews ë¶„ì„ ì‹œì‘..."
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“… ë°ì´í„° ê¸°ê°„: $DATA_PERIOD_START ~ $DATA_PERIOD_END"
        
        # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë¦¬í¬íŠ¸ íƒ€ì…ë³„ ë¶„ì„ ì§€ì›)
        if python pokernews_slack_reporter.py > pokernews_output.log 2>&1; then
          echo "âœ… PokerNews ë¶„ì„ ì™„ë£Œ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "slack_sent=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ PokerNews ë¶„ì„ ê²°ê³¼:"
          cat pokernews_output.log
        else
          echo "âŒ PokerNews ë¶„ì„ ì‹¤íŒ¨"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "slack_sent=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ PokerNews ì—ëŸ¬ ë¡œê·¸:"
          cat pokernews_output.log
          
          error_msg=$(cat pokernews_output.log | tail -5)
          echo "error_message=$error_msg" >> $GITHUB_OUTPUT
          
          exit 1
        fi
    
    - name: ğŸ“„ Upload PokerNews Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pokernews-reports-${{ needs.schedule-determination.outputs.report_type }}-${{ github.run_id }}
        path: poker-trend-analysis/backend/news-analyzer/reports/
        retention-days: 30

  # Job 3: YouTube íŠ¸ë Œë“œ ë¶„ì„
  youtube-analysis:
    name: "ğŸ¥ YouTube íŠ¸ë Œë“œ ë¶„ì„"
    runs-on: ubuntu-latest
    needs: [schedule-determination, pokernews-analysis]
    if: ${{ needs.schedule-determination.outputs.should_run_youtube == 'true' && needs.schedule-determination.outputs.report_type != 'none' && (needs.pokernews-analysis.outputs.status == 'success' || needs.pokernews-analysis.result == 'skipped') }}
    timeout-minutes: 20
    outputs:
      status: ${{ steps.youtube-analysis.outputs.status }}
      slack_sent: ${{ steps.youtube-analysis.outputs.slack_sent }}
      error_message: ${{ steps.youtube-analysis.outputs.error_message }}

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      working-directory: backend/data-collector
      run: |
        pip install -r requirements.txt
        
    - name: ğŸ¥ Run YouTube Analysis
      id: youtube-analysis
      working-directory: backend/data-collector
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_period_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_period_end }}
      run: |
        echo "ğŸš€ YouTube íŠ¸ë Œë“œ ë¶„ì„ ì‹œì‘..."
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“… ë°ì´í„° ê¸°ê°„: $DATA_PERIOD_START ~ $DATA_PERIOD_END"
        echo "â° ì´ì „ ì‘ì—… (PokerNews) ìƒíƒœ: ${{ needs.pokernews-analysis.outputs.status || 'skipped' }}"
        
        # 3ì´ˆ ëŒ€ê¸° (Slack API rate limit ê³ ë ¤)
        sleep 3
        
        # ë¦¬í¬íŠ¸ íƒ€ì…ë³„ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ
        case $REPORT_TYPE in
          "monthly")
            echo "ğŸ—“ï¸ ì›”ê°„ YouTube ë¶„ì„ ì‹¤í–‰..."
            python scripts/enhanced_validated_analyzer.py > youtube_output.log 2>&1
            ;;
          "weekly")
            echo "ğŸ“… ì£¼ê°„ YouTube ë¶„ì„ ì‹¤í–‰..."
            python scripts/validated_analyzer_with_translation.py > youtube_output.log 2>&1
            ;;
          "daily"|*)
            echo "ğŸ“‹ ì¼ê°„ YouTube ë¶„ì„ ì‹¤í–‰..."
            python scripts/quick_validated_analyzer.py > youtube_output.log 2>&1
            ;;
        esac
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… YouTube ë¶„ì„ ì™„ë£Œ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "slack_sent=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ YouTube ë¶„ì„ ê²°ê³¼:"
          cat youtube_output.log
        else
          echo "âŒ YouTube ë¶„ì„ ì‹¤íŒ¨"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "slack_sent=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ YouTube ì—ëŸ¬ ë¡œê·¸:"
          cat youtube_output.log
          
          error_msg=$(cat youtube_output.log | tail -5)
          echo "error_message=$error_msg" >> $GITHUB_OUTPUT
          
          exit 1
        fi
    
    - name: ğŸ“„ Upload YouTube Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youtube-reports-${{ needs.schedule-determination.outputs.report_type }}-${{ github.run_id }}
        path: backend/data-collector/scripts/reports/
        retention-days: 30

  # Job 4: Platform íŠ¸ë Œë“œ ë¶„ì„
  platform-analysis:
    name: "ğŸ“Š Platform íŠ¸ë Œë“œ ë¶„ì„"
    runs-on: ubuntu-latest
    needs: [schedule-determination, pokernews-analysis, youtube-analysis]
    if: ${{ needs.schedule-determination.outputs.should_run_platform == 'true' && needs.schedule-determination.outputs.report_type != 'none' && (needs.youtube-analysis.outputs.status == 'success' || needs.youtube-analysis.result == 'skipped') }}
    timeout-minutes: 15
    outputs:
      status: ${{ steps.platform-analysis.outputs.status }}
      slack_sent: ${{ steps.platform-analysis.outputs.slack_sent }}
      error_message: ${{ steps.platform-analysis.outputs.error_message }}

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      working-directory: backend/platform-analyzer
      run: |
        pip install -r requirements.txt
        
    - name: ğŸ“Š Run Platform Analysis
      id: platform-analysis
      working-directory: backend/platform-analyzer/scripts
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        DATA_PERIOD_START: ${{ needs.schedule-determination.outputs.data_period_start }}
        DATA_PERIOD_END: ${{ needs.schedule-determination.outputs.data_period_end }}
      run: |
        echo "ğŸš€ Platform íŠ¸ë Œë“œ ë¶„ì„ ì‹œì‘..."
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“… ë°ì´í„° ê¸°ê°„: $DATA_PERIOD_START ~ $DATA_PERIOD_END"
        echo "â° ì´ì „ ì‘ì—… ìƒíƒœ:"
        echo "  - PokerNews: ${{ needs.pokernews-analysis.outputs.status || 'skipped' }}"
        echo "  - YouTube: ${{ needs.youtube-analysis.outputs.status || 'skipped' }}"
        
        # 5ì´ˆ ëŒ€ê¸° (ì´ì „ Slack ë©”ì‹œì§€ë“¤ê³¼ì˜ ê°„ê²© í™•ë³´)
        sleep 5
        
        # Firebase REST API ë°ì´í„° ìˆ˜ì§‘
        python firebase_rest_api_fetcher.py > platform_output.log 2>&1
        
        # ì¼ì¼ ë¹„êµ ë¶„ì„  
        python show_daily_comparison.py >> platform_output.log 2>&1
        
        # Slack ë¦¬í¬íŠ¸ ì „ì†¡
        python final_slack_reporter.py >> platform_output.log 2>&1
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Platform ë¶„ì„ ì™„ë£Œ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "slack_sent=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Platform ë¶„ì„ ê²°ê³¼:"
          cat platform_output.log
        else
          echo "âŒ Platform ë¶„ì„ ì‹¤íŒ¨"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "slack_sent=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Platform ì—ëŸ¬ ë¡œê·¸:"
          cat platform_output.log
          
          error_msg=$(cat platform_output.log | tail -5)
          echo "error_message=$error_msg" >> $GITHUB_OUTPUT
          
          exit 1
        fi
    
    - name: ğŸ“„ Upload Platform Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: platform-reports-${{ needs.schedule-determination.outputs.report_type }}-${{ github.run_id }}
        path: backend/platform-analyzer/scripts/*.json
        retention-days: 30

  # Job 5: í†µí•© ì™„ë£Œ ë³´ê³ ì„œ
  completion-report:
    name: "ğŸ“‹ í†µí•© ì™„ë£Œ ë³´ê³ ì„œ"
    runs-on: ubuntu-latest
    needs: [schedule-determination, pokernews-analysis, youtube-analysis, platform-analysis]
    if: always() && needs.schedule-determination.outputs.report_type != 'none'
    timeout-minutes: 5

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“Š í†µí•© ì™„ë£Œ ë³´ê³ ì„œ ìƒì„±
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        REPORT_TYPE: ${{ needs.schedule-determination.outputs.report_type }}
        SCHEDULE_DESC: ${{ needs.schedule-determination.outputs.schedule_description }}
        DATA_START: ${{ needs.schedule-determination.outputs.data_period_start }}
        DATA_END: ${{ needs.schedule-determination.outputs.data_period_end }}
        
        POKERNEWS_STATUS: ${{ needs.pokernews-analysis.outputs.status || 'skipped' }}
        POKERNEWS_SLACK: ${{ needs.pokernews-analysis.outputs.slack_sent || 'false' }}
        POKERNEWS_ERROR: ${{ needs.pokernews-analysis.outputs.error_message || '' }}
        
        YOUTUBE_STATUS: ${{ needs.youtube-analysis.outputs.status || 'skipped' }}
        YOUTUBE_SLACK: ${{ needs.youtube-analysis.outputs.slack_sent || 'false' }}
        YOUTUBE_ERROR: ${{ needs.youtube-analysis.outputs.error_message || '' }}
        
        PLATFORM_STATUS: ${{ needs.platform-analysis.outputs.status || 'skipped' }}
        PLATFORM_SLACK: ${{ needs.platform-analysis.outputs.slack_sent || 'false' }}
        PLATFORM_ERROR: ${{ needs.platform-analysis.outputs.error_message || '' }}
        
      run: |
        echo "ğŸ“‹ í†µí•© ì™„ë£Œ ë³´ê³ ì„œ ìƒì„± ì¤‘..."
        
        # ì‹¤í–‰ ì™„ë£Œ ì‹œê°„ (KST)
        COMPLETION_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')
        
        # ì „ì²´ ì„±ê³µ ì—¬ë¶€ ë° ì„±ê³µë¥  ê³„ì‚°
        SUCCESS_COUNT=0
        TOTAL_ENABLED=0
        OVERALL_SUCCESS="true"
        
        # ì„±ê³µí•œ ì‘ì—… ìˆ˜ ê³„ì‚°
        if [[ "${{ needs.schedule-determination.outputs.should_run_pokernews }}" == "true" ]]; then
          ((TOTAL_ENABLED++))
          if [[ "$POKERNEWS_STATUS" == "success" ]]; then
            ((SUCCESS_COUNT++))
          else
            OVERALL_SUCCESS="false"
          fi
        fi
        
        if [[ "${{ needs.schedule-determination.outputs.should_run_youtube }}" == "true" ]]; then
          ((TOTAL_ENABLED++))
          if [[ "$YOUTUBE_STATUS" == "success" ]]; then
            ((SUCCESS_COUNT++))
          else
            OVERALL_SUCCESS="false"
          fi
        fi
        
        if [[ "${{ needs.schedule-determination.outputs.should_run_platform }}" == "true" ]]; then
          ((TOTAL_ENABLED++))
          if [[ "$PLATFORM_STATUS" == "success" ]]; then
            ((SUCCESS_COUNT++))
          else
            OVERALL_SUCCESS="false"
          fi
        fi
        
        # ì„±ê³µë¥  ê³„ì‚°
        if [[ $TOTAL_ENABLED -gt 0 ]]; then
          SUCCESS_RATE=$(( SUCCESS_COUNT * 100 / TOTAL_ENABLED ))
        else
          SUCCESS_RATE=0
        fi
        
        # ìƒíƒœë³„ ì´ëª¨ì§€ í•¨ìˆ˜
        get_status_emoji() {
          case "$1" in
            "success") echo "âœ…" ;;
            "failed") echo "âŒ" ;;
            "skipped") echo "â­ï¸" ;;
            *) echo "â“" ;;
          esac
        }
        
        POKERNEWS_EMOJI=$(get_status_emoji "$POKERNEWS_STATUS")
        YOUTUBE_EMOJI=$(get_status_emoji "$YOUTUBE_STATUS")
        PLATFORM_EMOJI=$(get_status_emoji "$PLATFORM_STATUS")
        
        # ì „ì²´ ìƒíƒœ ê²°ì •
        if [[ "$OVERALL_SUCCESS" == "true" && "$SUCCESS_COUNT" -eq "$TOTAL_ENABLED" && "$TOTAL_ENABLED" -gt 0 ]]; then
          OVERALL_EMOJI="ğŸ‰"
          OVERALL_TEXT="ëª¨ë“  ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          OVERALL_COLOR="#36a64f"  # green
        elif [[ "$SUCCESS_COUNT" -gt 0 ]]; then
          OVERALL_EMOJI="âš ï¸"
          OVERALL_TEXT="ì¼ë¶€ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (${SUCCESS_COUNT}/${TOTAL_ENABLED})"
          OVERALL_COLOR="#ff9500"  # orange
        else
          OVERALL_EMOJI="ğŸš«"
          OVERALL_TEXT="ëª¨ë“  ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
          OVERALL_COLOR="#ff0000"  # red
        fi
        
        # Slack ì•Œë¦¼ ì „ì†¡
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          echo "ğŸš€ í†µí•© ì™„ë£Œ ë³´ê³ ì„œë¥¼ Slackìœ¼ë¡œ ì „ì†¡ ì¤‘..."
          
          # Slack ë©”ì‹œì§€ ìƒì„±
          cat << EOF > completion_report.json
        {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "${OVERALL_EMOJI} í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ ì™„ë£Œ",
                "emoji": true
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ“… ì™„ë£Œ ì‹œê°„:* ${COMPLETION_TIME}\\n*ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…:* ${REPORT_TYPE}\\n*ğŸ“ˆ ë°ì´í„° ê¸°ê°„:* ${DATA_START} ~ ${DATA_END}\\n*ğŸ¯ ì „ì²´ ê²°ê³¼:* ${OVERALL_TEXT}"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ“ˆ ì„±ê³µë¥ : ${SUCCESS_RATE}%* (${SUCCESS_COUNT}/${TOTAL_ENABLED})"
              }
            },
            {
              "type": "divider"
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*ğŸ“Š ë‹¨ê³„ë³„ ì‹¤í–‰ ê²°ê³¼*"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*ğŸ“° PokerNews*\\n${POKERNEWS_EMOJI} ${POKERNEWS_STATUS}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ğŸ¥ YouTube*\\n${YOUTUBE_EMOJI} ${YOUTUBE_STATUS}"
                }
              ]
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*ğŸ“Š Platform*\\n${PLATFORM_EMOJI} ${PLATFORM_STATUS}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*â±ï¸ ì‹¤í–‰ ì‹œê°„*\\nì•½ $(( ${{ github.run_number }} % 60 )) ë¶„"
                }
              ]
            }
          ]
        }
        EOF
          
          # ì—ëŸ¬ ì •ë³´ ì¶”ê°€ (ì‹¤íŒ¨í•œ ì‘ì—…ì´ ìˆëŠ” ê²½ìš°)
          if [[ "$SUCCESS_COUNT" -lt "$TOTAL_ENABLED" ]]; then
            echo "âš ï¸ ì—ëŸ¬ ì •ë³´ë¥¼ ë³´ê³ ì„œì— í¬í•¨ ì¤‘..."
          fi
          
          # Slack ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
               --data @completion_report.json \
               "$SLACK_WEBHOOK_URL"
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… í†µí•© ì™„ë£Œ ë³´ê³ ì„œê°€ Slackìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "âŒ Slack ì „ì†¡ ì‹¤íŒ¨"
          fi
        else
          echo "âš ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ - Slack ì•Œë¦¼ ê±´ë„ˆë›°ê¸°"
        fi
        
        # ì½˜ì†” ìš”ì•½ ì¶œë ¥
        echo "=================================================================="
        echo "ğŸ° í†µí•© í¬ì»¤ ë³´ê³  ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ - ì‹¤í–‰ ì™„ë£Œ ìš”ì•½"
        echo "=================================================================="
        echo "â° ì™„ë£Œ ì‹œê°„: $COMPLETION_TIME"
        echo "ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…: $REPORT_TYPE"
        echo "ğŸ“… ë°ì´í„° ê¸°ê°„: $DATA_START ~ $DATA_END"
        echo "ğŸ¯ ì „ì²´ ìƒíƒœ: $OVERALL_TEXT"
        echo ""
        echo "ğŸ“‹ ë‹¨ê³„ë³„ ê²°ê³¼:"
        echo "  ğŸ“° PokerNews: $POKERNEWS_STATUS"
        echo "  ğŸ¥ YouTube: $YOUTUBE_STATUS"
        echo "  ğŸ“Š Platform: $PLATFORM_STATUS"
        echo ""
        echo "ğŸ“ˆ ì„±ê³µë¥ : $SUCCESS_RATE% ($SUCCESS_COUNT/$TOTAL_ENABLED)"
        echo "ğŸ”— ì‹¤í–‰ ë¡œê·¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "=================================================================="

    - name: ğŸ“„ í†µí•© ì‹¤í–‰ ìš”ì•½ ì €ì¥
      if: always()
      run: |
        # ì‹¤í–‰ ìš”ì•½ì„ JSONìœ¼ë¡œ ì €ì¥
        cat << EOF > unified-execution-summary.json
        {
          "workflow_run_id": "${{ github.run_id }}",
          "execution_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "completion_time_kst": "$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')",
          "report_type": "${{ needs.schedule-determination.outputs.report_type }}",
          "schedule_description": "${{ needs.schedule-determination.outputs.schedule_description }}",
          "data_period": {
            "start": "${{ needs.schedule-determination.outputs.data_period_start }}",
            "end": "${{ needs.schedule-determination.outputs.data_period_end }}"
          },
          "execution_results": {
            "pokernews": {
              "enabled": "${{ needs.schedule-determination.outputs.should_run_pokernews }}",
              "status": "${{ needs.pokernews-analysis.outputs.status || 'skipped' }}",
              "slack_sent": "${{ needs.pokernews-analysis.outputs.slack_sent || 'false' }}"
            },
            "youtube": {
              "enabled": "${{ needs.schedule-determination.outputs.should_run_youtube }}",
              "status": "${{ needs.youtube-analysis.outputs.status || 'skipped' }}",
              "slack_sent": "${{ needs.youtube-analysis.outputs.slack_sent || 'false' }}"
            },
            "platform": {
              "enabled": "${{ needs.schedule-determination.outputs.should_run_platform }}",
              "status": "${{ needs.platform-analysis.outputs.status || 'skipped' }}",
              "slack_sent": "${{ needs.platform-analysis.outputs.slack_sent || 'false' }}"
            }
          },
          "overall_success": $(if [[ "${{ needs.pokernews-analysis.outputs.status || 'skipped' }}" != "failed" && "${{ needs.youtube-analysis.outputs.status || 'skipped' }}" != "failed" && "${{ needs.platform-analysis.outputs.status || 'skipped' }}" != "failed" ]]; then echo "true"; else echo "false"; fi)
        }
        EOF
        
    - name: ğŸ“¤ Upload í†µí•© ì‹¤í–‰ ìš”ì•½
      uses: actions/upload-artifact@v4
      with:
        name: unified-execution-summary-${{ needs.schedule-determination.outputs.report_type }}-${{ github.run_id }}
        path: unified-execution-summary.json
        retention-days: 90

  # Job 6: ì‹¤íŒ¨ ì•Œë¦¼ (ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì‹œ)
  failure-notification:
    name: "ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼"
    runs-on: ubuntu-latest
    needs: [schedule-determination, pokernews-analysis, youtube-analysis, platform-analysis]
    if: failure() && needs.schedule-determination.outputs.report_type != 'none'
    timeout-minutes: 5
    
    steps:
    - name: ğŸš¨ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
          REPORT_TYPE="${{ needs.schedule-determination.outputs.report_type || 'unknown' }}"
          SCHEDULE_DESC="${{ needs.schedule-determination.outputs.schedule_description || 'ì•Œ ìˆ˜ ì—†ìŒ' }}"
          FAILURE_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')
          
          curl -X POST -H 'Content-type: application/json' \
               --data "{
                 \"blocks\": [
                   {
                     \"type\": \"header\",
                     \"text\": {
                       \"type\": \"plain_text\",
                       \"text\": \"ğŸš¨ í†µí•© í¬ì»¤ ë³´ê³  ì‹œìŠ¤í…œ ì‹¤íŒ¨\",
                       \"emoji\": true
                     }
                   },
                   {
                     \"type\": \"section\",
                     \"text\": {
                       \"type\": \"mrkdwn\",
                       \"text\": \"*âŒ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤*\\n\\n*ğŸ“… ì‹¤í–‰ ì‹œê°„:* ${FAILURE_TIME}\\n*ğŸ“Š ë¦¬í¬íŠ¸ íƒ€ì…:* ${REPORT_TYPE}\\n*ğŸ“‹ ìŠ¤ì¼€ì¤„:* ${SCHEDULE_DESC}\\n\\n*ğŸ”— <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ í™•ì¸>*\"
                     }
                   },
                   {
                     \"type\": \"section\",
                     \"text\": {
                       \"type\": \"mrkdwn\",
                       \"text\": \"*âš ï¸ ë‹¨ê³„ë³„ ìƒíƒœ:*\\nâ€¢ PokerNews: ${{ needs.pokernews-analysis.outputs.status || 'unknown' }}\\nâ€¢ YouTube: ${{ needs.youtube-analysis.outputs.status || 'unknown' }}\\nâ€¢ Platform: ${{ needs.platform-analysis.outputs.status || 'unknown' }}\"
                     }
                   }
                 ]
               }" \
               "$SLACK_WEBHOOK_URL"
        fi