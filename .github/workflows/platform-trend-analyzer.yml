name: ì˜¨ë¼ì¸ í¬ì»¤ í”Œë«í¼ íŠ¸ë Œë“œ ë¶„ì„

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 10ì‹œ 30ë¶„ (í•œêµ­ì‹œê°„) - poker-online-analyze ë°ì´í„° ìˆ˜ì§‘ ì´í›„ ì‹¤í–‰
    # UTC ê¸°ì¤€ ì˜¤ì „ 1ì‹œ 30ë¶„
    - cron: '30 1 * * *'
    
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 11ì‹œ 30ë¶„ (í•œêµ­ì‹œê°„) - ì£¼ê°„ ì‹¬ì¸µ ë¶„ì„
    - cron: '30 2 * * 1'
    
    # ë§¤ì›” 1ì¼ ì˜¤í›„ 3ì‹œ (í•œêµ­ì‹œê°„) - ì›”ê°„ ì¢…í•© ë¶„ì„
    - cron: '0 6 1 * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'ë¶„ì„ íƒ€ì…'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - weekly
        - monthly
        - comprehensive

jobs:
  platform-trend-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Python 3.11 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend/platform-analyzer
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì„¤ì •
        run: |
          cd backend/platform-analyzer
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-key.json
      
      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          cd backend/platform-analyzer
          cat > .env << EOF
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"
          FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          EOF
      
      - name: ë¶„ì„ íƒ€ì… ê²°ì •
        id: determine_type
        run: |
          # í˜„ì¬ ì‹œê°„ ì •ë³´ (í•œêµ­ì‹œê°„)
          KST_DATE=$(TZ='Asia/Seoul' date)
          DAY_OF_MONTH=$(TZ='Asia/Seoul' date +%d)
          DAY_OF_WEEK=$(TZ='Asia/Seoul' date +%u)
          
          echo "Current KST: $KST_DATE"
          
          # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ANALYSIS_TYPE="${{ github.event.inputs.analysis_type }}"
          else
            # ìë™ ìŠ¤ì¼€ì¤„ ì‹¤í–‰
            if [ "$DAY_OF_MONTH" = "01" ]; then
              ANALYSIS_TYPE="monthly"
            elif [ "$DAY_OF_WEEK" = "1" ]; then
              ANALYSIS_TYPE="weekly"
            else
              ANALYSIS_TYPE="daily"
            fi
          fi
          
          echo "analysis_type=$ANALYSIS_TYPE" >> $GITHUB_OUTPUT
          echo "ğŸ¯ ë¶„ì„ íƒ€ì…: $ANALYSIS_TYPE"
      
      - name: ì˜¨ë¼ì¸ í”Œë«í¼ íŠ¸ë Œë“œ ë¶„ì„ ì‹¤í–‰
        run: |
          cd backend/platform-analyzer/scripts
          
          ANALYSIS_TYPE="${{ steps.determine_type.outputs.analysis_type }}"
          
          echo "ğŸš€ ì˜¨ë¼ì¸ í¬ì»¤ í”Œë«í¼ íŠ¸ë Œë“œ ë¶„ì„ ì‹œì‘"
          echo "ğŸ“Š ë¶„ì„ íƒ€ì…: $ANALYSIS_TYPE"
          echo "â° ì‹¤í–‰ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
          
          # ë¶„ì„ ì‹¤í–‰
          python online_platform_trend_analyzer.py
          
          # ì¶”ê°€ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
          case $ANALYSIS_TYPE in
            "weekly")
              echo "ğŸ“… ì£¼ê°„ ì‹¬ì¸µ ë¶„ì„ ì‹¤í–‰..."
              python weekly_platform_analysis.py || true
              ;;
            "monthly")
              echo "ğŸ“ˆ ì›”ê°„ ì¢…í•© ë¶„ì„ ì‹¤í–‰..."
              python monthly_platform_report.py || true
              ;;
            "comprehensive")
              echo "ğŸ” ì¢…í•© ë¶„ì„ ì‹¤í–‰..."
              python comprehensive_platform_analysis.py || true
              ;;
          esac
      
      - name: ë¶„ì„ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: platform-analysis-${{ steps.determine_type.outputs.analysis_type }}-${{ github.run_number }}
          path: |
            backend/platform-analyzer/scripts/reports/*.json
            backend/platform-analyzer/scripts/reports/*.txt
          retention-days: 30
      
      - name: ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        run: |
          echo "âœ… ì˜¨ë¼ì¸ í¬ì»¤ í”Œë«í¼ íŠ¸ë Œë“œ ë¶„ì„ ì™„ë£Œ"
          echo "ğŸ“Š ë¶„ì„ íƒ€ì…: ${{ steps.determine_type.outputs.analysis_type }}"
          echo "â° ì™„ë£Œ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
          
          # ìƒì„±ëœ ë³´ê³ ì„œ í™•ì¸
          echo "ğŸ“ ìƒì„±ëœ ë³´ê³ ì„œ:"
          ls -la backend/platform-analyzer/scripts/reports/ 2>/dev/null || echo "ë³´ê³ ì„œ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
  
  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-on-failure:
    if: failure()
    needs: platform-trend-analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data '{
              "text": "âŒ ì˜¨ë¼ì¸ í¬ì»¤ í”Œë«í¼ íŠ¸ë Œë“œ ë¶„ì„ ì‹¤íŒ¨\nì‹¤í–‰ ì‹œê°„: '"$(TZ='Asia/Seoul' date)"'\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ í™•ì¸>"
            }'