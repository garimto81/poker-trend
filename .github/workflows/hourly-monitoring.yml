name: Hourly Trend Monitoring

on:
  schedule:
    # 매시간 정각 실행
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install google-api-python-client requests
        
    - name: Run Trend Monitoring
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        cd backend/data-collector
        python -c "
import os
import sys
sys.path.append('scripts')
from youtube_trend_webhook_enhanced import EnhancedYouTubeTrendAnalyzer
from datetime import datetime, timedelta
import requests
import json

analyzer = EnhancedYouTubeTrendAnalyzer()
videos = analyzer.collect_videos(lookback_hours=2)  # 최근 2시간

# 급상승 감지 (시간당 조회수 기준)
hot_videos = [v for v in videos if v.get('views_per_hour', 0) > 10000]

if hot_videos:
    # 급상승 알림 전송
    hot_videos.sort(key=lambda x: x.get('views_per_hour', 0), reverse=True)
    
    blocks = [
        {
            'type': 'header',
            'text': {
                'type': 'plain_text',
                'text': '⚡ 포커 트렌드 급상승 감지!'
            }
        },
        {
            'type': 'section',
            'text': {
                'type': 'mrkdwn',
                'text': f'*{len(hot_videos)}개의 영상이 급상승 중입니다*'
            }
        }
    ]
    
    for video in hot_videos[:3]:
        blocks.append({
            'type': 'section',
            'text': {
                'type': 'mrkdwn',
                'text': f'*<https://youtube.com/watch?v={video[\"video_id\"]}|{video[\"title\"][:60]}...>*\\n' +
                       f'시간당 조회수: {int(video[\"views_per_hour\"]):,}회\\n' +
                       f'참여율: {video.get(\"engagement_rate\", 0):.2f}%'
            }
        })
    
    blocks.append({
        'type': 'section',
        'text': {
            'type': 'mrkdwn',
            'text': '💡 *즉시 제작 추천*: 관련 쇼츠를 빠르게 제작하여 트렌드를 활용하세요!'
        }
    })
    
    payload = {
        'blocks': blocks,
        'text': '⚡ 포커 트렌드 급상승 감지!'
    }
    
    requests.post(os.getenv('SLACK_WEBHOOK_URL'), json=payload)
    
    print(f'급상승 영상 {len(hot_videos)}개 감지 및 알림 전송')
else:
    print('급상승 영상 없음')
"
        
    - name: Save Monitoring Log
      if: always()
      run: |
        mkdir -p logs
        echo "[$(date)] Monitoring completed" >> logs/monitoring.log