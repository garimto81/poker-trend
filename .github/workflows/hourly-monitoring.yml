name: Hourly Trend Monitoring

on:
  schedule:
    # ë§¤ì‹œê°„ ì •ê° ì‹¤í–‰
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install google-api-python-client requests
        
    - name: Run Trend Monitoring
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        cd backend/data-collector
        python -c "
import os
import sys
sys.path.append('scripts')
from youtube_trend_webhook_enhanced import EnhancedYouTubeTrendAnalyzer
from datetime import datetime, timedelta
import requests
import json

analyzer = EnhancedYouTubeTrendAnalyzer()
videos = analyzer.collect_videos(lookback_hours=2)  # ìµœê·¼ 2ì‹œê°„

# ê¸‰ìƒìŠ¹ ê°ì§€ (ì‹œê°„ë‹¹ ì¡°íšŒìˆ˜ ê¸°ì¤€)
hot_videos = [v for v in videos if v.get('views_per_hour', 0) > 10000]

if hot_videos:
    # ê¸‰ìƒìŠ¹ ì•Œë¦¼ ì „ì†¡
    hot_videos.sort(key=lambda x: x.get('views_per_hour', 0), reverse=True)
    
    blocks = [
        {
            'type': 'header',
            'text': {
                'type': 'plain_text',
                'text': 'âš¡ í¬ì»¤ íŠ¸ë Œë“œ ê¸‰ìƒìŠ¹ ê°ì§€!'
            }
        },
        {
            'type': 'section',
            'text': {
                'type': 'mrkdwn',
                'text': f'*{len(hot_videos)}ê°œì˜ ì˜ìƒì´ ê¸‰ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤*'
            }
        }
    ]
    
    for video in hot_videos[:3]:
        blocks.append({
            'type': 'section',
            'text': {
                'type': 'mrkdwn',
                'text': f'*<https://youtube.com/watch?v={video[\"video_id\"]}|{video[\"title\"][:60]}...>*\\n' +
                       f'ì‹œê°„ë‹¹ ì¡°íšŒìˆ˜: {int(video[\"views_per_hour\"]):,}íšŒ\\n' +
                       f'ì°¸ì—¬ìœ¨: {video.get(\"engagement_rate\", 0):.2f}%'
            }
        })
    
    blocks.append({
        'type': 'section',
        'text': {
            'type': 'mrkdwn',
            'text': 'ğŸ’¡ *ì¦‰ì‹œ ì œì‘ ì¶”ì²œ*: ê´€ë ¨ ì‡¼ì¸ ë¥¼ ë¹ ë¥´ê²Œ ì œì‘í•˜ì—¬ íŠ¸ë Œë“œë¥¼ í™œìš©í•˜ì„¸ìš”!'
        }
    })
    
    payload = {
        'blocks': blocks,
        'text': 'âš¡ í¬ì»¤ íŠ¸ë Œë“œ ê¸‰ìƒìŠ¹ ê°ì§€!'
    }
    
    requests.post(os.getenv('SLACK_WEBHOOK_URL'), json=payload)
    
    print(f'ê¸‰ìƒìŠ¹ ì˜ìƒ {len(hot_videos)}ê°œ ê°ì§€ ë° ì•Œë¦¼ ì „ì†¡')
else:
    print('ê¸‰ìƒìŠ¹ ì˜ìƒ ì—†ìŒ')
"
        
    - name: Save Monitoring Log
      if: always()
      run: |
        mkdir -p logs
        echo "[$(date)] Monitoring completed" >> logs/monitoring.log