name: 포커 트렌드 분석 자동 스케줄러

on:
  schedule:
    # 매월 첫째주 월요일 오후 2시 (한국시간 기준) - 월간 리포트
    # UTC 기준 오전 5시 (한국시간 - 9시간)
    - cron: '0 5 1-7 * 1'  # 매월 1-7일 중 월요일 UTC 05:00
    
    # 매주 월요일 오전 11시 (한국시간 기준) - 주간 리포트  
    # UTC 기준 오전 2시 (한국시간 - 9시간)
    - cron: '0 2 * * 1'    # 매주 월요일 UTC 02:00
    
    # 화-금요일 오전 10시 (한국시간 기준) - 일간 리포트
    # UTC 기준 오전 1시 (한국시간 - 9시간)
    - cron: '0 1 * * 2-5'  # 화-금요일 UTC 01:00 (월요일, 주말 제외)

  # 수동 실행 가능
  workflow_dispatch:
    inputs:
      report_type:
        description: '리포트 타입'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - weekly
        - monthly

jobs:
  determine-report-type:
    runs-on: ubuntu-latest
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
      date_range: ${{ steps.determine.outputs.date_range }}
      schedule_description: ${{ steps.determine.outputs.schedule_description }}
    steps:
      - name: 리포트 타입 결정
        id: determine
        run: |
          # 현재 날짜 정보 (한국시간 기준)
          KST_DATE=$(TZ='Asia/Seoul' date)
          DAY_OF_MONTH=$(TZ='Asia/Seoul' date +%d)
          DAY_OF_WEEK=$(TZ='Asia/Seoul' date +%u)  # 1=월요일, 7=일요일
          HOUR=$(TZ='Asia/Seoul' date +%H)
          
          echo "Current KST: $KST_DATE"
          echo "Day of month: $DAY_OF_MONTH"
          echo "Day of week: $DAY_OF_WEEK"
          echo "Hour: $HOUR"
          
          # 수동 실행인 경우
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPORT_TYPE="${{ github.event.inputs.report_type }}"
            case $REPORT_TYPE in
              "monthly") DATE_RANGE=30 ;;
              "weekly") DATE_RANGE=7 ;;
              *) DATE_RANGE=1 ;;
            esac
            SCHEDULE_DESC="수동 실행 - $REPORT_TYPE 리포트"
          else
            # 자동 스케줄 실행인 경우
            # 매월 첫째주 월요일 체크 (1일~7일 사이의 월요일)
            if [ $DAY_OF_WEEK -eq 1 ] && [ $DAY_OF_MONTH -le 7 ] && [ "${{ github.event.schedule }}" = "0 5 1-7 * 1" ]; then
              REPORT_TYPE="monthly"
              DATE_RANGE=30
              SCHEDULE_DESC="매월 첫째주 월요일 오후 2시 - 월간 리포트 (지난 달 분석)"
            # 매주 월요일 체크
            elif [ $DAY_OF_WEEK -eq 1 ] && [ "${{ github.event.schedule }}" = "0 2 * * 1" ]; then
              REPORT_TYPE="weekly"
              DATE_RANGE=7
              SCHEDULE_DESC="매주 월요일 오전 11시 - 주간 리포트 (지난 주 분석)"
            # 평일 일간 리포트
            else
              REPORT_TYPE="daily"
              DATE_RANGE=1
              SCHEDULE_DESC="평일 오전 10시 - 일간 리포트 (오늘 분석)"
            fi
          fi
          
          echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
          echo "date_range=$DATE_RANGE" >> $GITHUB_OUTPUT
          echo "schedule_description=$SCHEDULE_DESC" >> $GITHUB_OUTPUT
          
          echo "🎯 결정된 리포트 타입: $REPORT_TYPE"
          echo "📅 분석 기간: $DATE_RANGE일"
          echo "📋 스케줄 설명: $SCHEDULE_DESC"

  poker-trend-analysis:
    needs: determine-report-type
    runs-on: ubuntu-latest
    
    steps:
      - name: 저장소 체크아웃
        uses: actions/checkout@v4
        
      - name: Python 3.11 설정
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: 의존성 설치
        run: |
          cd backend/data-collector
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: 환경 변수 설정
        run: |
          cd backend/data-collector
          cat > .env << EOF
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          EOF
          
      - name: 리포트 타입별 분석 실행
        run: |
          cd backend/data-collector/scripts
          
          REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type }}"
          DATE_RANGE="${{ needs.determine-report-type.outputs.date_range }}"
          SCHEDULE_DESC="${{ needs.determine-report-type.outputs.schedule_description }}"
          
          echo "🚀 포커 트렌드 분석 시작"
          echo "📊 리포트 타입: $REPORT_TYPE"
          echo "📅 분석 기간: ${DATE_RANGE}일"
          echo "⏰ 스케줄: $SCHEDULE_DESC"
          echo "🕐 실행 시간 (KST): $(TZ='Asia/Seoul' date)"
          
          # 리포트 타입에 따라 다른 분석기 실행
          case $REPORT_TYPE in
            "monthly")
              echo "🗓️ 월간 분석 실행 중..."
              python enhanced_validated_analyzer.py
              ;;
            "weekly") 
              echo "📅 주간 분석 실행 중..."
              python validated_analyzer_with_translation.py
              ;;
            "daily"|*)
              echo "📋 일간 분석 실행 중..."
              python quick_validated_analyzer.py
              ;;
          esac
          
      - name: 분석 결과 아티팩트 업로드
        uses: actions/upload-artifact@v4
        with:
          name: poker-analysis-reports-${{ needs.determine-report-type.outputs.report_type }}-${{ github.run_number }}
          path: |
            backend/data-collector/scripts/reports/*.json
            backend/data-collector/scripts/reports/*.txt
          retention-days: 30
          
      - name: 실행 결과 요약
        run: |
          echo "✅ 포커 트렌드 분석 완료"
          echo "📊 리포트 타입: ${{ needs.determine-report-type.outputs.report_type }}"
          echo "📅 분석 기간: ${{ needs.determine-report-type.outputs.date_range }}일"
          echo "⏰ 완료 시간 (KST): $(TZ='Asia/Seoul' date)"
          echo "🎯 Slack 알림 전송 완료"
          
          # 보고서 파일 확인
          echo "📁 생성된 보고서 파일들:"
          ls -la backend/data-collector/scripts/reports/ | tail -10

  # 실행 실패 시 알림
  notify-failure:
    if: failure()
    needs: [determine-report-type, poker-trend-analysis]
    runs-on: ubuntu-latest
    
    steps:
      - name: 실패 알림 전송
        run: |
          REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type || 'unknown' }}"
          SCHEDULE_DESC="${{ needs.determine-report-type.outputs.schedule_description || '알 수 없음' }}"
          KST_TIME=$(TZ='Asia/Seoul' date)
          
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"❌ 포커 트렌드 분석 실패\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"📅 실행 시간: $KST_TIME\\n📊 리포트 타입: $REPORT_TYPE\\n⏰ 스케줄: $SCHEDULE_DESC\\n🔗 <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions 로그 확인>\"
                  }
                }
              ]
            }"