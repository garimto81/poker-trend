name: í¬ì»¤ íŠ¸ë Œë“œ ë¶„ì„ ìžë™ ìŠ¤ì¼€ì¤„ëŸ¬

on:
  schedule:
    # ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼ ì˜¤í›„ 2ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€) - ì›”ê°„ ë¦¬í¬íŠ¸
    # UTC ê¸°ì¤€ ì˜¤ì „ 5ì‹œ (í•œêµ­ì‹œê°„ - 9ì‹œê°„)
    - cron: '0 5 1-7 * 1'  # ë§¤ì›” 1-7ì¼ ì¤‘ ì›”ìš”ì¼ UTC 05:00
    
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 11ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€) - ì£¼ê°„ ë¦¬í¬íŠ¸  
    # UTC ê¸°ì¤€ ì˜¤ì „ 2ì‹œ (í•œêµ­ì‹œê°„ - 9ì‹œê°„)
    - cron: '0 2 * * 1'    # ë§¤ì£¼ ì›”ìš”ì¼ UTC 02:00
    
    # í™”-í† ìš”ì¼ ì˜¤ì „ 10ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€) - ì¼ê°„ ë¦¬í¬íŠ¸
    # UTC ê¸°ì¤€ ì˜¤ì „ 1ì‹œ (í•œêµ­ì‹œê°„ - 9ì‹œê°„)
    - cron: '0 1 * * 2-6'  # í™”-í† ìš”ì¼ UTC 01:00 (ì›”ìš”ì¼ ì œì™¸)

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      report_type:
        description: 'ë¦¬í¬íŠ¸ íƒ€ìž…'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - weekly
        - monthly

jobs:
  determine-report-type:
    runs-on: ubuntu-latest
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
      date_range: ${{ steps.determine.outputs.date_range }}
      schedule_description: ${{ steps.determine.outputs.schedule_description }}
    steps:
      - name: ë¦¬í¬íŠ¸ íƒ€ìž… ê²°ì •
        id: determine
        run: |
          # í˜„ìž¬ ë‚ ì§œ ì •ë³´ (í•œêµ­ì‹œê°„ ê¸°ì¤€)
          KST_DATE=$(TZ='Asia/Seoul' date)
          DAY_OF_MONTH=$(TZ='Asia/Seoul' date +%d)
          DAY_OF_WEEK=$(TZ='Asia/Seoul' date +%u)  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
          HOUR=$(TZ='Asia/Seoul' date +%H)
          
          echo "Current KST: $KST_DATE"
          echo "Day of month: $DAY_OF_MONTH"
          echo "Day of week: $DAY_OF_WEEK"
          echo "Hour: $HOUR"
          
          # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPORT_TYPE="${{ github.event.inputs.report_type }}"
            case $REPORT_TYPE in
              "monthly") DATE_RANGE=30 ;;
              "weekly") DATE_RANGE=7 ;;
              *) DATE_RANGE=1 ;;
            esac
            SCHEDULE_DESC="ìˆ˜ë™ ì‹¤í–‰ - $REPORT_TYPE ë¦¬í¬íŠ¸"
          else
            # ìžë™ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì¸ ê²½ìš°
            # ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼ ì²´í¬ (1ì¼~7ì¼ ì‚¬ì´ì˜ ì›”ìš”ì¼)
            if [ $DAY_OF_WEEK -eq 1 ] && [ $DAY_OF_MONTH -le 7 ] && [ "${{ github.event.schedule }}" = "0 5 1-7 * 1" ]; then
              REPORT_TYPE="monthly"
              DATE_RANGE=30
              SCHEDULE_DESC="ë§¤ì›” ì²«ì§¸ì£¼ ì›”ìš”ì¼ ì˜¤í›„ 2ì‹œ - ì›”ê°„ ë¦¬í¬íŠ¸ (ì§€ë‚œ ë‹¬ ë¶„ì„)"
            # ë§¤ì£¼ ì›”ìš”ì¼ ì²´í¬
            elif [ $DAY_OF_WEEK -eq 1 ] && [ "${{ github.event.schedule }}" = "0 2 * * 1" ]; then
              REPORT_TYPE="weekly"
              DATE_RANGE=7
              SCHEDULE_DESC="ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 11ì‹œ - ì£¼ê°„ ë¦¬í¬íŠ¸ (ì§€ë‚œ ì£¼ ë¶„ì„)"
            # í‰ì¼ ì¼ê°„ ë¦¬í¬íŠ¸
            else
              REPORT_TYPE="daily"
              DATE_RANGE=1
              SCHEDULE_DESC="í‰ì¼ ì˜¤ì „ 10ì‹œ - ì¼ê°„ ë¦¬í¬íŠ¸ (ì˜¤ëŠ˜ ë¶„ì„)"
            fi
          fi
          
          echo "report_type=$REPORT_TYPE" >> $GITHUB_OUTPUT
          echo "date_range=$DATE_RANGE" >> $GITHUB_OUTPUT
          echo "schedule_description=$SCHEDULE_DESC" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ ê²°ì •ëœ ë¦¬í¬íŠ¸ íƒ€ìž…: $REPORT_TYPE"
          echo "ðŸ“… ë¶„ì„ ê¸°ê°„: $DATE_RANGEì¼"
          echo "ðŸ“‹ ìŠ¤ì¼€ì¤„ ì„¤ëª…: $SCHEDULE_DESC"

  poker-trend-analysis:
    needs: determine-report-type
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Python 3.11 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend/data-collector
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          cd backend/data-collector
          cat > .env << EOF
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          EOF
          
      - name: ë¦¬í¬íŠ¸ íƒ€ìž…ë³„ ë¶„ì„ ì‹¤í–‰
        run: |
          cd backend/data-collector/scripts
          
          REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type }}"
          DATE_RANGE="${{ needs.determine-report-type.outputs.date_range }}"
          SCHEDULE_DESC="${{ needs.determine-report-type.outputs.schedule_description }}"
          
          echo "ðŸš€ í¬ì»¤ íŠ¸ë Œë“œ ë¶„ì„ ì‹œìž‘"
          echo "ðŸ“Š ë¦¬í¬íŠ¸ íƒ€ìž…: $REPORT_TYPE"
          echo "ðŸ“… ë¶„ì„ ê¸°ê°„: ${DATE_RANGE}ì¼"
          echo "â° ìŠ¤ì¼€ì¤„: $SCHEDULE_DESC"
          echo "ðŸ• ì‹¤í–‰ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
          
          # ë¦¬í¬íŠ¸ íƒ€ìž…ì— ë”°ë¼ ë‹¤ë¥¸ ë¶„ì„ê¸° ì‹¤í–‰
          case $REPORT_TYPE in
            "monthly")
              echo "ðŸ—“ï¸ ì›”ê°„ ë¶„ì„ ì‹¤í–‰ ì¤‘..."
              python enhanced_validated_analyzer.py
              ;;
            "weekly") 
              echo "ðŸ“… ì£¼ê°„ ë¶„ì„ ì‹¤í–‰ ì¤‘..."
              python validated_analyzer_with_translation.py
              ;;
            "daily"|*)
              echo "ðŸ“‹ ì¼ê°„ ë¶„ì„ ì‹¤í–‰ ì¤‘..."
              python quick_validated_analyzer.py
              ;;
          esac
          
      - name: ë¶„ì„ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: poker-analysis-reports-${{ needs.determine-report-type.outputs.report_type }}-${{ github.run_number }}
          path: |
            backend/data-collector/scripts/reports/*.json
            backend/data-collector/scripts/reports/*.txt
          retention-days: 30
          
      - name: ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        run: |
          echo "âœ… í¬ì»¤ íŠ¸ë Œë“œ ë¶„ì„ ì™„ë£Œ"
          echo "ðŸ“Š ë¦¬í¬íŠ¸ íƒ€ìž…: ${{ needs.determine-report-type.outputs.report_type }}"
          echo "ðŸ“… ë¶„ì„ ê¸°ê°„: ${{ needs.determine-report-type.outputs.date_range }}ì¼"
          echo "â° ì™„ë£Œ ì‹œê°„ (KST): $(TZ='Asia/Seoul' date)"
          echo "ðŸŽ¯ Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
          
          # ë³´ê³ ì„œ íŒŒì¼ í™•ì¸
          echo "ðŸ“ ìƒì„±ëœ ë³´ê³ ì„œ íŒŒì¼ë“¤:"
          ls -la backend/data-collector/scripts/reports/ | tail -10

  # ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    if: failure()
    needs: [determine-report-type, poker-trend-analysis]
    runs-on: ubuntu-latest
    
    steps:
      - name: ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
        run: |
          REPORT_TYPE="${{ needs.determine-report-type.outputs.report_type || 'unknown' }}"
          SCHEDULE_DESC="${{ needs.determine-report-type.outputs.schedule_description || 'ì•Œ ìˆ˜ ì—†ìŒ' }}"
          KST_TIME=$(TZ='Asia/Seoul' date)
          
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âŒ í¬ì»¤ íŠ¸ë Œë“œ ë¶„ì„ ì‹¤íŒ¨\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ðŸ“… ì‹¤í–‰ ì‹œê°„: $KST_TIME\\nðŸ“Š ë¦¬í¬íŠ¸ íƒ€ìž…: $REPORT_TYPE\\nâ° ìŠ¤ì¼€ì¤„: $SCHEDULE_DESC\\nðŸ”— <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ í™•ì¸>\"
                  }
                }
              ]
            }"