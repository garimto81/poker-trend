<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GFX 오버레이 학습기 간단 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .test-pass {
            color: #28a745;
            font-weight: bold;
        }
        .test-fail {
            color: #dc3545;
            font-weight: bold;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .test-result.pass {
            border-left-color: #28a745;
        }
        .test-result.fail {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>🧪 GFX 오버레이 학습기 기능 테스트</h1>
        <hr>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">테스트 시뮬레이션</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">현재 시간 (초)</label>
                            <input type="number" id="currentTime" class="form-control" value="0" min="0" step="1">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">비디오 총 길이 (초)</label>
                            <input type="number" id="videoDuration" class="form-control" value="600" min="1">
                        </div>
                        
                        <button class="btn btn-danger btn-lg w-100" id="gfxToggleBtn" onclick="toggleGFX()">
                            📺 GFX 오버레이 인식 (클릭: 시작점 마킹)
                        </button>
                        
                        <div class="alert alert-info mt-3" id="segmentInfo" style="display: none;">
                            <strong>현재 구간:</strong> <span id="segmentStatus">대기 중</span><br>
                            <strong>시작점:</strong> <span id="segmentStart">-</span><br>
                            <strong>종료점:</strong> <span id="segmentEnd">-</span><br>
                            <strong>핸드 구간:</strong> <span id="handSegment">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">저장된 구간</h5>
                    </div>
                    <div class="card-body" id="segmentsList">
                        <p class="text-muted">아직 저장된 구간이 없습니다.</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">자동 테스트 결과</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="runAutoTests()">
                            🚀 자동 테스트 실행
                        </button>
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="../web-ui/gfx_overlay_trainer.html" class="btn btn-success" target="_blank">
                🎰 실제 GFX 오버레이 학습기 열기
            </a>
        </div>
    </div>
    
    <script>
        // 전역 변수
        let segments = [];
        let currentSegment = null;
        let isMarkingStart = true;
        
        // 시간 포맷
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // GFX 토글
        function toggleGFX() {
            const currentTime = parseFloat(document.getElementById('currentTime').value);
            const videoDuration = parseFloat(document.getElementById('videoDuration').value);
            const btn = document.getElementById('gfxToggleBtn');
            const segmentInfo = document.getElementById('segmentInfo');
            
            if (isMarkingStart) {
                // 시작점 마킹
                currentSegment = {
                    gfxStart: currentTime,
                    gfxEnd: null,
                    handStart: null,
                    handEnd: null,
                    id: Date.now()
                };
                
                btn.textContent = '📺 GFX 오버레이 인식 (클릭: 종료점 마킹)';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-warning');
                
                segmentInfo.style.display = 'block';
                document.getElementById('segmentStatus').textContent = 'GFX 구간 마킹 중...';
                document.getElementById('segmentStart').textContent = formatTime(currentSegment.gfxStart);
                document.getElementById('segmentEnd').textContent = '대기 중...';
                
                isMarkingStart = false;
                
            } else {
                // 종료점 마킹
                if (!currentSegment) return;
                
                currentSegment.gfxEnd = currentTime;
                
                // 15초 규칙 적용
                currentSegment.handStart = Math.max(0, currentSegment.gfxStart - 15);
                currentSegment.handEnd = Math.min(videoDuration, currentSegment.gfxEnd + 15);
                
                segments.push(currentSegment);
                
                btn.textContent = '📺 GFX 오버레이 인식 (클릭: 시작점 마킹)';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
                
                document.getElementById('segmentStatus').textContent = '구간 저장 완료!';
                document.getElementById('segmentEnd').textContent = formatTime(currentSegment.gfxEnd);
                document.getElementById('handSegment').textContent = 
                    `${formatTime(currentSegment.handStart)} ~ ${formatTime(currentSegment.handEnd)}`;
                
                updateSegmentsList();
                currentSegment = null;
                isMarkingStart = true;
            }
        }
        
        // 구간 목록 업데이트
        function updateSegmentsList() {
            const list = document.getElementById('segmentsList');
            
            if (segments.length === 0) {
                list.innerHTML = '<p class="text-muted">아직 저장된 구간이 없습니다.</p>';
                return;
            }
            
            let html = '';
            segments.forEach((seg, idx) => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>구간 ${idx + 1}</h6>
                            <small>
                                GFX: ${formatTime(seg.gfxStart)} ~ ${formatTime(seg.gfxEnd)}<br>
                                핸드: ${formatTime(seg.handStart)} ~ ${formatTime(seg.handEnd)}<br>
                                길이: ${formatTime(seg.handEnd - seg.handStart)}
                            </small>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }
        
        // 자동 테스트
        function runAutoTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';
            
            const tests = [
                {
                    name: "15초 규칙 테스트",
                    test: () => {
                        // 테스트 데이터
                        const testGfxStart = 30;
                        const testGfxEnd = 45;
                        const expectedHandStart = 15;  // 30 - 15
                        const expectedHandEnd = 60;    // 45 + 15
                        
                        const handStart = Math.max(0, testGfxStart - 15);
                        const handEnd = testGfxEnd + 15;
                        
                        return handStart === expectedHandStart && handEnd === expectedHandEnd;
                    }
                },
                {
                    name: "경계값 처리 테스트",
                    test: () => {
                        // 시작 경계
                        const testGfxStart = 10;  // -15하면 음수
                        const handStart = Math.max(0, testGfxStart - 15);
                        
                        return handStart === 0;  // 0이어야 함
                    }
                },
                {
                    name: "버튼 토글 테스트",
                    test: () => {
                        const btn = document.getElementById('gfxToggleBtn');
                        const initialText = btn.textContent;
                        
                        // 시작점 클릭 시뮬레이션
                        if (isMarkingStart) {
                            toggleGFX();
                            const afterFirstClick = btn.textContent;
                            
                            // 종료점 클릭 시뮬레이션
                            document.getElementById('currentTime').value = 50;
                            toggleGFX();
                            const afterSecondClick = btn.textContent;
                            
                            return initialText !== afterFirstClick && 
                                   afterFirstClick !== afterSecondClick &&
                                   initialText === afterSecondClick;
                        }
                        return false;
                    }
                },
                {
                    name: "구간 저장 테스트",
                    test: () => {
                        const initialCount = segments.length;
                        
                        // 구간 추가 시뮬레이션
                        document.getElementById('currentTime').value = 100;
                        toggleGFX();  // 시작
                        document.getElementById('currentTime').value = 120;
                        toggleGFX();  // 종료
                        
                        return segments.length === initialCount + 1;
                    }
                },
                {
                    name: "시간 포맷 테스트",
                    test: () => {
                        const formatted = formatTime(125);  // 2:05
                        return formatted === "2:05";
                    }
                }
            ];
            
            let passCount = 0;
            
            tests.forEach(test => {
                try {
                    const passed = test.test();
                    passCount += passed ? 1 : 0;
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                    resultDiv.innerHTML = `
                        <span class="${passed ? 'test-pass' : 'test-fail'}">
                            ${passed ? '✅' : '❌'} ${test.name}
                        </span>
                    `;
                    results.appendChild(resultDiv);
                } catch (error) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'test-result fail';
                    resultDiv.innerHTML = `
                        <span class="test-fail">
                            ❌ ${test.name} - 오류: ${error.message}
                        </span>
                    `;
                    results.appendChild(resultDiv);
                }
            });
            
            // 결과 요약
            const summary = document.createElement('div');
            summary.className = 'alert alert-info mt-3';
            summary.innerHTML = `
                <strong>테스트 결과:</strong> ${passCount}/${tests.length} 통과
                (${Math.round(passCount/tests.length * 100)}%)
            `;
            results.appendChild(summary);
        }
        
        // 페이지 로드 시 자동 테스트 실행
        window.onload = () => {
            console.log('GFX 오버레이 학습기 테스트 페이지 로드 완료');
        };
    </script>
</body>
</html>