{% extends "base.html" %}

{% block content %}
<div class="poker-header">
    <h1><i class="fas fa-spade-suit text-primary"></i> í¬ì»¤ ëŒ€íšŒ ì˜ìƒ ë¶„ì„ê¸°</h1>
    <p>YouTube ë§í¬ë‚˜ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í¬ì»¤ í•¸ë“œì˜ ê¸¸ì´ë¥¼ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”</p>
</div>

<!-- ë¶„ì„ í¼ -->
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card card-custom">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-video me-2"></i>
                    ì˜ìƒ ë¶„ì„ ì‹œì‘
                </h5>
                
                <form id="analysisForm">
                    <!-- URL ì…ë ¥ íƒ­ -->
                    <ul class="nav nav-tabs" id="inputTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-pane" type="button">
                                <i class="fas fa-link me-2"></i>ë¹„ë””ì˜¤ URL
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse-pane" type="button">
                                <i class="fas fa-folder-open me-2"></i>íŒŒì¼ íƒìƒ‰
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button">
                                <i class="fas fa-upload me-2"></i>íŒŒì¼ ì—…ë¡œë“œ
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="inputTabsContent">
                        <!-- URL ì…ë ¥ -->
                        <div class="tab-pane fade show active" id="url-pane">
                            <div class="mb-3">
                                <label for="videoUrl" class="form-label">ë¹„ë””ì˜¤ URL</label>
                                <input type="url" class="form-control" id="videoUrl" name="video_url" 
                                       placeholder="https://www.youtube.com/watch?v=... ë˜ëŠ” ì§ì ‘ ë¹„ë””ì˜¤ ë§í¬">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    YouTube, Twitch, ì§ì ‘ ë¹„ë””ì˜¤ ë§í¬ ë“±ì„ ì…ë ¥í•˜ì„¸ìš” (ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë°”ë¡œ ì²˜ë¦¬)
                                </div>
                            </div>
                        </div>
                        
                        <!-- íŒŒì¼ íƒìƒ‰ -->
                        <div class="tab-pane fade" id="browse-pane">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">ë“œë¼ì´ë¸Œ ì„ íƒ</label>
                                        <select class="form-select" id="driveSelect">
                                            <option value="">ë“œë¼ì´ë¸Œë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">í˜„ì¬ ê²½ë¡œ</label>
                                        <input type="text" class="form-control" id="currentPath" readonly>
                                        <div class="btn-group mt-2 w-100">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="parentDirBtn">
                                                <i class="fas fa-level-up-alt me-1"></i>ìƒìœ„ í´ë”
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                                                <i class="fas fa-sync me-1"></i>ìƒˆë¡œê³ ì¹¨
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">íŒŒì¼ ëª©ë¡</label>
                                        <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                            <div id="fileList">
                                                <div class="text-muted text-center p-3">
                                                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                                                    <br>ë“œë¼ì´ë¸Œë¥¼ ì„ íƒí•˜ì—¬ íƒìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">ì„ íƒëœ íŒŒì¼</label>
                                        <input type="text" class="form-control" id="selectedFile" readonly 
                                               placeholder="ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”">
                                    </div>
                                    
                                    <div id="fileInfo" class="alert alert-info" style="display: none;">
                                        <h6><i class="fas fa-info-circle me-2"></i>íŒŒì¼ ì •ë³´</h6>
                                        <p class="mb-1"><strong>í¬ê¸°:</strong> <span id="fileSize">-</span></p>
                                        <p class="mb-1"><strong>í˜•ì‹:</strong> <span id="fileFormat">-</span></p>
                                        <p class="mb-0"><strong>ê²½ë¡œ:</strong> <span id="filePath">-</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            </div>
                        </div>
                        
                        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="tab-pane fade" id="file-pane">
                            <div class="mb-3">
                                <label for="videoFile" class="form-label">ë¹„ë””ì˜¤ íŒŒì¼</label>
                                <input type="file" class="form-control" id="videoFile" name="video_file" 
                                       accept=".mp4,.avi,.mov,.mkv,.flv,.webm">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ì§€ì› í˜•ì‹: MP4, AVI, MOV, MKV, FLV, WEBM (ë¡œì»¬ íŒŒì¼ë§Œ)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë¶„ì„ ì˜µì…˜ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ë¶„ì„ ì •ë°€ë„</label>
                            <select class="form-select" id="precision">
                                <option value="normal">ì¼ë°˜ (ë¹ ë¦„)</option>
                                <option value="high" selected>ë†’ìŒ (ê¶Œì¥)</option>
                                <option value="ultra">ë§¤ìš° ë†’ìŒ (ëŠë¦¼)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">í•¸ë“œ ê¸¸ì´ ë¶„ë¥˜</label>
                            <select class="form-select" id="classification">
                                <option value="standard" selected>í‘œì¤€ (5ë‹¨ê³„)</option>
                                <option value="detailed">ìƒì„¸ (10ë‹¨ê³„)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ë¶„ì„ ëª¨ë“œ ì„ íƒ -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="mb-3"><i class="fas fa-brain me-2"></i>ë¶„ì„ ëª¨ë“œ ì„ íƒ</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="analysisMode" id="autoMode" value="auto">
                                    <label class="form-check-label" for="autoMode">
                                        <strong>ğŸ¤– ìë™ ëª¨ë“œ (ê¸°ì¡´)</strong><br>
                                        <small class="text-muted">ì‹œìŠ¤í…œì´ íœ´ë¦¬ìŠ¤í‹±ìœ¼ë¡œ í•¸ë“œë¥¼ ìë™ ê°ì§€</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="analysisMode" id="smartMode" value="smart" checked>
                                    <label class="form-check-label" for="smartMode">
                                        <strong>ğŸ§  ìŠ¤ë§ˆíŠ¸ ëª¨ë“œ (NEW!)</strong><br>
                                        <small class="text-muted">UI ì‹œì‘/ì¢…ë£Œë§Œ ì•Œë ¤ì£¼ë©´ ì‹œìŠ¤í…œì´ í™”ë©´ ìœ„ì¹˜ë¥¼ ìë™ ê°ì§€</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ê¸°ì¡´ ë¶„ì„ ì˜µì…˜ -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-2"><i class="fas fa-cog me-2"></i>ì¶”ê°€ ì˜µì…˜</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fastMode" name="fast_mode">
                            <label class="form-check-label" for="fastMode">
                                <strong>ê³ ì† ë¶„ì„ ëª¨ë“œ</strong> 
                                <span class="text-muted">(10ë¶„ ì˜ìƒì„ 1-2ë¶„ ë‚´ì— ë¶„ì„, ì •í™•ë„ëŠ” ì•½ê°„ ë‚®ìŒ)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary-custom btn-lg">
                            <i class="fas fa-play me-2"></i>
                            ë¶„ì„ ì‹œì‘
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ì§„í–‰ ìƒí™© í‘œì‹œ (ìˆ¨ê¹€) -->
<div id="progressSection" class="mt-4" style="display: none;">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-cog fa-spin me-2"></i>
                        ë¶„ì„ ì§„í–‰ ì¤‘
                    </h5>
                    
                    <div id="progressInfo" class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressMessage">ë¶„ì„ ì¤€ë¹„ ì¤‘...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress progress-custom">
                            <div id="progressBar" class="progress-bar progress-bar-custom" 
                                 style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="videoInfo" style="display: none;" class="alert alert-info alert-custom">
                        <h6><i class="fas fa-video me-2"></i>ì˜ìƒ ì •ë³´</h6>
                        <p class="mb-1"><strong>ì œëª©:</strong> <span id="videoTitle">-</span></p>
                        <p class="mb-1"><strong>ê¸¸ì´:</strong> <span id="videoDuration">-</span></p>
                        <p class="mb-0"><strong>ì²˜ë¦¬ ë°©ì‹:</strong> <span id="processingType">ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„</span></p>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button id="cancelBtn" class="btn btn-outline-danger">
                            <i class="fas fa-stop me-2"></i>
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê¸°ëŠ¥ ì†Œê°œ -->
<div class="row mt-5">
    <div class="col-md-4">
        <div class="card card-custom h-100">
            <div class="card-body text-center">
                <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                <h5>ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„</h5>
                <p>ë‹¤ìš´ë¡œë“œ ì—†ì´ URLì—ì„œ ì§ì ‘ ìŠ¤íŠ¸ë¦¬ë°í•˜ì—¬ ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-custom h-100">
            <div class="card-body text-center">
                <i class="fas fa-chart-pie fa-3x text-success mb-3"></i>
                <h5>ìƒì„¸í•œ í†µê³„</h5>
                <p>í•¸ë“œ ê¸¸ì´ë³„ ë¶„ë¥˜, í‰ê·  ì‹œê°„, ë¶„í¬ë„ ë“± ë‹¤ì–‘í•œ í†µê³„ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-custom h-100">
            <div class="card-body text-center">
                <i class="fas fa-download fa-3x text-info mb-3"></i>
                <h5>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h5>
                <p>ë¶„ì„ ê²°ê³¼ë¥¼ JSON í˜•íƒœë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì¶”ê°€ ë¶„ì„ì— í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;
let progressInterval = null;

document.getElementById('analysisForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const activeTab = document.querySelector('.nav-link.active').id;
    
    // ê³ ì† ëª¨ë“œ ì˜µì…˜ ì¶”ê°€
    const fastMode = document.getElementById('fastMode').checked;
    formData.append('fast_mode', fastMode);
    
    if (activeTab === 'url-tab') {
        const url = document.getElementById('videoUrl').value.trim();
        if (!url) {
            alert('ë¹„ë””ì˜¤ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        formData.append('video_url', url);
        startAnalysis(formData);
        
    } else if (activeTab === 'browse-tab') {
        const selectedFile = document.getElementById('selectedFile').value.trim();
        if (!selectedFile) {
            alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        // ë¡œì»¬ íŒŒì¼ ë¶„ì„ ì‹œì‘
        startLocalFileAnalysis(selectedFile);
        
    } else if (activeTab === 'file-tab') {
        const file = document.getElementById('videoFile').files[0];
        if (!file) {
            alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        formData.append('video_file', file);
        startAnalysis(formData);
    }
});

function startAnalysis(formData) {
    // ìŠ¤ë§ˆíŠ¸ ëª¨ë“œ í™•ì¸
    const smartModeSelected = document.getElementById('smartMode').checked;
    
    if (smartModeSelected) {
        // ìŠ¤ë§ˆíŠ¸ ëª¨ë“œë¡œ ì „í™˜
        startSmartAnalysis(formData);
        return;
    }
    
    // UI ë³€ê²½
    document.getElementById('analysisForm').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    fetch('/analyze', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentTaskId = data.task_id;
        startProgressTracking();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
        resetUI();
    });
}

function startProgressTracking() {
    progressInterval = setInterval(() => {
        fetch(`/progress/${currentTaskId}`)
        .then(response => response.json())
        .then(data => {
            updateProgress(data);
            
            if (data.status === 'completed') {
                clearInterval(progressInterval);
                showResults();
            } else if (data.status === 'error') {
                clearInterval(progressInterval);
                alert('ë¶„ì„ ì‹¤íŒ¨: ' + data.message);
                resetUI();
            }
        })
        .catch(error => {
            console.error('Progress tracking error:', error);
        });
    }, 2000); // 2ì´ˆë§ˆë‹¤ í™•ì¸
}

function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressMessage = document.getElementById('progressMessage');
    
    const progress = data.progress || 0;
    progressBar.style.width = progress + '%';
    progressPercent.textContent = progress + '%';
    progressMessage.textContent = data.message || 'ì²˜ë¦¬ ì¤‘...';
    
    // ë¹„ë””ì˜¤ ì •ë³´ í‘œì‹œ
    if (data.video_info) {
        const videoInfo = document.getElementById('videoInfo');
        const videoTitle = document.getElementById('videoTitle');
        const videoDuration = document.getElementById('videoDuration');
        const processingType = document.getElementById('processingType');
        
        videoTitle.textContent = data.video_info.title;
        videoDuration.textContent = formatDuration(data.video_info.duration);
        
        // ì²˜ë¦¬ ë°©ì‹ í‘œì‹œ
        if (data.video_info.source_type === 'youtube') {
            processingType.textContent = 'YouTube ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„';
        } else if (data.video_info.source_type === 'direct') {
            processingType.textContent = 'ì§ì ‘ URL ìŠ¤íŠ¸ë¦¬ë° ë¶„ì„';
        } else {
            processingType.textContent = 'ë¡œì»¬ íŒŒì¼ ë¶„ì„';
        }
        
        videoInfo.style.display = 'block';
    }
}

function showResults() {
    window.location.href = `/results/${currentTaskId}`;
}

function resetUI() {
    document.getElementById('analysisForm').style.display = 'block';
    document.getElementById('progressSection').style.display = 'none';
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('analysisForm').reset();
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    currentTaskId = null;
}

function formatDuration(seconds) {
    if (!seconds) return '-';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}ì‹œê°„ ${minutes}ë¶„ ${secs}ì´ˆ`;
    } else {
        return `${minutes}ë¶„ ${secs}ì´ˆ`;
    }
}

// ì·¨ì†Œ ë²„íŠ¼
document.getElementById('cancelBtn').addEventListener('click', function() {
    if (confirm('ë¶„ì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        resetUI();
    }
});

// íŒŒì¼ ë¸Œë¼ìš°ì € ê¸°ëŠ¥
let currentDirectory = null;

// ë¡œì»¬ íŒŒì¼ ë¶„ì„ ì‹œì‘
function startLocalFileAnalysis(filePath) {
    // UI ë³€ê²½
    document.getElementById('analysisForm').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    fetch('/analyze-local-file', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_path: filePath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentTaskId = data.task_id;
        startProgressTracking();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
        resetUI();
    });
}

// ë“œë¼ì´ë¸Œ ëª©ë¡ ë¡œë“œ
function loadDrives() {
    fetch('/api/file-browser/drives')
    .then(response => response.json())
    .then(data => {
        const driveSelect = document.getElementById('driveSelect');
        driveSelect.innerHTML = '<option value="">ë“œë¼ì´ë¸Œë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
        
        data.drives.forEach(drive => {
            const option = document.createElement('option');
            option.value = drive.path;
            option.textContent = drive.name;
            driveSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('ë“œë¼ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', error);
    });
}

// ë””ë ‰í† ë¦¬ ë‚´ìš© ë¡œë“œ
function loadDirectory(path) {
    if (!path) return;
    
    fetch(`/api/file-browser/list?path=${encodeURIComponent(path)}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentDirectory = data.current_path;
        document.getElementById('currentPath').value = currentDirectory;
        
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        
        if (data.items.length === 0) {
            fileList.innerHTML = '<div class="text-muted text-center p-3">ë¹ˆ í´ë”ì…ë‹ˆë‹¤</div>';
            return;
        }
        
        data.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'file-item p-2 border-bottom';
            itemDiv.style.cursor = 'pointer';
            
            let icon = '';
            let className = '';
            
            if (item.type === 'parent') {
                icon = 'fas fa-level-up-alt';
                className = 'text-secondary';
            } else if (item.type === 'directory') {
                icon = 'fas fa-folder';
                className = 'text-primary';
            } else if (item.is_video) {
                icon = 'fas fa-video';
                className = 'text-success';
            } else {
                icon = 'fas fa-file';
                className = 'text-muted';
            }
            
            const sizeText = item.type === 'file' ? formatFileSize(item.size) : '';
            
            itemDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="${icon} me-2 ${className}"></i>
                    <span class="flex-grow-1">${item.name}</span>
                    ${sizeText ? `<small class="text-muted">${sizeText}</small>` : ''}
                </div>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸
            itemDiv.addEventListener('click', function() {
                if (item.type === 'directory' || item.type === 'parent') {
                    loadDirectory(item.path);
                } else if (item.is_video) {
                    selectFile(item.path);
                }
            });
            
            // ë¹„ë””ì˜¤ íŒŒì¼ì¸ ê²½ìš° í•˜ì´ë¼ì´íŠ¸
            if (item.is_video) {
                itemDiv.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#e8f5e8';
                });
                itemDiv.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            }
            
            fileList.appendChild(itemDiv);
        });
    })
    .catch(error => {
        console.error('ë””ë ‰í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('fileList').innerHTML = 
            `<div class="text-danger text-center p-3">ì˜¤ë¥˜: ${error.message}</div>`;
    });
}

// íŒŒì¼ ì„ íƒ
function selectFile(filePath) {
    document.getElementById('selectedFile').value = filePath;
    
    // íŒŒì¼ ì •ë³´ ë¡œë“œ
    fetch(`/api/file-browser/file-info?path=${encodeURIComponent(filePath)}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        document.getElementById('fileSize').textContent = formatFileSize(data.size);
        document.getElementById('fileFormat').textContent = data.extension.toUpperCase();
        document.getElementById('filePath').textContent = data.path;
        document.getElementById('fileInfo').style.display = 'block';
    })
    .catch(error => {
        console.error('íŒŒì¼ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('fileInfo').style.display = 'none';
    });
}

// íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    
    return `${size.toFixed(1)} ${units[unitIndex]}`;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.getElementById('driveSelect').addEventListener('change', function() {
    const selectedDrive = this.value;
    if (selectedDrive) {
        loadDirectory(selectedDrive);
    }
});

document.getElementById('parentDirBtn').addEventListener('click', function() {
    if (currentDirectory) {
        const parentPath = currentDirectory.split(/[\/\\]/).slice(0, -1).join('/') || '/';
        loadDirectory(parentPath);
    }
});

document.getElementById('refreshBtn').addEventListener('click', function() {
    if (currentDirectory) {
        loadDirectory(currentDirectory);
    }
});

// íƒ­ ë³€ê²½ì‹œ ë“œë¼ì´ë¸Œ ë¡œë“œ
document.getElementById('browse-tab').addEventListener('shown.bs.tab', function() {
    loadDrives();
});

// ============================================
// ìŠ¤ë§ˆíŠ¸ ëª¨ë“œ ê¸°ëŠ¥
// ============================================

let smartUIDetector = null;
let smartVideoFile = null;

// ìŠ¤ë§ˆíŠ¸ ë¶„ì„ ì‹œì‘
function startSmartAnalysis(formData) {
    // ë¹„ë””ì˜¤ íŒŒì¼ ì¶”ì¶œ
    for (let [key, value] of formData.entries()) {
        if (key === 'video_file' && value instanceof File) {
            smartVideoFile = value;
            break;
        }
    }
    
    if (!smartVideoFile) {
        alert('ìŠ¤ë§ˆíŠ¸ ëª¨ë“œëŠ” í˜„ì¬ íŒŒì¼ ì—…ë¡œë“œë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
        return;
    }
    
    // UI ë³€ê²½
    document.getElementById('analysisForm').style.display = 'none';
    showSmartInterface();
}

// ìŠ¤ë§ˆíŠ¸ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
function showSmartInterface() {
    const progressSection = document.getElementById('progressSection');
    progressSection.style.display = 'block';
    
    // ê¸°ì¡´ progress ë‚´ìš©ì„ ìŠ¤ë§ˆíŠ¸ ì¸í„°í˜ì´ìŠ¤ë¡œ êµì²´
    progressSection.innerHTML = `
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card card-custom">
                    <div class="card-body">
                        <h3 class="text-center mb-4">ğŸ§  ìŠ¤ë§ˆíŠ¸ UI ê°ì§€ ëª¨ë“œ</h3>
                        <p class="text-center text-muted mb-4">UIê°€ ë‚˜íƒ€ë‚˜ë©´ "UI ê°ì§€ ì‹œì‘", ì‚¬ë¼ì§€ë©´ "UI ê°ì§€ ì¢…ë£Œ"ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
                        
                        <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ -->
                        <div class="text-center mb-4" style="position: relative;">
                            <div style="position: relative; display: inline-block; max-width: 800px;">
                                <video id="smartVideoPlayer" controls 
                                       style="width: 100%; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                                </video>
                                <canvas id="analysisOverlay" 
                                        style="position: absolute; top: 0; left: 0; pointer-events: none; border-radius: 10px;">
                                </canvas>
                            </div>
                            
                            <!-- ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë¡¤ -->
                            <div style="margin: 20px 0;">
                                <button id="smartDetectBtn" onclick="toggleSmartDetection()" 
                                        class="btn btn-danger btn-lg" style="min-width: 200px;">
                                    ğŸ” UI ê°ì§€ ì‹œì‘
                                </button>
                            </div>
                        </div>
                        
                        <!-- ë¶„ì„ ê²°ê³¼ -->
                        <div class="row">
                            <div class="col-md-6">
                                <h5>ğŸ“Š í™”ë©´ ì˜ì—­ ë¶„ì„</h5>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                                    <div class="detection-cell" id="smart-cell-0" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ì¢Œìƒë‹¨<br><span id="smart-score-0">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-1" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ìƒë‹¨<br><span id="smart-score-1">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-2" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ìš°ìƒë‹¨<br><span id="smart-score-2">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-3" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ì¢Œì¸¡<br><span id="smart-score-3">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-4" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ì¤‘ì•™<br><span id="smart-score-4">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-5" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ìš°ì¸¡<br><span id="smart-score-5">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-6" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ì¢Œí•˜ë‹¨<br><span id="smart-score-6">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-7" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">í•˜ë‹¨<br><span id="smart-score-7">0%</span></div>
                                    <div class="detection-cell" id="smart-cell-8" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; font-size: 12px;">ìš°í•˜ë‹¨<br><span id="smart-score-8">0%</span></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>ğŸ¯ ê°ì§€ ìƒíƒœ</h5>
                                <div id="smartStatus" class="alert alert-info">
                                    ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•˜ê³  UIê°€ ë‚˜íƒ€ë‚˜ë©´ "UI ê°ì§€ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                                </div>
                                
                                <h5>ğŸ“ í•™ìŠµëœ UI íŒ¨í„´</h5>
                                <div id="learnedUIPatterns" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                                    ì•„ì§ í•™ìŠµëœ íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤
                                </div>
                            </div>
                        </div>
                        
                        <!-- ê²°ê³¼ ì„¹ì…˜ -->
                        <div id="smartResults" style="display: none; margin-top: 30px;">
                            <h4>ğŸ¯ ë¶„ì„ ê²°ê³¼</h4>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h3 class="text-primary" id="smartTotalUI">0</h3>
                                            <p>ê°ì§€ëœ UI</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h3 class="text-success" id="smartPredictedHands">0</h3>
                                            <p>ì˜ˆì¸¡ í•¸ë“œ ìˆ˜</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h3 class="text-info" id="smartAccuracy">95</h3>
                                            <p>ì˜ˆìƒ ì •í™•ë„(%)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button class="btn btn-success" onclick="exportSmartResults()">
                                    ğŸ“¥ ìŠ¤ë§ˆíŠ¸ ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="resetSmartUI()">
                                    ğŸ”™ ë‹¤ì‹œ ì‹œì‘
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ë¹„ë””ì˜¤ ì„¤ì •
    const smartVideoPlayer = document.getElementById('smartVideoPlayer');
    smartVideoPlayer.src = URL.createObjectURL(smartVideoFile);
    
    // ìŠ¤ë§ˆíŠ¸ ê°ì§€ê¸° ì´ˆê¸°í™”
    smartVideoPlayer.addEventListener('loadedmetadata', () => {
        const overlay = document.getElementById('analysisOverlay');
        overlay.width = smartVideoPlayer.videoWidth;
        overlay.height = smartVideoPlayer.videoHeight;
        
        smartUIDetector = new SmartUIDetector(smartVideoPlayer, overlay);
    });
}

// ìŠ¤ë§ˆíŠ¸ UI ê°ì§€ê¸° í´ë˜ìŠ¤
class SmartUIDetector {
    constructor(video, canvas) {
        this.video = video;
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.isDetecting = false;
        this.detectionStart = null;
        this.frameAnalysisInterval = null;
        this.uiPatterns = [];
        this.tempCanvas = document.createElement('canvas');
        this.tempCtx = this.tempCanvas.getContext('2d');
    }
    
    startDetection() {
        this.isDetecting = true;
        this.detectionStart = this.video.currentTime;
        
        // ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘
        this.frameAnalysisInterval = setInterval(() => {
            this.analyzeFrame();
        }, 200); // 0.2ì´ˆë§ˆë‹¤
        
        updateSmartStatus('ğŸ”„ UI ê°ì§€ ì¤‘... í™”ë©´ì„ 9ê°œ ì˜ì—­ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
    }
    
    stopDetection() {
        if (!this.isDetecting) return;
        
        this.isDetecting = false;
        clearInterval(this.frameAnalysisInterval);
        
        const detectionEnd = this.video.currentTime;
        const duration = detectionEnd - this.detectionStart;
        
        if (duration >= 3) {
            this.learnUIPattern(this.detectionStart, detectionEnd);
            updateSmartStatus('âœ… UI íŒ¨í„´ í•™ìŠµ ì™„ë£Œ: ' + formatTime(this.detectionStart) + ' - ' + formatTime(detectionEnd) + ' (' + Math.floor(duration) + 'ì´ˆ)');
            this.updateResults();
        } else {
            updateSmartStatus('âš ï¸ ê°ì§€ ì‹œê°„ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ (ìµœì†Œ 3ì´ˆ ì´ìƒ)');
        }
        
        this.resetGrid();
    }
    
    analyzeFrame() {
        if (!this.isDetecting || this.video.paused) return;
        
        // ë¹„ë””ì˜¤ë¥¼ ì„ì‹œ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
        this.tempCanvas.width = this.video.videoWidth;
        this.tempCanvas.height = this.video.videoHeight;
        this.tempCtx.drawImage(this.video, 0, 0);
        
        const imageData = this.tempCtx.getImageData(0, 0, this.tempCanvas.width, this.tempCanvas.height);
        const regionScores = this.analyzeRegions(imageData);
        
        this.updateDetectionGrid(regionScores);
        this.drawAnalysisOverlay(regionScores);
    }
    
    analyzeRegions(imageData) {
        const regions = [];
        const width = imageData.width;
        const height = imageData.height;
        const data = imageData.data;
        
        // 3x3 ê·¸ë¦¬ë“œë¡œ ë‚˜ëˆ„ê¸°
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 3; col++) {
                const startX = Math.floor(col * width / 3);
                const endX = Math.floor((col + 1) * width / 3);
                const startY = Math.floor(row * height / 3);
                const endY = Math.floor((row + 1) * height / 3);
                
                const regionScore = this.analyzeRegion(data, width, startX, endX, startY, endY);
                regions.push(regionScore);
            }
        }
        
        return regions;
    }
    
    analyzeRegion(data, width, startX, endX, startY, endY) {
        let totalPixels = 0;
        let edgePixels = 0;
        let colorCounts = {};
        
        for (let y = startY; y < endY; y++) {
            for (let x = startX; x < endX; x++) {
                const idx = (y * width + x) * 4;
                const r = data[idx];
                const g = data[idx + 1];
                const b = data[idx + 2];
                
                totalPixels++;
                
                // ìƒ‰ìƒ ê·¸ë£¹í™”
                const colorKey = Math.floor(r/64)*64 + ',' + Math.floor(g/64)*64 + ',' + Math.floor(b/64)*64;
                colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
                
                // ê°„ë‹¨í•œ ì—£ì§€ ê°ì§€
                if (x > startX && y > startY) {
                    const prevIdx = ((y-1) * width + (x-1)) * 4;
                    const diff = Math.abs(r - data[prevIdx]) + Math.abs(g - data[prevIdx + 1]) + Math.abs(b - data[prevIdx + 2]);
                    if (diff > 60) edgePixels++;
                }
            }
        }
        
        // UI íŠ¹ì„± ê³„ì‚°
        const maxColorCount = Math.max(...Object.values(colorCounts));
        const uniformityScore = maxColorCount / totalPixels;
        const edgeScore = edgePixels / totalPixels;
        
        // UI ì ìˆ˜ (ê· ì¼ë„ê°€ ë†’ê³  ì—£ì§€ê°€ ë§ìœ¼ë©´ UI ê°€ëŠ¥ì„± ë†’ìŒ)
        const uiScore = (uniformityScore * 0.7 + edgeScore * 0.3) * 100;
        return Math.min(uiScore, 100);
    }
    
    updateDetectionGrid(scores) {
        scores.forEach((score, idx) => {
            const cell = document.getElementById('smart-cell-' + idx);
            const scoreSpan = document.getElementById('smart-score-' + idx);
            
            if (cell && scoreSpan) {
                scoreSpan.textContent = Math.floor(score) + '%';
                
                if (score > 50) {
                    cell.style.borderColor = '#dc3545';
                    cell.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
                } else {
                    cell.style.borderColor = 'transparent';
                    cell.style.backgroundColor = '#f8f9fa';
                }
            }
        });
    }
    
    drawAnalysisOverlay(scores) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const cellWidth = this.canvas.width / 3;
        const cellHeight = this.canvas.height / 3;
        
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 3; col++) {
                const idx = row * 3 + col;
                const score = scores[idx];
                
                const x = col * cellWidth;
                const y = row * cellHeight;
                
                // ê·¸ë¦¬ë“œ ë¼ì¸
                this.ctx.strokeStyle = '#ffc107';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(x, y, cellWidth, cellHeight);
                
                // UI ê°ì§€ ì‹œ ê°•ì¡°
                if (score > 50) {
                    this.ctx.fillStyle = 'rgba(220, 53, 69, 0.3)';
                    this.ctx.fillRect(x, y, cellWidth, cellHeight);
                }
                
                // ì ìˆ˜ í‘œì‹œ
                this.ctx.fillStyle = '#fff';
                this.ctx.font = '16px Arial';
                this.ctx.fillText(Math.floor(score) + '%', x + 5, y + 20);
            }
        }
    }
    
    learnUIPattern(startTime, endTime) {
        const pattern = {
            id: Date.now(),
            startTime: startTime,
            endTime: endTime,
            duration: endTime - startTime,
            confidence: 0.9
        };
        
        this.uiPatterns.push(pattern);
        this.updateLearnedPatterns();
    }
    
    updateLearnedPatterns() {
        const container = document.getElementById('learnedUIPatterns');
        if (!container) return;
        
        if (this.uiPatterns.length === 0) {
            container.innerHTML = 'ì•„ì§ í•™ìŠµëœ íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤';
            return;
        }
        
        container.innerHTML = this.uiPatterns.map((pattern, idx) => 
            '<div style="background: #e9ecef; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 12px;">' +
                '<strong>íŒ¨í„´ ' + (idx + 1) + ':</strong> ' + formatTime(pattern.startTime) + ' - ' + formatTime(pattern.endTime) + '<br>' +
                '<small>ê¸¸ì´: ' + Math.floor(pattern.duration) + 'ì´ˆ, ì‹ ë¢°ë„: ' + Math.floor(pattern.confidence * 100) + '%</small>' +
            '</div>'
        ).join('');
    }
    
    updateResults() {
        document.getElementById('smartResults').style.display = 'block';
        document.getElementById('smartTotalUI').textContent = this.uiPatterns.length;
        
        // 15ì´ˆ ì´ìƒ UIë¡œ í•¸ë“œ ê²½ê³„ ì˜ˆì¸¡
        const longUIPatterns = this.uiPatterns.filter(p => p.duration >= 15);
        document.getElementById('smartPredictedHands').textContent = longUIPatterns.length;
    }
    
    resetGrid() {
        for (let i = 0; i < 9; i++) {
            const cell = document.getElementById('smart-cell-' + i);
            const score = document.getElementById('smart-score-' + i);
            if (cell) {
                cell.style.borderColor = 'transparent';
                cell.style.backgroundColor = '#f8f9fa';
            }
            if (score) score.textContent = '0%';
        }
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

// ìŠ¤ë§ˆíŠ¸ ê°ì§€ í† ê¸€
function toggleSmartDetection() {
    if (!smartUIDetector) return;
    
    const button = document.getElementById('smartDetectBtn');
    
    if (!smartUIDetector.isDetecting) {
        smartUIDetector.startDetection();
        button.innerHTML = 'ğŸ›‘ UI ê°ì§€ ì¢…ë£Œ';
        button.className = 'btn btn-warning btn-lg';
    } else {
        smartUIDetector.stopDetection();
        button.innerHTML = 'ğŸ” UI ê°ì§€ ì‹œì‘';
        button.className = 'btn btn-danger btn-lg';
    }
}

// ìŠ¤ë§ˆíŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSmartStatus(message) {
    const status = document.getElementById('smartStatus');
    if (status) {
        status.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + message;
    }
}

// ìŠ¤ë§ˆíŠ¸ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
function exportSmartResults() {
    if (!smartUIDetector || smartUIDetector.uiPatterns.length === 0) {
        alert('í•™ìŠµëœ UI íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const results = {
        analysis_type: 'smart_ui_detection',
        video_duration: document.getElementById('smartVideoPlayer').duration,
        ui_patterns: smartUIDetector.uiPatterns,
        predicted_hands: smartUIDetector.uiPatterns.filter(p => p.duration >= 15).map(p => ({
            estimated_start: Math.max(0, p.startTime - 15),
            estimated_end: p.endTime + 15,
            confidence: p.confidence,
            source_ui: p
        })),
        created_at: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(results, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', 'smart_ui_analysis.json');
    linkElement.click();
    
    updateSmartStatus('âœ… ìŠ¤ë§ˆíŠ¸ ë¶„ì„ ê²°ê³¼ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ìŠ¤ë§ˆíŠ¸ UI ë¦¬ì…‹
function resetSmartUI() {
    if (confirm('ìŠ¤ë§ˆíŠ¸ ë¶„ì„ì„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        resetUI();
    }
}

// ì‹œê°„ í¬ë§· í•¨ìˆ˜ ì¶”ê°€
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + secs.toString().padStart(2, '0');
}

</script>
{% endblock %}