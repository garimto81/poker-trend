<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì»¤ í•¸ë“œ ë¶„ë¥˜ê¸° - RFID GFX ê¸°ë°˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        #videoCanvas {
            max-width: 100%;
            border: 2px solid #30363d;
            border-radius: 6px;
        }
        .timeline {
            height: 60px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            position: relative;
            margin: 20px 0;
            cursor: pointer;
        }
        .hand-segment {
            position: absolute;
            height: 100%;
            background: #238636;
            opacity: 0.6;
            border-radius: 3px;
        }
        .gfx-segment {
            position: absolute;
            height: 50%;
            top: 25%;
            background: #f85149;
            opacity: 0.8;
            border-radius: 3px;
        }
        .stats-box {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .detection-log {
            max-height: 200px;
            overflow-y: auto;
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .progress {
            height: 25px;
            background-color: #0d1117;
        }
        .alert-info {
            background-color: #1f6feb;
            border-color: #1f6feb;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">ğŸƒ í¬ì»¤ í•¸ë“œ ë¶„ë¥˜ê¸°</span>
            <a href="index.html" class="btn btn-outline-light btn-sm">ë©”ì¸ìœ¼ë¡œ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ë¹„ë””ì˜¤ ë¶„ì„</h5>
                        
                        <!-- ë¹„ë””ì˜¤ ì—…ë¡œë“œ -->
                        <div class="mb-3">
                            <input type="file" class="form-control" id="videoInput" accept="video/*">
                        </div>
                        
                        <!-- ë¹„ë””ì˜¤ ìº”ë²„ìŠ¤ -->
                        <canvas id="videoCanvas" width="800" height="450"></canvas>
                        
                        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-primary" id="analyzeBtn" disabled>
                                <i class="bi bi-play-fill"></i> ë¶„ì„ ì‹œì‘
                            </button>
                            <button class="btn btn-secondary" id="pauseBtn" disabled>
                                <i class="bi bi-pause-fill"></i> ì¼ì‹œì •ì§€
                            </button>
                            <button class="btn btn-success" id="loadModelBtn">
                                <i class="bi bi-download"></i> GFX ëª¨ë¸ ë¡œë“œ
                            </button>
                        </div>
                        
                        <!-- ì§„í–‰ë¥  -->
                        <div class="progress mt-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" style="width: 0%">0%</div>
                        </div>
                        
                        <!-- íƒ€ì„ë¼ì¸ -->
                        <div class="timeline" id="timeline">
                            <!-- í•¸ë“œ ì„¸ê·¸ë¨¼íŠ¸ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- ë¶„ì„ í†µê³„ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">ë¶„ì„ í†µê³„</h5>
                        <div class="stats-box">
                            <div class="d-flex justify-content-between mb-2">
                                <span>ì´ í”„ë ˆì„:</span>
                                <span id="totalFrames">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>ë¶„ì„ëœ í”„ë ˆì„:</span>
                                <span id="analyzedFrames">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>ê°ì§€ëœ í•¸ë“œ:</span>
                                <span id="detectedHands">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>GFX ê°ì§€ìœ¨:</span>
                                <span id="gfxDetectionRate">0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>í‰ê·  í•¸ë“œ ê¸¸ì´:</span>
                                <span id="avgHandLength">0ì´ˆ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ê°ì§€ ë¡œê·¸ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ê°ì§€ ë¡œê·¸</h5>
                        <div class="detection-log" id="detectionLog"></div>
                    </div>
                </div>
                
                <!-- ê²°ê³¼ ë‹¤ìš´ë¡œë“œ -->
                <div class="mt-3">
                    <button class="btn btn-success w-100" id="downloadBtn" disabled>
                        <i class="bi bi-download"></i> ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (JSON)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- í•¸ë“œ ëª©ë¡ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ê°ì§€ëœ í•¸ë“œ ëª©ë¡</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>ì‹œì‘ ì‹œê°„</th>
                                        <th>ì¢…ë£Œ ì‹œê°„</th>
                                        <th>ê¸¸ì´</th>
                                        <th>GFX ì‹œì‘</th>
                                        <th>GFX ì¢…ë£Œ</th>
                                        <th>ì‹ ë¢°ë„</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="handsTableBody">
                                    <!-- í•¸ë“œ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let video = null;
        let canvas = null;
        let ctx = null;
        let isAnalyzing = false;
        let gfxModel = null;
        let hands = [];
        let currentGFX = null;
        let frameCount = 0;
        let analyzedCount = 0;
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
            document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
            document.getElementById('pauseBtn').addEventListener('click', pauseAnalysis);
            document.getElementById('loadModelBtn').addEventListener('click', loadGFXModel);
            document.getElementById('downloadBtn').addEventListener('click', downloadResults);
        });
        
        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.addEventListener('loadedmetadata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                document.getElementById('analyzeBtn').disabled = false;
                
                // ì²« í”„ë ˆì„ í‘œì‹œ
                video.currentTime = 0;
                video.addEventListener('seeked', () => {
                    ctx.drawImage(video, 0, 0);
                }, { once: true });
                
                logMessage(`ë¹„ë””ì˜¤ ë¡œë“œë¨: ${video.duration.toFixed(1)}ì´ˆ, ${video.videoWidth}x${video.videoHeight}`);
            });
        }
        
        // GFX ëª¨ë¸ ë¡œë“œ (ì‹¤ì œë¡œëŠ” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í•™ìŠµëœ íŒ¨í„´ ë¡œë“œ)
        function loadGFXModel() {
            const savedModel = localStorage.getItem('gfxModel');
            if (savedModel) {
                gfxModel = JSON.parse(savedModel);
                logMessage('GFX ëª¨ë¸ ë¡œë“œ ì™„ë£Œ');
                alert('í•™ìŠµëœ GFX ëª¨ë¸ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
            } else {
                logMessage('ì €ì¥ëœ GFX ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. GFX í•™ìŠµê¸°ì—ì„œ ë¨¼ì € í•™ìŠµí•´ì£¼ì„¸ìš”.');
                alert('ë¨¼ì € GFX ì˜¤ë²„ë ˆì´ í•™ìŠµê¸°ì—ì„œ ëª¨ë¸ì„ í•™ìŠµì‹œì¼œì£¼ì„¸ìš”.');
            }
        }
        
        // ë¶„ì„ ì‹œì‘
        async function startAnalysis() {
            if (!video) return;
            
            isAnalyzing = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            
            hands = [];
            currentGFX = null;
            frameCount = 0;
            analyzedCount = 0;
            
            logMessage('ë¶„ì„ ì‹œì‘...');
            
            // í”„ë ˆì„ë³„ ë¶„ì„
            const fps = 30; // ê°€ì •
            const frameInterval = 1 / fps;
            let currentTime = 0;
            
            while (currentTime < video.duration && isAnalyzing) {
                video.currentTime = currentTime;
                await new Promise(resolve => {
                    video.addEventListener('seeked', resolve, { once: true });
                });
                
                // í”„ë ˆì„ ë¶„ì„
                analyzeFrame(currentTime);
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateProgress(currentTime / video.duration * 100);
                
                // ë‹¤ìŒ í”„ë ˆì„
                currentTime += frameInterval;
                frameCount++;
                
                // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—°
                if (frameCount % 30 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            if (isAnalyzing) {
                completeAnalysis();
            }
        }
        
        // í”„ë ˆì„ ë¶„ì„
        function analyzeFrame(timestamp) {
            ctx.drawImage(video, 0, 0);
            
            const isGFX = detectGFXOverlay();
            
            if (isGFX && !currentGFX) {
                // GFX ì‹œì‘
                currentGFX = {
                    startTime: timestamp,
                    endTime: null
                };
                logMessage(`GFX ì‹œì‘: ${formatTime(timestamp)}`);
            } else if (!isGFX && currentGFX && !currentGFX.endTime) {
                // GFX ì¢…ë£Œ
                currentGFX.endTime = timestamp;
                
                // í•¸ë“œ ìƒì„± (15ì´ˆ ê·œì¹™ ì ìš©)
                const hand = {
                    id: hands.length + 1,
                    startTime: Math.max(0, currentGFX.startTime - 15),
                    endTime: currentGFX.endTime + 15,
                    gfxStart: currentGFX.startTime,
                    gfxEnd: currentGFX.endTime,
                    confidence: 0.95
                };
                
                hands.push(hand);
                logMessage(`í•¸ë“œ ${hand.id} ê°ì§€: ${formatTime(hand.startTime)} - ${formatTime(hand.endTime)}`);
                updateHandsList();
                
                currentGFX = null;
            }
            
            analyzedCount++;
            updateStats();
        }
        
        // GFX ì˜¤ë²„ë ˆì´ ê°ì§€ (ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)
        function detectGFXOverlay() {
            if (!gfxModel) {
                // ëª¨ë¸ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ íœ´ë¦¬ìŠ¤í‹± ì‚¬ìš©
                return detectGFXHeuristic();
            }
            
            // í•™ìŠµëœ ëª¨ë¸ ì‚¬ìš©
            const features = extractFeatures();
            return matchWithModel(features);
        }
        
        // ê¸°ë³¸ íœ´ë¦¬ìŠ¤í‹± GFX ê°ì§€
        function detectGFXHeuristic() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±: íŠ¹ì • ì˜ì—­ì˜ ìƒ‰ìƒ ê· ì¼ë„ ì²´í¬
            let uniformityScore = calculateColorUniformity(data);
            let textDensity = estimateTextDensity(data);
            
            return uniformityScore > 0.7 && textDensity > 0.3;
        }
        
        // ìƒ‰ìƒ ê· ì¼ë„ ê³„ì‚°
        function calculateColorUniformity(data) {
            const colorMap = {};
            const sampleRate = 100; // 100í”½ì…€ë§ˆë‹¤ ìƒ˜í”Œë§
            
            for (let i = 0; i < data.length; i += sampleRate * 4) {
                const r = Math.floor(data[i] / 32) * 32;
                const g = Math.floor(data[i + 1] / 32) * 32;
                const b = Math.floor(data[i + 2] / 32) * 32;
                const color = `${r},${g},${b}`;
                
                colorMap[color] = (colorMap[color] || 0) + 1;
            }
            
            const colors = Object.values(colorMap).sort((a, b) => b - a);
            const top5 = colors.slice(0, 5).reduce((a, b) => a + b, 0);
            const total = colors.reduce((a, b) => a + b, 0);
            
            return top5 / total;
        }
        
        // í…ìŠ¤íŠ¸ ë°€ë„ ì¶”ì •
        function estimateTextDensity(data) {
            // ê°„ë‹¨í•œ ì—£ì§€ ê°ì§€ë¡œ í…ìŠ¤íŠ¸ ì˜ì—­ ì¶”ì •
            let edgeCount = 0;
            const threshold = 30;
            
            for (let i = 0; i < data.length - 4; i += 4) {
                const diff = Math.abs(data[i] - data[i + 4]);
                if (diff > threshold) edgeCount++;
            }
            
            return Math.min(edgeCount / (data.length / 4), 1);
        }
        
        // íŠ¹ì§• ì¶”ì¶œ
        function extractFeatures() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return {
                colorUniformity: calculateColorUniformity(imageData.data),
                textDensity: estimateTextDensity(imageData.data),
                timestamp: video.currentTime
            };
        }
        
        // ëª¨ë¸ê³¼ ë§¤ì¹­
        function matchWithModel(features) {
            if (!gfxModel || !gfxModel.patterns) return false;
            
            for (const pattern of gfxModel.patterns) {
                const colorDiff = Math.abs(features.colorUniformity - pattern.colorUniformity);
                const textDiff = Math.abs(features.textDensity - pattern.textDensity);
                
                if (colorDiff < 0.1 && textDiff < 0.1) {
                    return true;
                }
            }
            
            return false;
        }
        
        // ë¶„ì„ ì¼ì‹œì •ì§€
        function pauseAnalysis() {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            logMessage('ë¶„ì„ ì¼ì‹œì •ì§€');
        }
        
        // ë¶„ì„ ì™„ë£Œ
        function completeAnalysis() {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = false;
            
            logMessage(`ë¶„ì„ ì™„ë£Œ: ${hands.length}ê°œ í•¸ë“œ ê°ì§€`);
            updateTimeline();
        }
        
        // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        function updateTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            const duration = video.duration;
            
            hands.forEach(hand => {
                // í•¸ë“œ ì„¸ê·¸ë¨¼íŠ¸
                const handSegment = document.createElement('div');
                handSegment.className = 'hand-segment';
                handSegment.style.left = `${(hand.startTime / duration) * 100}%`;
                handSegment.style.width = `${((hand.endTime - hand.startTime) / duration) * 100}%`;
                handSegment.title = `í•¸ë“œ ${hand.id}: ${formatTime(hand.startTime)} - ${formatTime(hand.endTime)}`;
                
                // GFX ì„¸ê·¸ë¨¼íŠ¸
                const gfxSegment = document.createElement('div');
                gfxSegment.className = 'gfx-segment';
                gfxSegment.style.left = `${(hand.gfxStart / duration) * 100}%`;
                gfxSegment.style.width = `${((hand.gfxEnd - hand.gfxStart) / duration) * 100}%`;
                gfxSegment.title = `GFX: ${formatTime(hand.gfxStart)} - ${formatTime(hand.gfxEnd)}`;
                
                timeline.appendChild(handSegment);
                timeline.appendChild(gfxSegment);
            });
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('totalFrames').textContent = frameCount;
            document.getElementById('analyzedFrames').textContent = analyzedCount;
            document.getElementById('detectedHands').textContent = hands.length;
            
            const gfxFrames = hands.reduce((sum, hand) => {
                return sum + (hand.gfxEnd - hand.gfxStart) * 30; // 30fps ê°€ì •
            }, 0);
            
            const gfxRate = analyzedCount > 0 ? (gfxFrames / analyzedCount * 100).toFixed(1) : 0;
            document.getElementById('gfxDetectionRate').textContent = `${gfxRate}%`;
            
            if (hands.length > 0) {
                const avgLength = hands.reduce((sum, hand) => sum + (hand.endTime - hand.startTime), 0) / hands.length;
                document.getElementById('avgHandLength').textContent = `${avgLength.toFixed(1)}ì´ˆ`;
            }
        }
        
        // í•¸ë“œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateHandsList() {
            const tbody = document.getElementById('handsTableBody');
            tbody.innerHTML = '';
            
            hands.forEach(hand => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${hand.id}</td>
                    <td>${formatTime(hand.startTime)}</td>
                    <td>${formatTime(hand.endTime)}</td>
                    <td>${(hand.endTime - hand.startTime).toFixed(1)}ì´ˆ</td>
                    <td>${formatTime(hand.gfxStart)}</td>
                    <td>${formatTime(hand.gfxEnd)}</td>
                    <td>${(hand.confidence * 100).toFixed(0)}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="jumpToHand(${hand.startTime})">
                            ì´ë™
                        </button>
                    </td>
                `;
            });
        }
        
        // íŠ¹ì • í•¸ë“œë¡œ ì´ë™
        function jumpToHand(time) {
            if (video) {
                video.currentTime = time;
                video.addEventListener('seeked', () => {
                    ctx.drawImage(video, 0, 0);
                }, { once: true });
            }
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent.toFixed(0)}%`;
        }
        
        // ë¡œê·¸ ë©”ì‹œì§€
        function logMessage(message) {
            const log = document.getElementById('detectionLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins}:${secs.padStart(4, '0')}`;
        }
        
        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadResults() {
            const results = {
                videoInfo: {
                    duration: video.duration,
                    width: video.videoWidth,
                    height: video.videoHeight,
                    analyzedFrames: analyzedCount
                },
                hands: hands.map(hand => ({
                    id: hand.id,
                    startTime: hand.startTime,
                    endTime: hand.endTime,
                    duration: hand.endTime - hand.startTime,
                    gfxStart: hand.gfxStart,
                    gfxEnd: hand.gfxEnd,
                    confidence: hand.confidence
                })),
                summary: {
                    totalHands: hands.length,
                    totalDuration: hands.reduce((sum, h) => sum + (h.endTime - h.startTime), 0),
                    averageHandLength: hands.length > 0 ? 
                        hands.reduce((sum, h) => sum + (h.endTime - h.startTime), 0) / hands.length : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poker_hands_analysis_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logMessage('ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œë¨');
        }
    </script>
</body>
</html>