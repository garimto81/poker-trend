<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìè¨Ïª§ Ìï∏Îìú Î∂ÑÎ•òÍ∏∞ - RFID GFX Í∏∞Î∞ò</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        #videoCanvas {
            max-width: 100%;
            border: 2px solid #30363d;
            border-radius: 6px;
        }
        .timeline {
            height: 60px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            position: relative;
            margin: 20px 0;
            cursor: pointer;
        }
        .hand-segment {
            position: absolute;
            height: 100%;
            background: #238636;
            opacity: 0.6;
            border-radius: 3px;
        }
        .gfx-segment {
            position: absolute;
            height: 50%;
            top: 25%;
            background: #f85149;
            opacity: 0.8;
            border-radius: 3px;
        }
        .stats-box {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .detection-log {
            max-height: 200px;
            overflow-y: auto;
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .progress {
            height: 25px;
            background-color: #0d1117;
        }
        .alert-info {
            background-color: #1f6feb;
            border-color: #1f6feb;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üÉè Ìè¨Ïª§ Ìï∏Îìú Î∂ÑÎ•òÍ∏∞</span>
            <a href="index.html" class="btn btn-outline-light btn-sm">Î©îÏù∏ÏúºÎ°ú</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ÎπÑÎîîÏò§ Î∂ÑÏÑù</h5>
                        
                        <!-- ÎπÑÎîîÏò§ ÏóÖÎ°úÎìú -->
                        <div class="mb-3">
                            <input type="file" class="form-control" id="videoInput" accept="video/*">
                        </div>
                        
                        <!-- ÎπÑÎîîÏò§ Ï∫îÎ≤ÑÏä§ -->
                        <canvas id="videoCanvas" width="800" height="450"></canvas>
                        
                        <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäº -->
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-primary" id="analyzeBtn" disabled>
                                <i class="bi bi-play-fill"></i> Î∂ÑÏÑù ÏãúÏûë
                            </button>
                            <button class="btn btn-secondary" id="pauseBtn" disabled>
                                <i class="bi bi-pause-fill"></i> ÏùºÏãúÏ†ïÏßÄ
                            </button>
                            <button class="btn btn-success" id="loadModelBtn">
                                <i class="bi bi-download"></i> GFX Î™®Îç∏ Î°úÎìú
                            </button>
                        </div>
                        
                        <!-- ÏßÑÌñâÎ•† -->
                        <div class="progress mt-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" style="width: 0%">0%</div>
                        </div>
                        
                        <!-- ÌÉÄÏûÑÎùºÏù∏ -->
                        <div class="timeline" id="timeline">
                            <!-- Ìï∏Îìú ÏÑ∏Í∑∏Î®ºÌä∏Í∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Î∂ÑÏÑù ÌÜµÍ≥Ñ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Î∂ÑÏÑù ÌÜµÍ≥Ñ</h5>
                        <div class="stats-box">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Ï¥ù ÌîÑÎ†àÏûÑ:</span>
                                <span id="totalFrames">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Î∂ÑÏÑùÎêú ÌîÑÎ†àÏûÑ:</span>
                                <span id="analyzedFrames">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Í∞êÏßÄÎêú Ìï∏Îìú:</span>
                                <span id="detectedHands">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>GFX Í∞êÏßÄÏú®:</span>
                                <span id="gfxDetectionRate">0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>ÌèâÍ∑† Ìï∏Îìú Í∏∏Ïù¥:</span>
                                <span id="avgHandLength">0Ï¥à</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Í∞êÏßÄ Î°úÍ∑∏ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Í∞êÏßÄ Î°úÍ∑∏</h5>
                        <div class="detection-log" id="detectionLog"></div>
                    </div>
                </div>
                
                <!-- Í≤∞Í≥º Îã§Ïö¥Î°úÎìú -->
                <div class="mt-3">
                    <button class="btn btn-success w-100" id="downloadBtn" disabled>
                        <i class="bi bi-download"></i> Î∂ÑÏÑù Í≤∞Í≥º Îã§Ïö¥Î°úÎìú (JSON)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ìï∏Îìú Î™©Î°ù -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Í∞êÏßÄÎêú Ìï∏Îìú Î™©Î°ù</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>ÏãúÏûë ÏãúÍ∞Ñ</th>
                                        <th>Ï¢ÖÎ£å ÏãúÍ∞Ñ</th>
                                        <th>Í∏∏Ïù¥</th>
                                        <th>GFX ÏãúÏûë</th>
                                        <th>GFX Ï¢ÖÎ£å</th>
                                        <th>Ïã†Î¢∞ÎèÑ</th>
                                        <th>ÏûëÏóÖ</th>
                                    </tr>
                                </thead>
                                <tbody id="handsTableBody">
                                    <!-- Ìï∏Îìú Îç∞Ïù¥ÌÑ∞Í∞Ä ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let video = null;
        let canvas = null;
        let ctx = null;
        let isAnalyzing = false;
        let gfxModel = null;
        let hands = [];
        let currentGFX = null;
        let frameCount = 0;
        let analyzedCount = 0;
        
        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
            document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
            document.getElementById('pauseBtn').addEventListener('click', pauseAnalysis);
            document.getElementById('loadModelBtn').addEventListener('click', loadGFXModel);
            document.getElementById('downloadBtn').addEventListener('click', downloadResults);
        });
        
        // ÎπÑÎîîÏò§ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.addEventListener('loadedmetadata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                document.getElementById('analyzeBtn').disabled = false;
                
                // Ï≤´ ÌîÑÎ†àÏûÑ ÌëúÏãú
                video.currentTime = 0;
                video.addEventListener('seeked', () => {
                    ctx.drawImage(video, 0, 0);
                }, { once: true });
                
                logMessage(`ÎπÑÎîîÏò§ Î°úÎìúÎê®: ${video.duration.toFixed(1)}Ï¥à, ${video.videoWidth}x${video.videoHeight}`);
            });
        }
        
        // GFX Î™®Îç∏ Î°úÎìú (Ïã§Ï†úÎ°úÎäî Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÌïôÏäµÎêú Ìå®ÌÑ¥ Î°úÎìú)
        function loadGFXModel() {
            const savedModel = localStorage.getItem('gfxModel');
            if (savedModel) {
                gfxModel = JSON.parse(savedModel);
                logMessage('GFX Î™®Îç∏ Î°úÎìú ÏôÑÎ£å');
                alert('ÌïôÏäµÎêú GFX Î™®Îç∏ÏùÑ Î°úÎìúÌñàÏäµÎãàÎã§.');
            } else {
                logMessage('Ï†ÄÏû•Îêú GFX Î™®Îç∏Ïù¥ ÏóÜÏäµÎãàÎã§. GFX ÌïôÏäµÍ∏∞ÏóêÏÑú Î®ºÏ†Ä ÌïôÏäµÌï¥Ï£ºÏÑ∏Ïöî.');
                alert('Î®ºÏ†Ä GFX Ïò§Î≤ÑÎ†àÏù¥ ÌïôÏäµÍ∏∞ÏóêÏÑú Î™®Îç∏ÏùÑ ÌïôÏäµÏãúÏºúÏ£ºÏÑ∏Ïöî.');
            }
        }
        
        // Î∂ÑÏÑù ÏãúÏûë
        async function startAnalysis() {
            if (!video) return;
            
            isAnalyzing = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            
            hands = [];
            currentGFX = null;
            frameCount = 0;
            analyzedCount = 0;
            
            logMessage('Î∂ÑÏÑù ÏãúÏûë...');
            
            // ÌîÑÎ†àÏûÑÎ≥Ñ Î∂ÑÏÑù
            const fps = 30; // Í∞ÄÏ†ï
            const frameInterval = 1 / fps;
            let currentTime = 0;
            
            while (currentTime < video.duration && isAnalyzing) {
                video.currentTime = currentTime;
                await new Promise(resolve => {
                    video.addEventListener('seeked', resolve, { once: true });
                });
                
                // ÌîÑÎ†àÏûÑ Î∂ÑÏÑù
                analyzeFrame(currentTime);
                
                // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                updateProgress(currentTime / video.duration * 100);
                
                // Îã§Ïùå ÌîÑÎ†àÏûÑ
                currentTime += frameInterval;
                frameCount++;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏßÄÏó∞
                if (frameCount % 30 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            if (isAnalyzing) {
                completeAnalysis();
            }
        }
        
        // ÌîÑÎ†àÏûÑ Î∂ÑÏÑù
        function analyzeFrame(timestamp) {
            ctx.drawImage(video, 0, 0);
            
            const isGFX = detectGFXOverlay();
            
            if (isGFX && !currentGFX) {
                // GFX ÏãúÏûë
                currentGFX = {
                    startTime: timestamp,
                    endTime: null
                };
                logMessage(`GFX ÏãúÏûë: ${formatTime(timestamp)}`);
            } else if (!isGFX && currentGFX && !currentGFX.endTime) {
                // GFX Ï¢ÖÎ£å
                currentGFX.endTime = timestamp;
                
                // Ìï∏Îìú ÏÉùÏÑ± (15Ï¥à Í∑úÏπô Ï†ÅÏö©)
                const hand = {
                    id: hands.length + 1,
                    startTime: Math.max(0, currentGFX.startTime - 15),
                    endTime: currentGFX.endTime + 15,
                    gfxStart: currentGFX.startTime,
                    gfxEnd: currentGFX.endTime,
                    confidence: 0.95
                };
                
                hands.push(hand);
                logMessage(`Ìï∏Îìú ${hand.id} Í∞êÏßÄ: ${formatTime(hand.startTime)} - ${formatTime(hand.endTime)}`);
                updateHandsList();
                
                currentGFX = null;
            }
            
            analyzedCount++;
            updateStats();
        }
        
        // GFX Ïò§Î≤ÑÎ†àÏù¥ Í∞êÏßÄ (Í∞ÑÎã®Ìïú Ìú¥Î¶¨Ïä§Ìã±)
        function detectGFXOverlay() {
            if (!gfxModel) {
                // Î™®Îç∏Ïù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Ìú¥Î¶¨Ïä§Ìã± ÏÇ¨Ïö©
                return detectGFXHeuristic();
            }
            
            // ÌïôÏäµÎêú Î™®Îç∏ ÏÇ¨Ïö©
            const features = extractFeatures();
            return matchWithModel(features);
        }
        
        // Í∏∞Î≥∏ Ìú¥Î¶¨Ïä§Ìã± GFX Í∞êÏßÄ
        function detectGFXHeuristic() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Í∞ÑÎã®Ìïú Ìú¥Î¶¨Ïä§Ìã±: ÌäπÏ†ï ÏòÅÏó≠Ïùò ÏÉâÏÉÅ Í∑†ÏùºÎèÑ Ï≤¥ÌÅ¨
            let uniformityScore = calculateColorUniformity(data);
            let textDensity = estimateTextDensity(data);
            
            return uniformityScore > 0.7 && textDensity > 0.3;
        }
        
        // ÏÉâÏÉÅ Í∑†ÏùºÎèÑ Í≥ÑÏÇ∞
        function calculateColorUniformity(data) {
            const colorMap = {};
            const sampleRate = 100; // 100ÌîΩÏÖÄÎßàÎã§ ÏÉòÌîåÎßÅ
            
            for (let i = 0; i < data.length; i += sampleRate * 4) {
                const r = Math.floor(data[i] / 32) * 32;
                const g = Math.floor(data[i + 1] / 32) * 32;
                const b = Math.floor(data[i + 2] / 32) * 32;
                const color = `${r},${g},${b}`;
                
                colorMap[color] = (colorMap[color] || 0) + 1;
            }
            
            const colors = Object.values(colorMap).sort((a, b) => b - a);
            const top5 = colors.slice(0, 5).reduce((a, b) => a + b, 0);
            const total = colors.reduce((a, b) => a + b, 0);
            
            return top5 / total;
        }
        
        // ÌÖçÏä§Ìä∏ Î∞ÄÎèÑ Ï∂îÏ†ï
        function estimateTextDensity(data) {
            // Í∞ÑÎã®Ìïú Ïó£ÏßÄ Í∞êÏßÄÎ°ú ÌÖçÏä§Ìä∏ ÏòÅÏó≠ Ï∂îÏ†ï
            let edgeCount = 0;
            const threshold = 30;
            
            for (let i = 0; i < data.length - 4; i += 4) {
                const diff = Math.abs(data[i] - data[i + 4]);
                if (diff > threshold) edgeCount++;
            }
            
            return Math.min(edgeCount / (data.length / 4), 1);
        }
        
        // ÌäπÏßï Ï∂îÏ∂ú
        function extractFeatures() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return {
                colorUniformity: calculateColorUniformity(imageData.data),
                textDensity: estimateTextDensity(imageData.data),
                timestamp: video.currentTime
            };
        }
        
        // Î™®Îç∏Í≥º Îß§Ïπ≠
        function matchWithModel(features) {
            if (!gfxModel || !gfxModel.patterns) return false;
            
            for (const pattern of gfxModel.patterns) {
                const colorDiff = Math.abs(features.colorUniformity - pattern.colorUniformity);
                const textDiff = Math.abs(features.textDensity - pattern.textDensity);
                
                if (colorDiff < 0.1 && textDiff < 0.1) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Î∂ÑÏÑù ÏùºÏãúÏ†ïÏßÄ
        function pauseAnalysis() {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            logMessage('Î∂ÑÏÑù ÏùºÏãúÏ†ïÏßÄ');
        }
        
        // Î∂ÑÏÑù ÏôÑÎ£å
        function completeAnalysis() {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = false;
            
            logMessage(`Î∂ÑÏÑù ÏôÑÎ£å: ${hands.length}Í∞ú Ìï∏Îìú Í∞êÏßÄ`);
            updateTimeline();
        }
        
        // ÌÉÄÏûÑÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            const duration = video.duration;
            
            hands.forEach(hand => {
                // Ìï∏Îìú ÏÑ∏Í∑∏Î®ºÌä∏
                const handSegment = document.createElement('div');
                handSegment.className = 'hand-segment';
                handSegment.style.left = `${(hand.startTime / duration) * 100}%`;
                handSegment.style.width = `${((hand.endTime - hand.startTime) / duration) * 100}%`;
                handSegment.title = `Ìï∏Îìú ${hand.id}: ${formatTime(hand.startTime)} - ${formatTime(hand.endTime)}`;
                
                // GFX ÏÑ∏Í∑∏Î®ºÌä∏
                const gfxSegment = document.createElement('div');
                gfxSegment.className = 'gfx-segment';
                gfxSegment.style.left = `${(hand.gfxStart / duration) * 100}%`;
                gfxSegment.style.width = `${((hand.gfxEnd - hand.gfxStart) / duration) * 100}%`;
                gfxSegment.title = `GFX: ${formatTime(hand.gfxStart)} - ${formatTime(hand.gfxEnd)}`;
                
                timeline.appendChild(handSegment);
                timeline.appendChild(gfxSegment);
            });
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            document.getElementById('totalFrames').textContent = frameCount;
            document.getElementById('analyzedFrames').textContent = analyzedCount;
            document.getElementById('detectedHands').textContent = hands.length;
            
            const gfxFrames = hands.reduce((sum, hand) => {
                return sum + (hand.gfxEnd - hand.gfxStart) * 30; // 30fps Í∞ÄÏ†ï
            }, 0);
            
            const gfxRate = analyzedCount > 0 ? (gfxFrames / analyzedCount * 100).toFixed(1) : 0;
            document.getElementById('gfxDetectionRate').textContent = `${gfxRate}%`;
            
            if (hands.length > 0) {
                const avgLength = hands.reduce((sum, hand) => sum + (hand.endTime - hand.startTime), 0) / hands.length;
                document.getElementById('avgHandLength').textContent = `${avgLength.toFixed(1)}Ï¥à`;
            }
        }
        
        // Ìï∏Îìú Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateHandsList() {
            const tbody = document.getElementById('handsTableBody');
            tbody.innerHTML = '';
            
            hands.forEach(hand => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${hand.id}</td>
                    <td>${formatTime(hand.startTime)}</td>
                    <td>${formatTime(hand.endTime)}</td>
                    <td>${(hand.endTime - hand.startTime).toFixed(1)}Ï¥à</td>
                    <td>${formatTime(hand.gfxStart)}</td>
                    <td>${formatTime(hand.gfxEnd)}</td>
                    <td>${(hand.confidence * 100).toFixed(0)}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="jumpToHand(${hand.startTime})">
                            Ïù¥Îèô
                        </button>
                    </td>
                `;
            });
        }
        
        // ÌäπÏ†ï Ìï∏ÎìúÎ°ú Ïù¥Îèô
        function jumpToHand(time) {
            if (video) {
                video.currentTime = time;
                video.addEventListener('seeked', () => {
                    ctx.drawImage(video, 0, 0);
                }, { once: true });
            }
        }
        
        // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent.toFixed(0)}%`;
        }
        
        // Î°úÍ∑∏ Î©îÏãúÏßÄ
        function logMessage(message) {
            const log = document.getElementById('detectionLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        // ÏãúÍ∞Ñ Ìè¨Îß∑
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins}:${secs.padStart(4, '0')}`;
        }
        
        // Í≤∞Í≥º Îã§Ïö¥Î°úÎìú
        function downloadResults() {
            const results = {
                videoInfo: {
                    duration: video.duration,
                    width: video.videoWidth,
                    height: video.videoHeight,
                    analyzedFrames: analyzedCount
                },
                hands: hands.map(hand => ({
                    id: hand.id,
                    startTime: hand.startTime,
                    endTime: hand.endTime,
                    duration: hand.endTime - hand.startTime,
                    gfxStart: hand.gfxStart,
                    gfxEnd: hand.gfxEnd,
                    confidence: hand.confidence
                })),
                summary: {
                    totalHands: hands.length,
                    totalDuration: hands.reduce((sum, h) => sum + (h.endTime - h.startTime), 0),
                    averageHandLength: hands.length > 0 ? 
                        hands.reduce((sum, h) => sum + (h.endTime - h.startTime), 0) / hands.length : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poker_hands_analysis_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logMessage('Î∂ÑÏÑù Í≤∞Í≥º Îã§Ïö¥Î°úÎìúÎê®');
        }
    </script>
</body>
</html>