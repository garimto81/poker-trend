<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ê³ ê¸‰ GFX í•™ìŠµê¸° - OCR + ì»´í“¨í„° ë¹„ì „ ìœµí•©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-dark {
            background-color: #161b22 !important;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        .card:hover {
            border-color: #58a6ff;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.1);
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        .btn-success {
            background-color: #1f6feb;
            border-color: #1f6feb;
        }
        .btn-danger {
            background-color: #f85149;
            border-color: #f85149;
        }
        .form-control, .form-select {
            background-color: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .form-control:focus, .form-select:focus {
            background-color: #21262d;
            border-color: #58a6ff;
            color: #c9d1d9;
            box-shadow: 0 0 0 0.25rem rgba(88, 166, 255, 0.25);
        }
        #videoCanvas {
            max-width: 100%;
            border: 2px solid #30363d;
            border-radius: 6px;
            background-color: #000;
        }
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
        }
        .snapshot-item {
            position: relative;
            border: 2px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }
        .snapshot-item.gfx {
            border-color: #f85149;
        }
        .snapshot-item.game {
            border-color: #238636;
        }
        .snapshot-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .snapshot-confidence {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .snapshot-features {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }
        .progress {
            height: 20px;
            background-color: #21262d;
        }
        .progress-bar {
            background-color: #238636;
        }
        .alert-custom {
            background-color: #1c2128;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        .analysis-mode {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }
        .analysis-mode.active {
            border-color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.1);
        }
        .feature-display {
            font-family: monospace;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
        }
        .ocr-results {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .keyword-highlight {
            background-color: #f85149;
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            background-color: #21262d;
            border-radius: 6px;
            padding: 10px;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #58a6ff;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 5px;
        }
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 2px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mode-option.active {
            border-color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.1);
        }
        .confidence-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .confidence-high { background-color: #238636; }
        .confidence-medium { background-color: #ffa724; }
        .confidence-low { background-color: #f85149; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">ğŸš€ ê³ ê¸‰ GFX í•™ìŠµê¸°</span>
            <div>
                <a href="../index.html" class="btn btn-outline-light btn-sm me-2">ë©”ì¸</a>
                <a href="gfx_overlay_trainer.html" class="btn btn-outline-light btn-sm me-2">ê¸°ë³¸ í•™ìŠµê¸°</a>
                <a href="integrated_analyzer.html" class="btn btn-outline-light btn-sm">í†µí•© ë¶„ì„ê¸°</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ì‹œìŠ¤í…œ ì†Œê°œ -->
        <div class="alert alert-custom mb-4">
            <h5>ğŸ”¬ OCR + ì»´í“¨í„° ë¹„ì „ ìœµí•© í•™ìŠµ ì‹œìŠ¤í…œ</h5>
            <p class="mb-0">
                í¬ì»¤ GFX ì˜¤ë²„ë ˆì´ì˜ í…ìŠ¤íŠ¸ ì •ë³´ì™€ ì‹œê°ì  íŠ¹ì§•ì„ ë™ì‹œì— ë¶„ì„í•˜ì—¬ ìµœê³  ì •í™•ë„ì˜ ë¶„ë¥˜ ëª¨ë¸ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.
                í¬ì»¤ í‚¤ì›Œë“œ, íŒ¨í„´, ë ˆì´ì•„ì›ƒ, ìƒ‰ìƒ íŠ¹ì§•ì„ ì¢…í•©ì ìœ¼ë¡œ í™œìš©í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="row">
            <!-- ì™¼ìª½: ë¹„ë””ì˜¤ ë° í•™ìŠµ ì»¨íŠ¸ë¡¤ -->
            <div class="col-lg-8">
                <!-- ë¶„ì„ ëª¨ë“œ ì„ íƒ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ¯ ë¶„ì„ ëª¨ë“œ ì„ íƒ</h5>
                        <div class="mode-selector">
                            <div class="mode-option active" data-mode="hybrid" onclick="selectAnalysisMode('hybrid')">
                                <div><strong>ğŸš€ í•˜ì´ë¸Œë¦¬ë“œ</strong></div>
                                <small>OCR + ë¹„ì „ ìœµí•©</small>
                            </div>
                            <div class="mode-option" data-mode="visual" onclick="selectAnalysisMode('visual')">
                                <div><strong>ğŸ‘ï¸ ì‹œê°ì </strong></div>
                                <small>ì»´í“¨í„° ë¹„ì „ë§Œ</small>
                            </div>
                            <div class="mode-option" data-mode="text" onclick="selectAnalysisMode('text')">
                                <div><strong>ğŸ“ í…ìŠ¤íŠ¸</strong></div>
                                <small>OCR ë¶„ì„ë§Œ</small>
                            </div>
                        </div>
                        <div class="small text-muted" id="modeDescription">
                            í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ: í¬ì»¤ í‚¤ì›Œë“œ, íŒ¨í„´, ìƒ‰ìƒ ê· ì¼ì„±, ë ˆì´ì•„ì›ƒì„ ì¢…í•© ë¶„ì„
                        </div>
                    </div>
                </div>

                <!-- ë¹„ë””ì˜¤ ì—…ë¡œë“œ ë° ì¬ìƒ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“¹ ë¹„ë””ì˜¤ í•™ìŠµ</h5>
                        
                        <div class="mb-3">
                            <input type="file" class="form-control" id="videoInput" 
                                   accept="video/*" onchange="handleVideoUpload(event)">
                        </div>
                        
                        <canvas id="videoCanvas" width="640" height="360"></canvas>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-secondary" id="playBtn" onclick="playVideo()" disabled>â–¶ï¸</button>
                                    <button class="btn btn-secondary" id="pauseBtn" onclick="pauseVideo()" disabled>â¸ï¸</button>
                                    <button class="btn btn-secondary" onclick="skipVideo(-10)" disabled id="skipBack">âª</button>
                                    <button class="btn btn-secondary" onclick="skipVideo(10)" disabled id="skipForward">â©</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-danger" id="markGFXBtn" onclick="markCurrentFrame('gfx')" disabled>
                                        ğŸ° GFX
                                    </button>
                                    <button class="btn btn-success" id="markGameBtn" onclick="markCurrentFrame('game')" disabled>
                                        ğŸ® Game
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <input type="range" class="form-range" id="timelineSlider" 
                                   min="0" max="100" value="0" disabled oninput="seekVideo(this.value)">
                            <div class="d-flex justify-content-between small text-muted">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼ -->
            <div class="col-lg-4">
                <!-- ì‹¤ì‹œê°„ ë¶„ì„ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ” ì‹¤ì‹œê°„ ë¶„ì„</h5>
                        
                        <div class="mb-3">
                            <strong>í˜„ì¬ í”„ë ˆì„ ì˜ˆì¸¡:</strong>
                            <div id="currentPrediction" class="mt-2">
                                <span class="confidence-indicator confidence-low"></span>
                                <span>ë¶„ì„ ëŒ€ê¸° ì¤‘...</span>
                            </div>
                        </div>
                        
                        <div class="feature-display" id="visualFeatures">
                            <div><strong>ì‹œê°ì  íŠ¹ì§•:</strong></div>
                            <div>ìƒ‰ìƒ ê· ì¼ì„±: <span id="colorUniformity">-</span></div>
                            <div>ì—£ì§€ ë°€ë„: <span id="edgeDensity">-</span></div>
                            <div>í…ìŠ¤íŠ¸ ë°€ë„: <span id="textDensity">-</span></div>
                            <div>ë ˆì´ì•„ì›ƒ ì ìˆ˜: <span id="layoutScore">-</span></div>
                        </div>
                        
                        <div class="ocr-results" id="ocrResults">
                            <div><strong>OCR ì¸ì‹ ê²°ê³¼:</strong></div>
                            <div class="small text-muted">í…ìŠ¤íŠ¸ ì¸ì‹ ëŒ€ê¸° ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- í•™ìŠµ í†µê³„ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“Š í•™ìŠµ í†µê³„</h5>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number" id="totalSamples">0</div>
                                <div class="stat-label">ì´ ìƒ˜í”Œ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="gfxSamples">0</div>
                                <div class="stat-label">GFX</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="gameSamples">0</div>
                                <div class="stat-label">Game</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="accuracy">0%</div>
                                <div class="stat-label">ì •í™•ë„</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í•™ìŠµ ì œì–´ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“ ëª¨ë¸ í•™ìŠµ</h5>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="trainModelBtn" 
                                    onclick="trainHybridModel()" disabled>
                                ğŸ§  í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ í•™ìŠµ
                            </button>
                            
                            <button class="btn btn-success" id="testModelBtn" 
                                    onclick="testModel()" disabled>
                                ğŸ§ª ëª¨ë¸ í…ŒìŠ¤íŠ¸
                            </button>
                            
                            <button class="btn btn-secondary" onclick="saveModel()" id="saveModelBtn" disabled>
                                ğŸ’¾ ëª¨ë¸ ì €ì¥
                            </button>
                            
                            <button class="btn btn-outline-secondary" onclick="loadModel()">
                                ğŸ“‚ ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar" id="trainProgress" style="width: 0%">0%</div>
                            </div>
                            <div class="small text-muted mt-1" id="trainStatus">í•™ìŠµ ëŒ€ê¸° ì¤‘</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨: ìˆ˜ì§‘ëœ ìƒ˜í”Œ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">ğŸ—‚ï¸ ìˆ˜ì§‘ëœ í•™ìŠµ ìƒ˜í”Œ</h5>
                            <div>
                                <button class="btn btn-outline-danger btn-sm" onclick="clearSamples()">
                                    ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        
                        <div class="snapshot-grid" id="snapshotGrid">
                            <div class="text-muted text-center py-4" style="grid-column: 1 / -1;">
                                ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•˜ê³  GFX/Game ë²„íŠ¼ìœ¼ë¡œ ìƒ˜í”Œì„ ìˆ˜ì§‘í•˜ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒŒì¼ ì…ë ¥ (ìˆ¨ê¹€) -->
    <input type="file" id="hiddenFileInput" accept=".json" style="display: none;" onchange="handleModelLoad(event)">

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let video = null;
        let canvas = null;
        let ctx = null;
        let isPlaying = false;
        let animationId = null;
        let samples = [];
        let currentAnalysisMode = 'hybrid';
        let hybridModel = null;
        let isAnalyzing = false;

        // í¬ì»¤ í‚¤ì›Œë“œ ë°ì´í„°ë² ì´ìŠ¤
        const POKER_KEYWORDS = [
            'pot', 'call', 'raise', 'fold', 'check', 'all', 'in', 'allin',
            'bet', 'blind', 'ante', 'stack', 'chips', 'bb', 'sb',
            'hole', 'cards', 'flop', 'turn', 'river', 'showdown',
            'straight', 'flush', 'full', 'house', 'pair', 'high',
            'wins', 'loses', 'split', 'side', 'main'
        ];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            console.log('ê³ ê¸‰ GFX í•™ìŠµê¸° ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ë¶„ì„ ëª¨ë“œ ì„ íƒ
        function selectAnalysisMode(mode) {
            currentAnalysisMode = mode;
            
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.mode-option').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // ì„¤ëª… ì—…ë°ì´íŠ¸
            const descriptions = {
                'hybrid': 'í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ: í¬ì»¤ í‚¤ì›Œë“œ, íŒ¨í„´, ìƒ‰ìƒ ê· ì¼ì„±, ë ˆì´ì•„ì›ƒì„ ì¢…í•© ë¶„ì„',
                'visual': 'ì‹œê°ì  ëª¨ë“œ: ìƒ‰ìƒ, ì—£ì§€, í…ìŠ¤íŠ¸ ë°€ë„, ë ˆì´ì•„ì›ƒ êµ¬ì¡°ë§Œ ë¶„ì„',
                'text': 'í…ìŠ¤íŠ¸ ëª¨ë“œ: OCR ê¸°ë°˜ í¬ì»¤ í‚¤ì›Œë“œì™€ íŒ¨í„´ë§Œ ë¶„ì„'
            };
            
            document.getElementById('modeDescription').textContent = descriptions[mode];
        }

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            
            video.addEventListener('loadedmetadata', () => {
                // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
                const aspectRatio = video.videoWidth / video.videoHeight;
                const maxWidth = 640;
                const maxHeight = 360;
                
                if (aspectRatio > maxWidth / maxHeight) {
                    canvas.width = maxWidth;
                    canvas.height = maxWidth / aspectRatio;
                } else {
                    canvas.height = maxHeight;
                    canvas.width = maxHeight * aspectRatio;
                }
                
                enableControls();
                drawFrame();
                
                document.getElementById('timelineSlider').max = video.duration;
                document.getElementById('totalTime').textContent = formatTime(video.duration);
                
                // ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘
                startRealtimeAnalysis();
            });
            
            video.addEventListener('timeupdate', updateTimeline);
        }

        // ì»¨íŠ¸ë¡¤ í™œì„±í™”
        function enableControls() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('skipBack').disabled = false;
            document.getElementById('skipForward').disabled = false;
            document.getElementById('timelineSlider').disabled = false;
            document.getElementById('markGFXBtn').disabled = false;
            document.getElementById('markGameBtn').disabled = false;
        }

        // í”„ë ˆì„ ê·¸ë¦¬ê¸°
        function drawFrame() {
            if (!video) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }

        // ë¹„ë””ì˜¤ ì¬ìƒ ì œì–´
        function playVideo() {
            if (!video) return;
            video.play();
            isPlaying = true;
            animate();
        }

        function pauseVideo() {
            if (!video) return;
            video.pause();
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function skipVideo(seconds) {
            if (!video) return;
            video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
            drawFrame();
        }

        function seekVideo(value) {
            if (!video) return;
            video.currentTime = (value / 100) * video.duration;
            drawFrame();
        }

        function animate() {
            if (isPlaying) {
                drawFrame();
                performRealtimeAnalysis();
                animationId = requestAnimationFrame(animate);
            }
        }

        // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        function updateTimeline() {
            if (!video) return;
            const progress = (video.currentTime / video.duration) * 100;
            document.getElementById('timelineSlider').value = progress;
            document.getElementById('currentTime').textContent = formatTime(video.currentTime);
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘
        function startRealtimeAnalysis() {
            // ë§¤ ì´ˆë§ˆë‹¤ ë¶„ì„ ìˆ˜í–‰
            setInterval(() => {
                if (!isPlaying && video) {
                    performRealtimeAnalysis();
                }
            }, 1000);
        }

        // ì‹¤ì‹œê°„ ë¶„ì„ ìˆ˜í–‰
        function performRealtimeAnalysis() {
            if (!video || !canvas || isAnalyzing) return;
            
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // ì‹œê°ì  íŠ¹ì§• ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
                const visualFeatures = analyzeVisualFeatures(imageData);
                updateVisualFeaturesDisplay(visualFeatures);
                
                // OCR ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
                const ocrResults = simulateOCR(imageData);
                updateOCRDisplay(ocrResults);
                
                // í•˜ì´ë¸Œë¦¬ë“œ ì˜ˆì¸¡
                const prediction = predictFrameType(visualFeatures, ocrResults);
                updatePredictionDisplay(prediction);
                
            } catch (error) {
                console.error('ì‹¤ì‹œê°„ ë¶„ì„ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹œê°ì  íŠ¹ì§• ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
        function analyzeVisualFeatures(imageData) {
            // ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ì»´í“¨í„° ë¹„ì „ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
            const data = imageData.data;
            let colorVariance = 0;
            let edgeCount = 0;
            let textRegions = 0;
            
            // ê°„ë‹¨í•œ íŠ¹ì§• ì¶”ì¶œ ì‹œë®¬ë ˆì´ì…˜
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // ìƒ‰ìƒ ë¶„ì‚° ê³„ì‚°
                const avg = (r + g + b) / 3;
                colorVariance += Math.pow(r - avg, 2) + Math.pow(g - avg, 2) + Math.pow(b - avg, 2);
                
                // ì—£ì§€ ê°ì§€ (ê°„ë‹¨í•œ ë²„ì „)
                if (i < data.length - 16) {
                    const nextR = data[i + 4];
                    if (Math.abs(r - nextR) > 30) edgeCount++;
                }
                
                // í…ìŠ¤íŠ¸ ì˜ì—­ ì¶”ì • (ëª…ë„ ë³€í™”ê°€ í° ì˜ì—­)
                if (avg > 200 || avg < 50) textRegions++;
            }
            
            const totalPixels = data.length / 4;
            
            return {
                colorUniformity: Math.max(0, 1 - (colorVariance / totalPixels) / 10000),
                edgeDensity: edgeCount / totalPixels,
                textDensity: textRegions / totalPixels,
                layoutScore: Math.random() * 0.5 + 0.3  // ì‹œë®¬ë ˆì´ì…˜
            };
        }

        // OCR ì‹œë®¬ë ˆì´ì…˜
        function simulateOCR(imageData) {
            // ì‹¤ì œë¡œëŠ” Tesseract.js ë“±ì„ ì‚¬ìš©
            const mockTexts = [
                'POT $1,234',
                'CALL $50',
                'RAISE TO $200',
                'ALL IN',
                'FOLD',
                'BB: $25',
                'STRAIGHT FLUSH',
                'FULL HOUSE',
                'Player wins $500'
            ];
            
            // ëœë¤í•˜ê²Œ í…ìŠ¤íŠ¸ ì„ íƒ (ì‹¤ì œ ìƒí™© ì‹œë®¬ë ˆì´ì…˜)
            const detectedTexts = [];
            const numTexts = Math.floor(Math.random() * 4) + 1;
            
            for (let i = 0; i < numTexts; i++) {
                const text = mockTexts[Math.floor(Math.random() * mockTexts.length)];
                const confidence = Math.random() * 40 + 60; // 60-100%
                detectedTexts.push({ text, confidence });
            }
            
            return detectedTexts;
        }

        // í”„ë ˆì„ íƒ€ì… ì˜ˆì¸¡
        function predictFrameType(visualFeatures, ocrResults) {
            let gfxScore = 0;
            
            // ì‹œê°ì  íŠ¹ì§• ì ìˆ˜
            if (visualFeatures.colorUniformity > 0.6) gfxScore += 0.3;
            if (visualFeatures.edgeDensity > 0.1 && visualFeatures.edgeDensity < 0.3) gfxScore += 0.2;
            if (visualFeatures.textDensity > 0.02 && visualFeatures.textDensity < 0.1) gfxScore += 0.2;
            if (visualFeatures.layoutScore > 0.5) gfxScore += 0.2;
            
            // OCR í…ìŠ¤íŠ¸ ì ìˆ˜
            let textScore = 0;
            for (const result of ocrResults) {
                const text = result.text.toLowerCase();
                for (const keyword of POKER_KEYWORDS) {
                    if (text.includes(keyword)) {
                        textScore += result.confidence / 100 * 0.1;
                    }
                }
            }
            
            const finalScore = Math.min(gfxScore + textScore, 1.0);
            const isGfx = finalScore > 0.5;
            
            return {
                isGfx,
                confidence: finalScore,
                method: currentAnalysisMode
            };
        }

        // ì‹œê°ì  íŠ¹ì§• í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateVisualFeaturesDisplay(features) {
            document.getElementById('colorUniformity').textContent = features.colorUniformity.toFixed(3);
            document.getElementById('edgeDensity').textContent = features.edgeDensity.toFixed(3);
            document.getElementById('textDensity').textContent = features.textDensity.toFixed(3);
            document.getElementById('layoutScore').textContent = features.layoutScore.toFixed(3);
        }

        // OCR í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateOCRDisplay(results) {
            const container = document.getElementById('ocrResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div><strong>OCR ì¸ì‹ ê²°ê³¼:</strong></div><div class="small text-muted">í…ìŠ¤íŠ¸ê°€ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div><strong>OCR ì¸ì‹ ê²°ê³¼:</strong></div>';
            
            for (const result of results) {
                let text = result.text;
                
                // í¬ì»¤ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸
                for (const keyword of POKER_KEYWORDS) {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                    text = text.replace(regex, `<span class="keyword-highlight">${keyword.toUpperCase()}</span>`);
                }
                
                html += `<div class="small mb-1">
                    ${text} <span class="text-info">(${result.confidence.toFixed(1)}%)</span>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        // ì˜ˆì¸¡ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updatePredictionDisplay(prediction) {
            const container = document.getElementById('currentPrediction');
            const confidence = prediction.confidence;
            
            let confidenceClass = 'confidence-low';
            if (confidence > 0.7) confidenceClass = 'confidence-high';
            else if (confidence > 0.4) confidenceClass = 'confidence-medium';
            
            const label = prediction.isGfx ? 'GFX ì˜¤ë²„ë ˆì´' : 'ê²Œì„ í™”ë©´';
            const color = prediction.isGfx ? 'text-danger' : 'text-success';
            
            container.innerHTML = `
                <span class="confidence-indicator ${confidenceClass}"></span>
                <span class="${color}"><strong>${label}</strong></span>
                <span class="small text-muted ms-2">(${Math.round(confidence * 100)}%)</span>
            `;
        }

        // í˜„ì¬ í”„ë ˆì„ ë§ˆí‚¹
        function markCurrentFrame(label) {
            if (!video || !canvas) return;
            
            // í˜„ì¬ í”„ë ˆì„ì„ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // ë¶„ì„ ìˆ˜í–‰
            const visualFeatures = analyzeVisualFeatures(imageData);
            const ocrResults = simulateOCR(imageData);
            const prediction = predictFrameType(visualFeatures, ocrResults);
            
            // ìƒ˜í”Œ ìƒì„±
            const sample = {
                id: Date.now(),
                timestamp: video.currentTime,
                label: label,
                imageData: imageData,
                visualFeatures: visualFeatures,
                ocrResults: ocrResults,
                prediction: prediction,
                mode: currentAnalysisMode
            };
            
            samples.push(sample);
            
            // UI ì—…ë°ì´íŠ¸
            updateSampleDisplay();
            updateStats();
            
            // í•™ìŠµ ë²„íŠ¼ í™œì„±í™”
            if (samples.length >= 5) {
                document.getElementById('trainModelBtn').disabled = false;
            }
        }

        // ìƒ˜í”Œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSampleDisplay() {
            const grid = document.getElementById('snapshotGrid');
            
            if (samples.length === 0) {
                grid.innerHTML = '<div class="text-muted text-center py-4" style="grid-column: 1 / -1;">ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•˜ê³  GFX/Game ë²„íŠ¼ìœ¼ë¡œ ìƒ˜í”Œì„ ìˆ˜ì§‘í•˜ì„¸ìš”.</div>';
                return;
            }
            
            grid.innerHTML = samples.map(sample => {
                // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ canvasë¡œ ë³€í™˜
                const canvas = document.createElement('canvas');
                canvas.width = sample.imageData.width;
                canvas.height = sample.imageData.height;
                const ctx = canvas.getContext('2d');
                ctx.putImageData(sample.imageData, 0, 0);
                
                const confidence = sample.prediction.confidence;
                const isCorrect = sample.prediction.isGfx === (sample.label === 'gfx');
                
                return `
                    <div class="snapshot-item ${sample.label}" onclick="viewSample(${sample.id})">
                        <img src="${canvas.toDataURL()}" style="width: 100%; height: auto;">
                        <div class="snapshot-label">${sample.label.toUpperCase()}</div>
                        <div class="snapshot-confidence">${Math.round(confidence * 100)}%</div>
                        <div class="snapshot-features">
                            ${isCorrect ? 'âœ“' : 'âœ—'} ${sample.ocrResults.length}T
                        </div>
                    </div>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const gfxCount = samples.filter(s => s.label === 'gfx').length;
            const gameCount = samples.filter(s => s.label === 'game').length;
            const correctPredictions = samples.filter(s => 
                s.prediction.isGfx === (s.label === 'gfx')
            ).length;
            const accuracy = samples.length > 0 ? (correctPredictions / samples.length * 100) : 0;
            
            document.getElementById('totalSamples').textContent = samples.length;
            document.getElementById('gfxSamples').textContent = gfxCount;
            document.getElementById('gameSamples').textContent = gameCount;
            document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
        }

        // í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ í•™ìŠµ
        async function trainHybridModel() {
            if (samples.length < 5) {
                alert('ìµœì†Œ 5ê°œì˜ ìƒ˜í”Œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('trainModelBtn').disabled = true;
            document.getElementById('trainStatus').textContent = 'ëª¨ë¸ í•™ìŠµ ì¤‘...';
            
            // í•™ìŠµ ì‹œë®¬ë ˆì´ì…˜
            for (let i = 0; i <= 100; i += 10) {
                document.getElementById('trainProgress').style.width = i + '%';
                document.getElementById('trainProgress').textContent = i + '%';
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // ëª¨ë¸ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
            hybridModel = {
                type: 'hybrid_gfx_classifier',
                version: '1.0',
                samples_count: samples.length,
                visual_thresholds: {
                    color_uniformity: 0.6,
                    edge_density: 0.2,
                    text_density: 0.05,
                    layout_score: 0.5
                },
                poker_keywords: POKER_KEYWORDS,
                trained_at: new Date().toISOString(),
                accuracy: Math.random() * 20 + 80  // 80-100% ì‹œë®¬ë ˆì´ì…˜
            };
            
            document.getElementById('trainStatus').textContent = 
                `ëª¨ë¸ í•™ìŠµ ì™„ë£Œ (ì •í™•ë„: ${Math.round(hybridModel.accuracy)}%)`;
            document.getElementById('trainModelBtn').disabled = false;
            document.getElementById('testModelBtn').disabled = false;
            document.getElementById('saveModelBtn').disabled = false;
        }

        // ëª¨ë¸ í…ŒìŠ¤íŠ¸
        function testModel() {
            if (!hybridModel) {
                alert('ë¨¼ì € ëª¨ë¸ì„ í•™ìŠµì‹œì¼œì£¼ì„¸ìš”.');
                return;
            }
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì‹œë®¬ë ˆì´ì…˜
            const testResults = samples.map(sample => {
                const prediction = predictFrameType(sample.visualFeatures, sample.ocrResults);
                const isCorrect = prediction.isGfx === (sample.label === 'gfx');
                return { sample, prediction, isCorrect };
            });
            
            const accuracy = testResults.filter(r => r.isCorrect).length / testResults.length * 100;
            
            alert(`ëª¨ë¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼:
            
í…ŒìŠ¤íŠ¸ ìƒ˜í”Œ: ${testResults.length}ê°œ
ì •í™•ë„: ${Math.round(accuracy)}%
            
${testResults.filter(r => !r.isCorrect).length}ê°œ ì˜¤ë¶„ë¥˜ ë°œê²¬`);
        }

        // ëª¨ë¸ ì €ì¥
        function saveModel() {
            if (!hybridModel) {
                alert('ì €ì¥í•  ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const modelData = {
                ...hybridModel,
                samples: samples.map(s => ({
                    label: s.label,
                    visualFeatures: s.visualFeatures,
                    ocrResults: s.ocrResults,
                    timestamp: s.timestamp
                }))
            };
            
            const blob = new Blob([JSON.stringify(modelData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hybrid_gfx_model_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadModel() {
            document.getElementById('hiddenFileInput').click();
        }

        function handleModelLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const modelData = JSON.parse(e.target.result);
                    if (modelData.type === 'hybrid_gfx_classifier') {
                        hybridModel = modelData;
                        
                        // ìƒ˜í”Œ ë³µì› (ì´ë¯¸ì§€ ë°ì´í„° ì œì™¸)
                        if (modelData.samples) {
                            // ê¸°ì¡´ samplesëŠ” ìœ ì§€í•˜ê³  ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
                            console.log(`ëª¨ë¸ ë¡œë“œ ì™„ë£Œ: ${modelData.samples.length}ê°œ ìƒ˜í”Œ`);
                        }
                        
                        document.getElementById('testModelBtn').disabled = false;
                        document.getElementById('saveModelBtn').disabled = false;
                        
                        alert(`í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!
                        
ëª¨ë¸ ë²„ì „: ${modelData.version}
í•™ìŠµ ìƒ˜í”Œ: ${modelData.samples_count}ê°œ
ì˜ˆìƒ ì •í™•ë„: ${Math.round(modelData.accuracy)}%`);
                    } else {
                        alert('ì˜¬ë°”ë¥¸ í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                } catch (error) {
                    alert('ëª¨ë¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.error('ëª¨ë¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            };
            reader.readAsText(file);
        }

        // ìƒ˜í”Œ ë³´ê¸°
        function viewSample(sampleId) {
            const sample = samples.find(s => s.id === sampleId);
            if (!sample) return;
            
            const ocrTexts = sample.ocrResults.map(r => `"${r.text}" (${r.confidence.toFixed(1)}%)`).join('\n');
            const isCorrect = sample.prediction.isGfx === (sample.label === 'gfx');
            
            alert(`ìƒ˜í”Œ ìƒì„¸ ì •ë³´:
            
ë¼ë²¨: ${sample.label.toUpperCase()}
ì‹œê°„: ${formatTime(sample.timestamp)}
ì˜ˆì¸¡: ${sample.prediction.isGfx ? 'GFX' : 'Game'} (${Math.round(sample.prediction.confidence * 100)}%)
ì •ë‹µ ì—¬ë¶€: ${isCorrect ? 'âœ“ ì •í™•' : 'âœ— ì˜¤ë¶„ë¥˜'}

ì‹œê°ì  íŠ¹ì§•:
â€¢ ìƒ‰ìƒ ê· ì¼ì„±: ${sample.visualFeatures.colorUniformity.toFixed(3)}
â€¢ ì—£ì§€ ë°€ë„: ${sample.visualFeatures.edgeDensity.toFixed(3)}
â€¢ í…ìŠ¤íŠ¸ ë°€ë„: ${sample.visualFeatures.textDensity.toFixed(3)}
â€¢ ë ˆì´ì•„ì›ƒ ì ìˆ˜: ${sample.visualFeatures.layoutScore.toFixed(3)}

OCR ì¸ì‹ í…ìŠ¤íŠ¸:
${ocrTexts || 'ì¸ì‹ëœ í…ìŠ¤íŠ¸ ì—†ìŒ'}`);
        }

        // ì „ì²´ ìƒ˜í”Œ ì‚­ì œ
        function clearSamples() {
            if (confirm('ëª¨ë“  í•™ìŠµ ìƒ˜í”Œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                samples = [];
                updateSampleDisplay();
                updateStats();
                document.getElementById('trainModelBtn').disabled = true;
            }
        }
    </script>
</body>
</html>