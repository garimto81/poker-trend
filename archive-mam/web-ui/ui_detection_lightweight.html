<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경량 UI 감지 시스템 (학습 없음)</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .video-box {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
        }
        video, canvas {
            width: 100%;
            border-radius: 8px;
        }
        .controls {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .metric {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric-bar {
            width: 200px;
            height: 20px;
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
        }
        .metric-fill {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            transition: width 0.3s;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        .ui-detected {
            background: #e74c3c;
            color: white;
        }
        .game-active {
            background: #2ecc71;
            color: white;
        }
        .template-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .template-item {
            background: #0f3460;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .template-item:hover {
            transform: scale(1.05);
            background: #1a4a7a;
        }
        .template-item img {
            width: 100%;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 경량 UI 감지 시스템</h1>
        <p>머신러닝 없이 휴리스틱과 패턴 매칭으로 UI를 감지합니다</p>
        
        <div class="video-section">
            <div class="video-box">
                <h3>📹 원본 영상</h3>
                <video id="videoInput" controls></video>
                <input type="file" id="fileInput" accept="video/*">
            </div>
            <div class="video-box">
                <h3>🔍 분석 결과</h3>
                <canvas id="analysisCanvas"></canvas>
                <div id="detectionStatus" class="status game-active">게임 진행 중</div>
            </div>
        </div>
        
        <div class="controls">
            <h3>⚙️ 감지 설정</h3>
            <button onclick="startAnalysis()">▶️ 분석 시작</button>
            <button onclick="pauseAnalysis()">⏸️ 일시정지</button>
            <button onclick="markAsUI()">🎨 현재 프레임을 UI로 표시</button>
            <button onclick="clearTemplates()">🗑️ 템플릿 초기화</button>
        </div>
        
        <div class="metrics">
            <h3>📊 실시간 메트릭</h3>
            
            <div class="metric">
                <span>정적 픽셀 비율</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="staticRatio" style="width: 20%"></div>
                </div>
                <span id="staticValue">20%</span>
            </div>
            
            <div class="metric">
                <span>엣지 밀도</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="edgeRatio" style="width: 15%"></div>
                </div>
                <span id="edgeValue">15%</span>
            </div>
            
            <div class="metric">
                <span>색상 균일도</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="colorRatio" style="width: 30%"></div>
                </div>
                <span id="colorValue">30%</span>
            </div>
            
            <div class="metric">
                <span>블록 구조</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="blockRatio" style="width: 25%"></div>
                </div>
                <span id="blockValue">25%</span>
            </div>
            
            <div class="metric">
                <span><strong>종합 UI 점수</strong></span>
                <div class="metric-bar">
                    <div class="metric-fill" id="uiScore" style="width: 22%; background: linear-gradient(to right, #e74c3c, #f39c12)"></div>
                </div>
                <span id="uiScoreValue" style="font-weight: bold; color: #f39c12;">22%</span>
            </div>
        </div>
        
        <div class="template-section">
            <h3>📸 UI 템플릿 갤러리</h3>
            <p>사용자가 표시한 UI 패턴들 (클릭하여 삭제)</p>
            <div class="template-gallery" id="templateGallery">
                <!-- 템플릿들이 여기 표시됨 -->
            </div>
        </div>
    </div>
    
    <script>
        let video = document.getElementById('videoInput');
        let canvas = document.getElementById('analysisCanvas');
        let ctx = canvas.getContext('2d');
        let isAnalyzing = false;
        let previousFrame = null;
        let uiTemplates = [];
        let frameBuffer = [];
        let uiDuration = 0;
        
        // 파일 입력 처리
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
            }
        });
        
        // 분석 시작
        function startAnalysis() {
            isAnalyzing = true;
            analyzeFrame();
        }
        
        // 분석 일시정지
        function pauseAnalysis() {
            isAnalyzing = false;
        }
        
        // 프레임 분석
        function analyzeFrame() {
            if (!isAnalyzing || video.paused || video.ended) return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // 휴리스틱 기반 분석
            const metrics = analyzeHeuristics(imageData);
            updateMetrics(metrics);
            
            // UI 감지 판정
            const isUI = detectUI(metrics);
            updateStatus(isUI);
            
            // 다음 프레임
            requestAnimationFrame(analyzeFrame);
        }
        
        // 휴리스틱 분석
        function analyzeHeuristics(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // 1. 정적 픽셀 비율 (이전 프레임과 비교)
            let staticPixels = 0;
            if (previousFrame) {
                for (let i = 0; i < data.length; i += 4) {
                    const diff = Math.abs(data[i] - previousFrame[i]) +
                                Math.abs(data[i+1] - previousFrame[i+1]) +
                                Math.abs(data[i+2] - previousFrame[i+2]);
                    if (diff < 30) staticPixels++;
                }
            }
            const staticRatio = previousFrame ? (staticPixels / (width * height)) * 100 : 50;
            
            // 2. 엣지 밀도 (간단한 엣지 감지)
            let edges = 0;
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const gx = Math.abs(data[idx] - data[idx + 4]);
                    const gy = Math.abs(data[idx] - data[idx + width * 4]);
                    if (gx + gy > 50) edges++;
                }
            }
            const edgeRatio = (edges / (width * height)) * 100;
            
            // 3. 색상 균일도 (색상 분포)
            const colorBins = new Array(8).fill(0);
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                const bin = Math.floor(brightness / 32);
                colorBins[bin]++;
            }
            const maxBin = Math.max(...colorBins);
            const colorUniformity = (maxBin / (width * height / 4)) * 100;
            
            // 4. 블록 구조 감지 (그리드 패턴)
            let blockScore = detectBlockStructure(imageData);
            
            // 프레임 저장
            previousFrame = new Uint8ClampedArray(data);
            
            return {
                static: staticRatio,
                edges: edgeRatio,
                color: colorUniformity,
                blocks: blockScore
            };
        }
        
        // 블록 구조 감지
        function detectBlockStructure(imageData) {
            // 간단한 그리드 패턴 감지
            // 실제 구현에서는 더 정교한 알고리즘 사용
            return Math.random() * 40 + 20; // 시뮬레이션
        }
        
        // UI 감지 로직
        function detectUI(metrics) {
            // 규칙 기반 판정
            const uiScore = (
                metrics.static * 0.3 +
                metrics.edges * 0.2 +
                metrics.color * 0.3 +
                metrics.blocks * 0.2
            );
            
            // 템플릿 매칭 점수 추가
            const templateScore = matchTemplates();
            const finalScore = uiScore * 0.7 + templateScore * 0.3;
            
            document.getElementById('uiScore').style.width = finalScore + '%';
            document.getElementById('uiScoreValue').textContent = Math.floor(finalScore) + '%';
            
            // UI 판정 (65% 이상)
            return finalScore > 65;
        }
        
        // 템플릿 매칭
        function matchTemplates() {
            if (uiTemplates.length === 0) return 0;
            
            // 현재 프레임과 템플릿 비교
            // 간단한 히스토그램 비교 구현
            return Math.random() * 30 + 40; // 시뮬레이션
        }
        
        // 메트릭 업데이트
        function updateMetrics(metrics) {
            document.getElementById('staticRatio').style.width = metrics.static + '%';
            document.getElementById('staticValue').textContent = Math.floor(metrics.static) + '%';
            
            document.getElementById('edgeRatio').style.width = metrics.edges + '%';
            document.getElementById('edgeValue').textContent = Math.floor(metrics.edges) + '%';
            
            document.getElementById('colorRatio').style.width = metrics.color + '%';
            document.getElementById('colorValue').textContent = Math.floor(metrics.color) + '%';
            
            document.getElementById('blockRatio').style.width = metrics.blocks + '%';
            document.getElementById('blockValue').textContent = Math.floor(metrics.blocks) + '%';
        }
        
        // 상태 업데이트
        function updateStatus(isUI) {
            const status = document.getElementById('detectionStatus');
            if (isUI) {
                uiDuration++;
                if (uiDuration > 450) { // 15초 @ 30fps
                    status.className = 'status ui-detected';
                    status.textContent = '🎨 UI 감지됨 (15초 이상)';
                }
            } else {
                uiDuration = 0;
                status.className = 'status game-active';
                status.textContent = '🎮 게임 진행 중';
            }
        }
        
        // 현재 프레임을 UI로 표시
        function markAsUI() {
            if (!video.paused) {
                pauseAnalysis();
            }
            
            // 현재 프레임을 템플릿으로 저장
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 150;
            tempCanvas.height = 100;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, 150, 100);
            
            const template = {
                id: Date.now(),
                image: tempCanvas.toDataURL(),
                histogram: calculateHistogram(ctx.getImageData(0, 0, canvas.width, canvas.height))
            };
            
            uiTemplates.push(template);
            updateTemplateGallery();
        }
        
        // 히스토그램 계산
        function calculateHistogram(imageData) {
            const histogram = new Array(256).fill(0);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.floor((data[i] + data[i+1] + data[i+2]) / 3);
                histogram[gray]++;
            }
            
            return histogram;
        }
        
        // 템플릿 갤러리 업데이트
        function updateTemplateGallery() {
            const gallery = document.getElementById('templateGallery');
            gallery.innerHTML = uiTemplates.map(template => `
                <div class="template-item" onclick="removeTemplate(${template.id})">
                    <img src="${template.image}" alt="UI Template">
                    <small>클릭하여 삭제</small>
                </div>
            `).join('');
        }
        
        // 템플릿 삭제
        function removeTemplate(id) {
            uiTemplates = uiTemplates.filter(t => t.id !== id);
            updateTemplateGallery();
        }
        
        // 템플릿 초기화
        function clearTemplates() {
            uiTemplates = [];
            updateTemplateGallery();
        }
    </script>
</body>
</html>