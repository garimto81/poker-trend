<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° íŒŸ ì‚¬ì´ì¦ˆ ë¶„ì„ê¸° - OCR ê¸°ë°˜ ìë™ ì¸ì‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-dark {
            background-color: #161b22 !important;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        .card:hover {
            border-color: #58a6ff;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.1);
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        .btn-success {
            background-color: #1f6feb;
            border-color: #1f6feb;
        }
        .btn-success:hover {
            background-color: #388bfd;
            border-color: #388bfd;
        }
        .form-control, .form-select {
            background-color: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .form-control:focus, .form-select:focus {
            background-color: #21262d;
            border-color: #58a6ff;
            color: #c9d1d9;
            box-shadow: 0 0 0 0.25rem rgba(88, 166, 255, 0.25);
        }
        #videoCanvas {
            max-width: 100%;
            border: 2px solid #30363d;
            border-radius: 6px;
            background-color: #000;
        }
        .roi-overlay {
            position: absolute;
            border: 2px dashed #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            pointer-events: none;
        }
        .roi-label {
            position: absolute;
            background-color: #ff6b6b;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 3px;
            top: -20px;
            left: 0;
        }
        .timeline-container {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            background-color: #0d1117;
        }
        .timeline-item {
            padding: 8px 12px;
            margin: 4px 0;
            background-color: #21262d;
            border-radius: 6px;
            border-left: 4px solid #238636;
        }
        .timeline-item:hover {
            background-color: #30363d;
            cursor: pointer;
        }
        .pot-change {
            border-left-color: #f85149 !important;
        }
        .pot-stable {
            border-left-color: #7c3aed !important;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #58a6ff;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #8b949e;
            margin-top: 5px;
        }
        .progress {
            height: 20px;
            background-color: #21262d;
        }
        .progress-bar {
            background-color: #238636;
        }
        .alert-custom {
            background-color: #1c2128;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">ğŸ’° íŒŸ ì‚¬ì´ì¦ˆ ë¶„ì„ê¸°</span>
            <div>
                <a href="../index.html" class="btn btn-outline-light btn-sm me-2">ë©”ì¸</a>
                <a href="gfx_overlay_trainer.html" class="btn btn-outline-light btn-sm">GFX í•™ìŠµê¸°</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div class="alert alert-custom mb-4">
            <h5>ğŸ¯ íŒŸ ì‚¬ì´ì¦ˆ ìë™ ì¸ì‹ ì‹œìŠ¤í…œ</h5>
            <p class="mb-0">
                í¬ì»¤ ì˜ìƒì—ì„œ íŒŸ ì‚¬ì´ì¦ˆë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì—¬ íƒ€ì„ë¼ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤. 
                OCR ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ í™”ë©´ì˜ íŒŸ í‘œì‹œ ì˜ì—­ì„ ë¶„ì„í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="row">
            <!-- ì™¼ìª½: ë¹„ë””ì˜¤ ë° ì»¨íŠ¸ë¡¤ -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“¹ ë¹„ë””ì˜¤ ë¶„ì„</h5>
                        
                        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-3">
                            <label class="form-label">ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ</label>
                            <input type="file" class="form-control" id="videoInput" 
                                   accept="video/*" onchange="handleVideoUpload(event)">
                        </div>
                        
                        <!-- ë¹„ë””ì˜¤ ìº”ë²„ìŠ¤ -->
                        <div class="position-relative mb-3">
                            <canvas id="videoCanvas" width="640" height="360"></canvas>
                            <!-- ROI ì˜¤ë²„ë ˆì´ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        
                        <!-- ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-secondary" id="playBtn" onclick="playVideo()" disabled>
                                        â–¶ï¸ ì¬ìƒ
                                    </button>
                                    <button class="btn btn-secondary" id="pauseBtn" onclick="pauseVideo()" disabled>
                                        â¸ï¸ ì¼ì‹œì •ì§€
                                    </button>
                                    <button class="btn btn-secondary" onclick="skipVideo(-10)" disabled id="skipBack">
                                        âª -10ì´ˆ
                                    </button>
                                    <button class="btn btn-secondary" onclick="skipVideo(10)" disabled id="skipForward">
                                        â© +10ì´ˆ
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" id="analyzeBtn" 
                                        onclick="startAnalysis()" disabled>
                                    ğŸ” íŒŸ ì‚¬ì´ì¦ˆ ë¶„ì„ ì‹œì‘
                                </button>
                            </div>
                        </div>
                        
                        <!-- íƒ€ì„ë¼ì¸ ìŠ¬ë¼ì´ë” -->
                        <div class="mb-3">
                            <label class="form-label">ì¬ìƒ ìœ„ì¹˜</label>
                            <input type="range" class="form-range" id="timelineSlider" 
                                   min="0" max="100" value="0" disabled
                                   oninput="seekVideo(this.value)">
                            <div class="d-flex justify-content-between small text-muted">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROI ì„¤ì • -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ¯ ROI ì˜ì—­ ì„¤ì •</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">ì˜ì—­ ì´ë¦„</label>
                                <select class="form-select" id="roiSelect" onchange="selectROI()">
                                    <option value="center">ì¤‘ì•™ íŒŸ (ê¸°ë³¸)</option>
                                    <option value="top">ìƒë‹¨ íŒŸ</option>
                                    <option value="bottom">í•˜ë‹¨ íŒŸ</option>
                                    <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">X</label>
                                <input type="number" class="form-control" id="roiX" value="300" 
                                       onchange="updateROI()" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Y</label>
                                <input type="number" class="form-control" id="roiY" value="200" 
                                       onchange="updateROI()" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ë„ˆë¹„</label>
                                <input type="number" class="form-control" id="roiWidth" value="200" 
                                       onchange="updateROI()" min="50">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ë†’ì´</label>
                                <input type="number" class="form-control" id="roiHeight" value="60" 
                                       onchange="updateROI()" min="30">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success btn-sm" onclick="testROI()">
                                ğŸ§ª í˜„ì¬ í”„ë ˆì„ OCR í…ŒìŠ¤íŠ¸
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="resetROI()">
                                ğŸ”„ ê¸°ë³¸ê°’ ë³µì›
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ ê²°ê³¼ -->
            <div class="col-lg-4">
                <!-- ë¶„ì„ ìƒíƒœ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“Š ë¶„ì„ ìƒíƒœ</h5>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>ì§„í–‰ë¥ </span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="small text-muted" id="analysisStatus">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ OCR ê²°ê³¼ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ‘ï¸ ì‹¤ì‹œê°„ OCR</h5>
                        <div class="mb-2">
                            <strong>ì¸ì‹ í…ìŠ¤íŠ¸:</strong>
                            <div id="ocrText" class="text-success">-</div>
                        </div>
                        <div class="mb-2">
                            <strong>íŒŸ ê°’:</strong>
                            <div id="potValue" class="text-warning">-</div>
                        </div>
                        <div>
                            <strong>ì‹ ë¢°ë„:</strong>
                            <div id="confidence" class="text-info">-</div>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“ˆ í†µê³„</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalReadings">0</div>
                                <div class="stat-label">ì´ ì½ê¸° ìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="validReadings">0</div>
                                <div class="stat-label">ìœ íš¨ ì¸ì‹</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="maxPot">$0</div>
                                <div class="stat-label">ìµœëŒ€ íŒŸ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avgConfidence">0%</div>
                                <div class="stat-label">í‰ê·  ì‹ ë¢°ë„</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ”§ ì‘ì—…</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="exportResults()" id="exportBtn" disabled>
                                ğŸ’¾ ê²°ê³¼ ë‚´ë³´ë‚´ê¸° (JSON)
                            </button>
                            <button class="btn btn-secondary" onclick="importResults()">
                                ğŸ“‚ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearResults()">
                                ğŸ—‘ï¸ ê²°ê³¼ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íŒŸ ì‚¬ì´ì¦ˆ íƒ€ì„ë¼ì¸ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">â±ï¸ íŒŸ ì‚¬ì´ì¦ˆ íƒ€ì„ë¼ì¸</h5>
                            <div class="btn-group btn-group-sm">
                                <input type="radio" class="btn-check" name="timelineFilter" id="filterAll" checked>
                                <label class="btn btn-outline-secondary" for="filterAll">ì „ì²´</label>
                                
                                <input type="radio" class="btn-check" name="timelineFilter" id="filterChanges">
                                <label class="btn btn-outline-warning" for="filterChanges">ë³€í™”ë§Œ</label>
                                
                                <input type="radio" class="btn-check" name="timelineFilter" id="filterHigh">
                                <label class="btn btn-outline-success" for="filterHigh">ê³ ì‹ ë¢°ë„ë§Œ</label>
                            </div>
                        </div>
                        <div class="timeline-container" id="timelineContainer">
                            <div class="text-muted text-center py-4">
                                ë¶„ì„ì„ ì‹œì‘í•˜ë©´ íŒŸ ì‚¬ì´ì¦ˆ íƒ€ì„ë¼ì¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let video = null;
        let canvas = null;
        let ctx = null;
        let isPlaying = false;
        let animationId = null;
        let analysisResults = [];
        let currentROI = { x: 300, y: 200, width: 200, height: 60 };
        let isAnalyzing = false;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            
            // ROI ì˜¤ë²„ë ˆì´ ìƒì„±
            createROIOverlay();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.querySelectorAll('input[name="timelineFilter"]').forEach(radio => {
                radio.addEventListener('change', updateTimelineDisplay);
            });
            
            console.log('íŒŸ ì‚¬ì´ì¦ˆ ë¶„ì„ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.addEventListener('loadedmetadata', () => {
                // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
                const aspectRatio = video.videoWidth / video.videoHeight;
                const maxWidth = 640;
                const maxHeight = 360;
                
                if (aspectRatio > maxWidth / maxHeight) {
                    canvas.width = maxWidth;
                    canvas.height = maxWidth / aspectRatio;
                } else {
                    canvas.height = maxHeight;
                    canvas.width = maxHeight * aspectRatio;
                }
                
                // ì»¨íŠ¸ë¡¤ í™œì„±í™”
                enableControls();
                
                // ì²« í”„ë ˆì„ ê·¸ë¦¬ê¸°
                drawFrame();
                
                // íƒ€ì„ë¼ì¸ ì„¤ì •
                document.getElementById('timelineSlider').max = video.duration;
                document.getElementById('totalTime').textContent = formatTime(video.duration);
            });
            
            video.addEventListener('timeupdate', updateTimeline);
        }

        // ì»¨íŠ¸ë¡¤ í™œì„±í™”
        function enableControls() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('skipBack').disabled = false;
            document.getElementById('skipForward').disabled = false;
            document.getElementById('timelineSlider').disabled = false;
            document.getElementById('analyzeBtn').disabled = false;
        }

        // í”„ë ˆì„ ê·¸ë¦¬ê¸°
        function drawFrame() {
            if (!video) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // í˜„ì¬ í”„ë ˆì„ì—ì„œ ì‹¤ì‹œê°„ OCR í…ŒìŠ¤íŠ¸
            if (!isAnalyzing) {
                testCurrentFrameOCR();
            }
        }

        // ë¹„ë””ì˜¤ ì¬ìƒ
        function playVideo() {
            if (!video) return;
            video.play();
            isPlaying = true;
            animate();
        }

        // ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€
        function pauseVideo() {
            if (!video) return;
            video.pause();
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        // ë¹„ë””ì˜¤ ìŠ¤í‚µ
        function skipVideo(seconds) {
            if (!video) return;
            video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
            drawFrame();
        }

        // ë¹„ë””ì˜¤ ì´ë™
        function seekVideo(value) {
            if (!video) return;
            video.currentTime = (value / 100) * video.duration;
            drawFrame();
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate() {
            if (isPlaying) {
                drawFrame();
                animationId = requestAnimationFrame(animate);
            }
        }

        // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        function updateTimeline() {
            if (!video) return;
            const progress = (video.currentTime / video.duration) * 100;
            document.getElementById('timelineSlider').value = progress;
            document.getElementById('currentTime').textContent = formatTime(video.currentTime);
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ROI ì˜¤ë²„ë ˆì´ ìƒì„±
        function createROIOverlay() {
            const container = canvas.parentElement;
            const overlay = document.createElement('div');
            overlay.className = 'roi-overlay';
            overlay.id = 'roiOverlay';
            
            const label = document.createElement('div');
            label.className = 'roi-label';
            label.textContent = 'POT ROI';
            overlay.appendChild(label);
            
            container.appendChild(overlay);
            updateROIOverlay();
        }

        // ROI ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
        function updateROIOverlay() {
            const overlay = document.getElementById('roiOverlay');
            if (!overlay) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;
            
            overlay.style.left = (rect.left - canvas.parentElement.getBoundingClientRect().left + currentROI.x * scaleX) + 'px';
            overlay.style.top = (rect.top - canvas.parentElement.getBoundingClientRect().top + currentROI.y * scaleY) + 'px';
            overlay.style.width = (currentROI.width * scaleX) + 'px';
            overlay.style.height = (currentROI.height * scaleY) + 'px';
        }

        // ROI ì„ íƒ
        function selectROI() {
            const select = document.getElementById('roiSelect');
            const presets = {
                center: { x: 300, y: 200, width: 200, height: 60 },
                top: { x: 300, y: 50, width: 200, height: 40 },
                bottom: { x: 300, y: 320, width: 200, height: 40 },
                custom: currentROI
            };
            
            if (presets[select.value]) {
                currentROI = { ...presets[select.value] };
                updateROIInputs();
                updateROIOverlay();
            }
        }

        // ROI ì…ë ¥ ì—…ë°ì´íŠ¸
        function updateROIInputs() {
            document.getElementById('roiX').value = currentROI.x;
            document.getElementById('roiY').value = currentROI.y;
            document.getElementById('roiWidth').value = currentROI.width;
            document.getElementById('roiHeight').value = currentROI.height;
        }

        // ROI ì—…ë°ì´íŠ¸
        function updateROI() {
            currentROI.x = parseInt(document.getElementById('roiX').value);
            currentROI.y = parseInt(document.getElementById('roiY').value);
            currentROI.width = parseInt(document.getElementById('roiWidth').value);
            currentROI.height = parseInt(document.getElementById('roiHeight').value);
            
            updateROIOverlay();
            
            // ì‚¬ìš©ì ì •ì˜ë¡œ ë³€ê²½
            document.getElementById('roiSelect').value = 'custom';
        }

        // ROI ë¦¬ì…‹
        function resetROI() {
            document.getElementById('roiSelect').value = 'center';
            selectROI();
        }

        // í˜„ì¬ í”„ë ˆì„ OCR í…ŒìŠ¤íŠ¸
        function testCurrentFrameOCR() {
            if (!video || !canvas) return;
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ OCR ê²°ê³¼ (ì‹¤ì œë¡œëŠ” ì„œë²„ API í˜¸ì¶œ)
            const mockResults = generateMockOCR();
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('ocrText').textContent = mockResults.text;
            document.getElementById('potValue').textContent = mockResults.value ? `$${mockResults.value.toLocaleString()}` : '-';
            document.getElementById('confidence').textContent = `${mockResults.confidence}%`;
        }

        // ROI í…ŒìŠ¤íŠ¸
        function testROI() {
            if (!video) {
                alert('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            testCurrentFrameOCR();
            alert(`ROI í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\nìœ„ì¹˜: (${currentROI.x}, ${currentROI.y})\ní¬ê¸°: ${currentROI.width} x ${currentROI.height}`);
        }

        // ëª¨ì˜ OCR ê²°ê³¼ ìƒì„±
        function generateMockOCR() {
            const timestamp = video ? video.currentTime : 0;
            const variations = [
                { text: "POT $1,234", value: 1234, confidence: 85 },
                { text: "$2,567", value: 2567, confidence: 92 },
                { text: "Total: $890", value: 890, confidence: 78 },
                { text: "3,456 BB", value: 3456, confidence: 88 },
                { text: "$5.2K", value: 5200, confidence: 95 }
            ];
            
            // ì‹œê°„ì— ë”°ë¼ ë‹¤ë¥¸ ê²°ê³¼ ë°˜í™˜
            const index = Math.floor(timestamp / 10) % variations.length;
            return variations[index];
        }

        // ë¶„ì„ ì‹œì‘
        async function startAnalysis() {
            if (!video) {
                alert('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (isAnalyzing) return;
            
            isAnalyzing = true;
            analysisResults = [];
            
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analysisStatus').textContent = 'ë¶„ì„ ì¤‘...';
            
            const totalFrames = Math.floor(video.duration);
            
            for (let i = 0; i < totalFrames; i += 2) { // 2ì´ˆë§ˆë‹¤ ë¶„ì„
                video.currentTime = i;
                await new Promise(resolve => {
                    video.addEventListener('seeked', resolve, { once: true });
                });
                
                drawFrame();
                
                // OCR ìˆ˜í–‰ (ëª¨ì˜)
                const result = generateMockOCR();
                if (result.value) {
                    analysisResults.push({
                        timestamp: i,
                        ...result
                    });
                }
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progress = (i / totalFrames) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // ë¶„ì„ ì™„ë£Œ
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('analysisStatus').textContent = `ë¶„ì„ ì™„ë£Œ - ${analysisResults.length}ê°œ ê²°ê³¼`;
            document.getElementById('exportBtn').disabled = false;
            
            updateStats();
            updateTimelineDisplay();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const validResults = analysisResults.filter(r => r.value > 0);
            
            document.getElementById('totalReadings').textContent = analysisResults.length;
            document.getElementById('validReadings').textContent = validResults.length;
            
            if (validResults.length > 0) {
                const maxPot = Math.max(...validResults.map(r => r.value));
                const avgConfidence = validResults.reduce((sum, r) => sum + r.confidence, 0) / validResults.length;
                
                document.getElementById('maxPot').textContent = `$${maxPot.toLocaleString()}`;
                document.getElementById('avgConfidence').textContent = `${Math.round(avgConfidence)}%`;
            }
        }

        // íƒ€ì„ë¼ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimelineDisplay() {
            const container = document.getElementById('timelineContainer');
            const filter = document.querySelector('input[name="timelineFilter"]:checked').id;
            
            let filteredResults = [...analysisResults];
            
            switch (filter) {
                case 'filterChanges':
                    filteredResults = detectPotChanges(filteredResults);
                    break;
                case 'filterHigh':
                    filteredResults = filteredResults.filter(r => r.confidence >= 80);
                    break;
            }
            
            if (filteredResults.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-4">í•„í„°ë§ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const html = filteredResults.map(result => {
                const changeClass = result.isChange ? 'pot-change' : '';
                return `
                    <div class="timeline-item ${changeClass}" onclick="jumpToTime(${result.timestamp})">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${formatTime(result.timestamp)}</strong>
                                <span class="text-muted ms-2">${result.text}</span>
                            </div>
                            <div>
                                <span class="text-warning">$${result.value.toLocaleString()}</span>
                                <small class="text-muted ms-2">(${result.confidence}%)</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // íŒŸ ë³€í™” ê°ì§€
        function detectPotChanges(results) {
            if (results.length < 2) return results;
            
            const changes = [results[0]];
            let prevValue = results[0].value;
            
            for (let i = 1; i < results.length; i++) {
                const current = results[i];
                if (Math.abs(current.value - prevValue) / prevValue > 0.1) { // 10% ì´ìƒ ë³€í™”
                    current.isChange = true;
                    changes.push(current);
                    prevValue = current.value;
                }
            }
            
            return changes;
        }

        // ì‹œê°„ìœ¼ë¡œ ì´ë™
        function jumpToTime(timestamp) {
            if (video) {
                video.currentTime = timestamp;
                drawFrame();
            }
        }

        // ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportResults() {
            if (analysisResults.length === 0) {
                alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const exportData = {
                type: 'pot_size_analysis',
                timestamp: new Date().toISOString(),
                video_duration: video.duration,
                roi_settings: currentROI,
                total_readings: analysisResults.length,
                results: analysisResults
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pot_analysis_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
        function importResults() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.type === 'pot_size_analysis') {
                            analysisResults = data.results || [];
                            currentROI = data.roi_settings || currentROI;
                            
                            updateStats();
                            updateTimelineDisplay();
                            updateROIInputs();
                            updateROIOverlay();
                            
                            document.getElementById('exportBtn').disabled = false;
                            alert(`${analysisResults.length}ê°œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                        } else {
                            alert('ì˜¬ë°”ë¥¸ ë¶„ì„ ê²°ê³¼ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        function clearResults() {
            if (confirm('ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                analysisResults = [];
                updateStats();
                updateTimelineDisplay();
                
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('analysisStatus').textContent = 'ëŒ€ê¸° ì¤‘...';
                document.getElementById('exportBtn').disabled = true;
            }
        }

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ROI ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
        window.addEventListener('resize', () => {
            setTimeout(updateROIOverlay, 100);
        });
    </script>
</body>
</html>