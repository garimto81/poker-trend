<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GFX ì˜¤ë²„ë ˆì´ í•™ìŠµê¸° - RFID Poker Graphics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        .btn-danger {
            background-color: #f85149;
            border-color: #f85149;
        }
        #videoCanvas, #snapshotCanvas {
            max-width: 100%;
            border: 2px solid #30363d;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .snapshot-item {
            position: relative;
            border: 2px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
        }
        .snapshot-item.gfx {
            border-color: #f85149;
        }
        .snapshot-item.game {
            border-color: #238636;
        }
        .snapshot-item img {
            width: 100%;
            height: auto;
        }
        .snapshot-label {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .snapshot-label.gfx {
            background-color: #f85149;
        }
        .snapshot-label.game {
            background-color: #238636;
        }
        .feature-display {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            font-family: monospace;
        }
        .progress {
            height: 25px;
            background-color: #0d1117;
        }
        .timeline-control {
            margin: 20px 0;
        }
        .btn-group-toggle .btn {
            background-color: #161b22;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .btn-group-toggle .btn.active {
            background-color: #238636;
            border-color: #238636;
        }
        .alert-warning {
            background-color: #bb8009;
            border-color: #bb8009;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">ğŸ° GFX ì˜¤ë²„ë ˆì´ êµ¬ê°„ ë¶„ì„ê¸°</span>
            <a href="../index.html" class="btn btn-outline-light btn-sm">ë©”ì¸ìœ¼ë¡œ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="alert alert-warning">
            <strong>êµ¬ê°„ ë¶„ì„ ë°©ë²•:</strong> ì˜ìƒì„ ì¬ìƒí•˜ë©´ì„œ GFX ì˜¤ë²„ë ˆì´ê°€ ë‚˜íƒ€ë‚˜ë©´ 'GFX ì˜¤ë²„ë ˆì´ ì¸ì‹' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘ì ì„ ë§ˆí‚¹í•˜ê³ , 
            GFXê°€ ì‚¬ë¼ì§€ë©´ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ì¢…ë£Œì ì„ ë§ˆí‚¹í•˜ì„¸ìš”. 
            ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì‹œì‘ì  -15ì´ˆ, ì¢…ë£Œì  +15ì´ˆë¡œ í•¸ë“œ êµ¬ê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ë¹„ë””ì˜¤ í•™ìŠµ</h5>
                        
                        <!-- ë¹„ë””ì˜¤ ì—…ë¡œë“œ -->
                        <div class="mb-3">
                            <input type="file" class="form-control" id="videoInput" accept="video/*">
                        </div>
                        
                        <!-- ë¹„ë””ì˜¤ ìº”ë²„ìŠ¤ -->
                        <canvas id="videoCanvas" width="800" height="450"></canvas>
                        
                        <!-- ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ -->
                        <div class="mt-3">
                            <div class="btn-toolbar" role="toolbar">
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-secondary" id="playBtn" disabled>
                                        <i class="bi bi-play-fill"></i> ì¬ìƒ
                                    </button>
                                    <button class="btn btn-secondary" id="pauseBtn" disabled>
                                        <i class="bi bi-pause-fill"></i> ì¼ì‹œì •ì§€
                                    </button>
                                </div>
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-secondary" id="skipBackBtn" disabled>
                                        <i class="bi bi-skip-backward-fill"></i> -5ì´ˆ
                                    </button>
                                    <button class="btn btn-secondary" id="skipForwardBtn" disabled>
                                        <i class="bi bi-skip-forward-fill"></i> +5ì´ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- íƒ€ì„ë¼ì¸ ìŠ¬ë¼ì´ë” -->
                        <div class="timeline-control">
                            <input type="range" class="form-range" id="timelineSlider" 
                                   min="0" max="100" value="0" disabled>
                            <div class="d-flex justify-content-between">
                                <small id="currentTime">0:00</small>
                                <small id="totalTime">0:00</small>
                            </div>
                        </div>
                        
                        <!-- ë§ˆí‚¹ ë²„íŠ¼ -->
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-danger btn-lg flex-fill" id="markGFXBtn" disabled>
                                ğŸ“º GFX ì˜¤ë²„ë ˆì´ ì¸ì‹ (í´ë¦­: ì‹œì‘ì  ë§ˆí‚¹)
                            </button>
                        </div>
                        
                        <!-- êµ¬ê°„ ì •ë³´ í‘œì‹œ -->
                        <div class="mt-3" id="segmentInfo" style="display: none;">
                            <div class="alert alert-info">
                                <strong>í˜„ì¬ êµ¬ê°„:</strong> 
                                <span id="segmentStatus">ëŒ€ê¸° ì¤‘</span><br>
                                <strong>ì‹œì‘ì :</strong> <span id="segmentStart">-</span><br>
                                <strong>ì¢…ë£Œì :</strong> <span id="segmentEnd">-</span><br>
                                <strong>í•¸ë“œ êµ¬ê°„:</strong> <span id="handSegment">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- í˜„ì¬ í”„ë ˆì„ íŠ¹ì§• -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">í˜„ì¬ í”„ë ˆì„ íŠ¹ì§•</h5>
                        <div class="feature-display">
                            <div>ìƒ‰ìƒ ê· ì¼ë„: <span id="colorUniformity">0.00</span></div>
                            <div>í…ìŠ¤íŠ¸ ë°€ë„: <span id="textDensity">0.00</span></div>
                            <div>ì—£ì§€ ë°€ë„: <span id="edgeDensity">0.00</span></div>
                            <div>ì •ì  ì ìˆ˜: <span id="staticScore">0.00</span></div>
                            <div class="mt-2">
                                <strong>ì˜ˆì¸¡: <span id="prediction">-</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- êµ¬ê°„ í†µê³„ -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">êµ¬ê°„ í†µê³„</h5>
                        <div class="stats-box">
                            <div class="d-flex justify-content-between mb-2">
                                <span>GFX êµ¬ê°„ ìˆ˜:</span>
                                <span id="gfxCount" class="text-danger">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>ì´ í•¸ë“œ ì‹œê°„:</span>
                                <span id="gameCount" class="text-success">0:00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>ì´ êµ¬ê°„:</span>
                                <span id="totalSamples">0 êµ¬ê°„</span>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar bg-danger" id="gfxProgress" style="width: 0%"></div>
                                <div class="progress-bar bg-success" id="gameProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- êµ¬ê°„ ê´€ë¦¬ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">êµ¬ê°„ ê´€ë¦¬</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="saveBtn" disabled>
                                ğŸ’¾ êµ¬ê°„ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON)
                            </button>
                            <button class="btn btn-secondary" id="loadBtn">
                                ğŸ“‚ êµ¬ê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                            <button class="btn btn-outline-danger" id="clearBtn">
                                ğŸ—‘ï¸ ëª¨ë“  êµ¬ê°„ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ë§ˆí‚¹ëœ êµ¬ê°„ ëª©ë¡ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ë§ˆí‚¹ëœ êµ¬ê°„ ëª©ë¡</h5>
                        <div class="snapshot-grid" id="snapshotGrid">
                            <!-- êµ¬ê°„ ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let video = null;
        let canvas = null;
        let ctx = null;
        let segments = [];  // êµ¬ê°„ ì •ë³´ ì €ì¥
        let currentSegment = null;  // í˜„ì¬ ë§ˆí‚¹ ì¤‘ì¸ êµ¬ê°„
        let isMarkingStart = true;  // true: ì‹œì‘ì  ë§ˆí‚¹, false: ì¢…ë£Œì  ë§ˆí‚¹
        let model = null;
        let isPlaying = false;
        let animationId = null;
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
            document.getElementById('playBtn').addEventListener('click', playVideo);
            document.getElementById('pauseBtn').addEventListener('click', pauseVideo);
            document.getElementById('skipBackBtn').addEventListener('click', () => skipVideo(-5));
            document.getElementById('skipForwardBtn').addEventListener('click', () => skipVideo(5));
            document.getElementById('timelineSlider').addEventListener('input', handleTimelineChange);
            
            document.getElementById('markGFXBtn').addEventListener('click', toggleGFXMarking);
            
            document.getElementById('saveBtn').addEventListener('click', saveModel);
            document.getElementById('loadBtn').addEventListener('click', loadModel);
            document.getElementById('clearBtn').addEventListener('click', clearSamples);
            
            // ì €ì¥ëœ ìƒ˜í”Œ ë¡œë“œ
            loadSamplesFromStorage();
        });
        
        // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.addEventListener('loadedmetadata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('playBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('skipBackBtn').disabled = false;
                document.getElementById('skipForwardBtn').disabled = false;
                document.getElementById('timelineSlider').disabled = false;
                document.getElementById('markGFXBtn').disabled = false;
                
                // íƒ€ì„ë¼ì¸ ì„¤ì •
                document.getElementById('timelineSlider').max = video.duration;
                document.getElementById('totalTime').textContent = formatTime(video.duration);
                
                // ì²« í”„ë ˆì„ í‘œì‹œ
                video.currentTime = 0;
                drawFrame();
            });
            
            video.addEventListener('timeupdate', updateTimeline);
        }
        
        // ë¹„ë””ì˜¤ ì¬ìƒ
        function playVideo() {
            if (!video) return;
            video.play();
            isPlaying = true;
            animate();
        }
        
        // ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€
        function pauseVideo() {
            if (!video) return;
            video.pause();
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }
        
        // ë¹„ë””ì˜¤ ìŠ¤í‚µ
        function skipVideo(seconds) {
            if (!video) return;
            video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
            drawFrame();
        }
        
        // íƒ€ì„ë¼ì¸ ë³€ê²½ ì²˜ë¦¬
        function handleTimelineChange(event) {
            if (!video) return;
            video.currentTime = parseFloat(event.target.value);
            drawFrame();
        }
        
        // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        function updateTimeline() {
            if (!video) return;
            document.getElementById('timelineSlider').value = video.currentTime;
            document.getElementById('currentTime').textContent = formatTime(video.currentTime);
        }
        
        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate() {
            if (isPlaying) {
                drawFrame();
                animationId = requestAnimationFrame(animate);
            }
        }
        
        // í”„ë ˆì„ ê·¸ë¦¬ê¸° ë° íŠ¹ì§• ë¶„ì„
        function drawFrame() {
            if (!video) return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            analyzeFrame();
        }
        
        // í”„ë ˆì„ ë¶„ì„
        function analyzeFrame() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const features = extractFeatures(imageData);
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('colorUniformity').textContent = features.colorUniformity.toFixed(2);
            document.getElementById('textDensity').textContent = features.textDensity.toFixed(2);
            document.getElementById('edgeDensity').textContent = features.edgeDensity.toFixed(2);
            document.getElementById('staticScore').textContent = features.staticScore.toFixed(2);
            
            // ì˜ˆì¸¡ (ëª¨ë¸ì´ ìˆëŠ” ê²½ìš°)
            if (model) {
                const prediction = predictFrame(features);
                document.getElementById('prediction').textContent = 
                    prediction > 0.5 ? 'GFX ì˜¤ë²„ë ˆì´' : 'ê²Œì„ í™”ë©´';
                document.getElementById('prediction').style.color = 
                    prediction > 0.5 ? '#f85149' : '#238636';
            }
        }
        
        // íŠ¹ì§• ì¶”ì¶œ
        function extractFeatures(imageData) {
            const data = imageData.data;
            
            // ìƒ‰ìƒ ê· ì¼ë„
            const colorUniformity = calculateColorUniformity(data);
            
            // í…ìŠ¤íŠ¸ ë°€ë„ (ì—£ì§€ ê¸°ë°˜ ì¶”ì •)
            const textDensity = estimateTextDensity(data, imageData.width, imageData.height);
            
            // ì—£ì§€ ë°€ë„
            const edgeDensity = calculateEdgeDensity(data, imageData.width, imageData.height);
            
            // ì •ì  ì ìˆ˜ (í”„ë ˆì„ ê°„ ì°¨ì´ë¡œ ì¶”ì •)
            const staticScore = 0.5; // ì‹¤ì œë¡œëŠ” ì´ì „ í”„ë ˆì„ê³¼ ë¹„êµ
            
            return {
                colorUniformity,
                textDensity,
                edgeDensity,
                staticScore,
                timestamp: video ? video.currentTime : 0
            };
        }
        
        // ìƒ‰ìƒ ê· ì¼ë„ ê³„ì‚°
        function calculateColorUniformity(data) {
            const colorMap = {};
            const sampleRate = 100;
            
            for (let i = 0; i < data.length; i += sampleRate * 4) {
                const r = Math.floor(data[i] / 32) * 32;
                const g = Math.floor(data[i + 1] / 32) * 32;
                const b = Math.floor(data[i + 2] / 32) * 32;
                const color = `${r},${g},${b}`;
                
                colorMap[color] = (colorMap[color] || 0) + 1;
            }
            
            const colors = Object.values(colorMap).sort((a, b) => b - a);
            const top5 = colors.slice(0, 5).reduce((a, b) => a + b, 0);
            const total = colors.reduce((a, b) => a + b, 0);
            
            return total > 0 ? top5 / total : 0;
        }
        
        // í…ìŠ¤íŠ¸ ë°€ë„ ì¶”ì •
        function estimateTextDensity(data, width, height) {
            let highContrastCount = 0;
            const threshold = 100;
            
            for (let y = 0; y < height - 1; y++) {
                for (let x = 0; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const idx_right = idx + 4;
                    const idx_down = idx + width * 4;
                    
                    // ìˆ˜í‰ ì—£ì§€
                    const diffH = Math.abs(data[idx] - data[idx_right]) +
                                  Math.abs(data[idx + 1] - data[idx_right + 1]) +
                                  Math.abs(data[idx + 2] - data[idx_right + 2]);
                    
                    // ìˆ˜ì§ ì—£ì§€
                    const diffV = Math.abs(data[idx] - data[idx_down]) +
                                  Math.abs(data[idx + 1] - data[idx_down + 1]) +
                                  Math.abs(data[idx + 2] - data[idx_down + 2]);
                    
                    if (diffH > threshold || diffV > threshold) {
                        highContrastCount++;
                    }
                }
            }
            
            return highContrastCount / (width * height);
        }
        
        // ì—£ì§€ ë°€ë„ ê³„ì‚°
        function calculateEdgeDensity(data, width, height) {
            let edgeCount = 0;
            const threshold = 50;
            
            for (let i = 0; i < data.length - 4; i += 4) {
                const diff = Math.abs(data[i] - data[i + 4]);
                if (diff > threshold) edgeCount++;
            }
            
            return edgeCount / (data.length / 4);
        }
        
        // GFX ë§ˆí‚¹ í† ê¸€
        function toggleGFXMarking() {
            if (!video) {
                alert('ë¹„ë””ì˜¤ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const btn = document.getElementById('markGFXBtn');
            const segmentInfo = document.getElementById('segmentInfo');
            
            if (isMarkingStart) {
                // ì‹œì‘ì  ë§ˆí‚¹
                currentSegment = {
                    gfxStart: video.currentTime,
                    gfxEnd: null,
                    handStart: null,
                    handEnd: null,
                    id: Date.now()
                };
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                btn.textContent = 'ğŸ“º GFX ì˜¤ë²„ë ˆì´ ì¸ì‹ (í´ë¦­: ì¢…ë£Œì  ë§ˆí‚¹)';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-warning');
                
                // êµ¬ê°„ ì •ë³´ í‘œì‹œ
                segmentInfo.style.display = 'block';
                document.getElementById('segmentStatus').textContent = 'GFX êµ¬ê°„ ë§ˆí‚¹ ì¤‘...';
                document.getElementById('segmentStart').textContent = formatTime(currentSegment.gfxStart);
                document.getElementById('segmentEnd').textContent = 'ëŒ€ê¸° ì¤‘...';
                
                isMarkingStart = false;
                
            } else {
                // ì¢…ë£Œì  ë§ˆí‚¹
                if (!currentSegment) return;
                
                currentSegment.gfxEnd = video.currentTime;
                
                // 15ì´ˆ ê·œì¹™ ì ìš©í•˜ì—¬ í•¸ë“œ êµ¬ê°„ ê³„ì‚°
                currentSegment.handStart = Math.max(0, currentSegment.gfxStart - 15);
                currentSegment.handEnd = Math.min(video.duration || 3600, currentSegment.gfxEnd + 15);
                
                // êµ¬ê°„ ì €ì¥
                segments.push(currentSegment);
                console.log('êµ¬ê°„ ì €ì¥ë¨:', currentSegment);
                console.log('ì „ì²´ êµ¬ê°„ ìˆ˜:', segments.length);
                
                // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                btn.textContent = 'ğŸ“º GFX ì˜¤ë²„ë ˆì´ ì¸ì‹ (í´ë¦­: ì‹œì‘ì  ë§ˆí‚¹)';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
                
                // êµ¬ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
                document.getElementById('segmentStatus').textContent = 'êµ¬ê°„ ì €ì¥ ì™„ë£Œ!';
                document.getElementById('segmentEnd').textContent = formatTime(currentSegment.gfxEnd);
                document.getElementById('handSegment').textContent = 
                    `${formatTime(currentSegment.handStart)} ~ ${formatTime(currentSegment.handEnd)}`;
                
                // ì‹œê°ì  í”¼ë“œë°±
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                    updateSegmentDisplay();
                    saveSegmentsToStorage();
                }, 100);
                
                currentSegment = null;
                isMarkingStart = true;
            }
        }
        
        // êµ¬ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSegmentDisplay() {
            console.log('updateSegmentDisplay í˜¸ì¶œë¨, segments:', segments);
            const grid = document.getElementById('snapshotGrid');
            grid.innerHTML = '';
            
            segments.forEach((segment, index) => {
                console.log(`êµ¬ê°„ ${index}:`, segment);
                const item = document.createElement('div');
                item.className = 'card mb-2';
                item.style.backgroundColor = '#161b22';
                item.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title text-danger">êµ¬ê°„ ${index + 1}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">GFX ì˜¤ë²„ë ˆì´ êµ¬ê°„:</small><br>
                                <span class="text-warning">${formatTime(segment.gfxStart)} ~ ${formatTime(segment.gfxEnd)}</span>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">í•¸ë“œ êµ¬ê°„ (Â±15ì´ˆ):</small><br>
                                <span class="text-success">${formatTime(segment.handStart)} ~ ${formatTime(segment.handEnd)}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">ê¸¸ì´: ${formatTime(segment.handEnd - segment.handStart)}</small>
                            <button class="btn btn-sm btn-danger float-end" onclick="removeSegment('${segment.id}')">
                                ì‚­ì œ
                            </button>
                            <button class="btn btn-sm btn-info float-end me-2" onclick="jumpToSegment(${segment.gfxStart})">
                                ì´ë™
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(item);
            });
            
            updateStats();
        }
        
        // êµ¬ê°„ ì œê±°
        function removeSegment(id) {
            segments = segments.filter(s => s.id != id);
            updateSegmentDisplay();
            saveSegmentsToStorage();
        }
        
        // êµ¬ê°„ìœ¼ë¡œ ì´ë™
        function jumpToSegment(time) {
            if (video) {
                video.currentTime = time;
                drawFrame();
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const totalSegments = segments.length;
            let totalGFXTime = 0;
            let totalHandTime = 0;
            
            segments.forEach(segment => {
                totalGFXTime += (segment.gfxEnd - segment.gfxStart);
                totalHandTime += (segment.handEnd - segment.handStart);
            });
            
            document.getElementById('gfxCount').textContent = totalSegments;
            document.getElementById('gameCount').textContent = formatTime(totalHandTime);
            document.getElementById('totalSamples').textContent = totalSegments + ' êµ¬ê°„';
            
            if (video && video.duration > 0) {
                const gfxPercent = (totalGFXTime / video.duration) * 100;
                const handPercent = (totalHandTime / video.duration) * 100;
                document.getElementById('gfxProgress').style.width = `${Math.min(gfxPercent, 100)}%`;
                document.getElementById('gameProgress').style.width = `${Math.min(handPercent, 100)}%`;
            } else {
                document.getElementById('gfxProgress').style.width = '0%';
                document.getElementById('gameProgress').style.width = '0%';
            }
            
            // ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í™œì„±í™”
            if (totalSegments > 0) {
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        
        // í‰ê·  íŠ¹ì§• ê³„ì‚°
        function calculateAverageFeatures(samples) {
            if (samples.length === 0) return null;
            
            const sum = samples.reduce((acc, sample) => {
                acc.colorUniformity += sample.features.colorUniformity;
                acc.textDensity += sample.features.textDensity;
                acc.edgeDensity += sample.features.edgeDensity;
                acc.staticScore += sample.features.staticScore;
                return acc;
            }, { colorUniformity: 0, textDensity: 0, edgeDensity: 0, staticScore: 0 });
            
            const count = samples.length;
            return {
                colorUniformity: sum.colorUniformity / count,
                textDensity: sum.textDensity / count,
                edgeDensity: sum.edgeDensity / count,
                staticScore: sum.staticScore / count
            };
        }
        
        // í”„ë ˆì„ ì˜ˆì¸¡
        function predictFrame(features) {
            if (!model) return 0.5;
            
            // ê°„ë‹¨í•œ ìœ ì‚¬ë„ ê¸°ë°˜ ì˜ˆì¸¡
            let maxSimilarity = 0;
            
            for (const pattern of model.patterns) {
                const similarity = calculateSimilarity(features, pattern);
                maxSimilarity = Math.max(maxSimilarity, similarity);
            }
            
            return maxSimilarity;
        }
        
        // ìœ ì‚¬ë„ ê³„ì‚°
        function calculateSimilarity(f1, f2) {
            const colorDiff = Math.abs(f1.colorUniformity - f2.colorUniformity);
            const textDiff = Math.abs(f1.textDensity - f2.textDensity);
            const edgeDiff = Math.abs(f1.edgeDensity - f2.edgeDensity);
            
            // ì—­ ê±°ë¦¬ (ê°€ê¹Œìš¸ìˆ˜ë¡ 1ì— ê°€ê¹Œì›€)
            const avgDiff = (colorDiff + textDiff + edgeDiff) / 3;
            return 1 - Math.min(avgDiff, 1);
        }
        
        // êµ¬ê°„ ë°ì´í„° ì €ì¥
        function saveModel() {
            if (segments.length === 0) {
                alert('ì €ì¥í•  êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // JSON í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
            const exportData = {
                version: '2.0',
                type: 'segment-analysis',
                segments: segments.map(s => ({
                    gfxStart: s.gfxStart,
                    gfxEnd: s.gfxEnd,
                    handStart: s.handStart,
                    handEnd: s.handEnd,
                    duration: s.handEnd - s.handStart
                })),
                totalSegments: segments.length,
                videoInfo: {
                    duration: video ? video.duration : 0,
                    filename: document.getElementById('videoInput').files[0]?.name || 'unknown'
                },
                createdAt: new Date().toISOString()
            };
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gfx_segments_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`${segments.length}ê°œ êµ¬ê°„ì´ JSON íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }
        
        // êµ¬ê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadModel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.segments && Array.isArray(data.segments)) {
                            segments = data.segments.map(s => ({
                                ...s,
                                id: Date.now() + Math.random()
                            }));
                            updateSegmentDisplay();
                            saveSegmentsToStorage();
                            alert(`${segments.length}ê°œ êµ¬ê°„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
                        } else {
                            alert('ìœ íš¨í•œ êµ¬ê°„ ë°ì´í„°ê°€ ì•„ë‹™ë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // êµ¬ê°„ ì´ˆê¸°í™”
        function clearSamples() {
            if (confirm('ëª¨ë“  êµ¬ê°„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                segments = [];
                updateSegmentDisplay();
                saveSegmentsToStorage();
                document.getElementById('saveBtn').disabled = true;
                
                // í˜„ì¬ ë§ˆí‚¹ ì¤‘ì¸ êµ¬ê°„ë„ ì´ˆê¸°í™”
                if (currentSegment) {
                    currentSegment = null;
                    isMarkingStart = true;
                    const btn = document.getElementById('markGFXBtn');
                    btn.textContent = 'ğŸ“º GFX ì˜¤ë²„ë ˆì´ ì¸ì‹ (í´ë¦­: ì‹œì‘ì  ë§ˆí‚¹)';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-danger');
                    document.getElementById('segmentInfo').style.display = 'none';
                }
            }
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— êµ¬ê°„ ì €ì¥
        function saveSegmentsToStorage() {
            localStorage.setItem('gfxSegments', JSON.stringify(segments));
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ êµ¬ê°„ ë¡œë“œ
        function loadSamplesFromStorage() {
            const saved = localStorage.getItem('gfxSegments');
            if (saved) {
                try {
                    segments = JSON.parse(saved);
                    if (segments.length > 0) {
                        updateSegmentDisplay();
                        document.getElementById('saveBtn').disabled = false;
                    }
                } catch (error) {
                    segments = [];
                }
            }
        }
        
        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            // null, undefined, NaN ì²˜ë¦¬
            if (seconds == null || isNaN(seconds) || seconds < 0) {
                return '0:00';
            }
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>