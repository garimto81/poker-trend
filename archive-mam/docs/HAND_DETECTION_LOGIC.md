# 🎯 포커 핸드 감지 로직 상세 설계서

## 📊 현재 구현된 핸드 감지 시스템 분석

### 1. 핸드 감지의 핵심 구조

```
[영상 입력] → [프레임 분석] → [이벤트 감지] → [핸드 경계 결정] → [검증 및 출력]
```

---

## 🔍 핸드 시작점 감지 로직

### 감지 원리: 다층 신뢰도 스코어링 시스템

```
총 점수 = 카드 출현(35점) + 딜링 모션(40점) + 시간 패턴(15점) + 활동 증가(10점)
임계값: 75점 이상 → 핸드 시작으로 판정
```

### 1️⃣ **새로운 카드 출현 감지** (35점)
```
현재 로직:
- 이전 5프레임의 평균 카드 수 계산
- 현재 프레임에서 2장 이상 증가 시 감지
- 카드 감지: 흰색 영역(HSV) + 사각형 형태 + 종횡비 1.2~1.8

문제점:
- 카드가 겹쳐있으면 개수 정확도 떨어짐
- 테이블 위 다른 흰색 물체 오인식
```

### 2️⃣ **딜링 모션 패턴 감지** (40점)
```
현재 로직:
- 테이블 중앙에서 시작하는 모션 감지
- 중앙 → 가장자리로 방사형 움직임 추적
- 연속 3프레임 이상 패턴 지속 시 인정

문제점:
- 딜러의 손 움직임만 추적 어려움
- 칩 정리 등 다른 모션과 혼동
```

### 3️⃣ **시간적 패턴 분석** (15점)
```
현재 로직:
- 이전 핸드 종료 후 경과 시간 측정
- 30초~2분: 15점 (정상적인 간격)
- 20초~30초: 8점 (약간 빠름)
- 20초 미만: 0점 (너무 빠름)

문제점:
- 토너먼트 단계별 속도 차이 미반영
- 브레이크 타임 고려 안됨
```

### 4️⃣ **모션 활동 증가** (10점)
```
현재 로직:
- 전체 화면의 움직임 픽셀 수 계산
- 2000픽셀 이상 움직임 시 점수 부여

문제점:
- 관중이나 카메라 움직임 영향
- 절대값 기준으로 화면 크기 영향
```

---

## 🏁 핸드 종료점 감지 로직

### 감지 원리: 팟 수집 중심 판정

```
총 점수 = 팟 수집 모션(50점) + 칩 사라짐(30점) + 활동 감소(20점)
임계값: 80점 이상 → 핸드 종료로 판정
```

### 1️⃣ **팟 수집 모션 감지** (50점)
```
현재 로직:
- 중앙에서 한 방향으로 일관된 움직임
- 옵티컬 플로우로 방향 일관성 검사
- 연속 2프레임 이상 감지

문제점:
- 스플릿 팟 상황 처리 불가
- 올인 상황 구별 어려움
```

### 2️⃣ **중앙 칩 사라짐** (30점)
```
현재 로직:
- 테이블 중앙 영역의 칩 개수 추적
- 칩이 0개가 되면 점수 부여

문제점:
- 칩 색상별 구분 정확도
- 조명 변화에 민감
```

### 3️⃣ **모션 활동 급감** (20점)
```
현재 로직:
- 이전 프레임 대비 모션 영역 50% 이하로 감소
- 전체 모션 영역 500픽셀 미만

문제점:
- 정적인 상황(씽킹 타임) 오인식
```

---

## 🎮 핸드 구별의 핵심 이슈

### 현재 시스템의 한계점

1. **단순 이진 판정**
   - 시작/종료만 감지, 중간 상태 없음
   - 핸드 내 주요 이벤트 추적 불가

2. **고정된 가중치**
   - 모든 상황에 동일한 점수 체계
   - 게임 단계별 특성 미반영

3. **단일 프레임 의존**
   - 시간적 연속성 부족
   - 노이즈에 취약

4. **컨텍스트 미고려**
   - 블라인드 레벨, 플레이어 수 등 무시
   - 방송사별 UI 차이 대응 불가

---

## 🛠️ 개선 가능한 방향

### A. 상태 기반 추적 시스템
```
[대기] → [딜링 중] → [프리플랍] → [플랍] → [턴] → [리버] → [쇼다운] → [팟 수집]
```

### B. 적응형 가중치 시스템
- 게임 초반/중반/후반 다른 가중치
- 플레이어 수에 따른 조정
- 이전 핸드 패턴 학습

### C. 멀티모달 감지
- 오디오 신호 활용 (칩 소리, 딜러 음성)
- OCR로 블라인드/팟 정보 추출
- 플레이어 위치별 개별 추적

### D. 신뢰도 기반 결정
- 확률적 판정 (70% 확신도 등)
- 후처리로 오탐지 수정
- 사용자 피드백 학습

---

## 💡 디테일 조정 포인트

귀하께서 조정하실 수 있는 주요 결정 사항:

1. **핸드의 정의**
   - 카드 딜링부터? 첫 액션부터?
   - 팟 수집 완료? 다음 핸드 준비?

2. **특수 상황 처리**
   - 올인 상황의 긴 딜레이
   - 스플릿 팟
   - 초핑(Chop) 상황

3. **방송 특성 대응**
   - 리플레이 구간 처리
   - 광고/인터뷰 삽입
   - 멀티 테이블 전환

4. **정확도 vs 속도**
   - 실시간 처리 필요?
   - 후처리 허용 범위?

이 구조를 보시고 어떤 부분을 어떻게 개선하고 싶으신지 말씀해 주시면, 구체적인 구현 방안을 제시하겠습니다.